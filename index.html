<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Riego - CUSSHMI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0070c0 0%, #005a9c 100%);
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .header-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .header-text {
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header h2 {
            font-size: 18px;
            font-weight: 300;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            min-height: 600px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #dee2e6;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group select,
        .form-group input[type="number"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #0070c0;
            box-shadow: 0 0 0 3px rgba(0,112,192,0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0070c0 0%, #005a9c 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,112,192,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .content-area {
            padding: 30px;
            overflow-y: auto;
            overflow-x: auto;
            max-height: 800px;
        }

        .welcome-screen {
            text-align: center;
            padding: 80px 20px;
        }

        .welcome-screen h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .welcome-screen p {
            color: #666;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .welcome-icon {
            font-size: 100px;
            margin-bottom: 30px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        .report-table thead {
            background: #0070c0;
            color: white;
        }

        .report-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .report-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .report-table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0070c0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .totals-row {
            background: #fff3cd !important;
            font-weight: bold;
        }

        .excluded-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .file-upload-area:hover {
            border-color: #0070c0;
            background: #f8f9fa;
        }

        .file-upload-area.dragover {
            border-color: #0070c0;
            background: #e7f3ff;
        }

        #exportButtons {
            display: none;
            margin-top: 20px;
            gap: 10px;
        }

        #exportButtons.show {
            display: flex;
        }

        .btn-export {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-export-excel {
            background: #217346;
            color: white;
        }

        .btn-export-excel:hover {
            background: #1a5c38;
        }

        .btn-export-pdf {
            background: #dc3545;
            color: white;
        }

        .btn-export-pdf:hover {
            background: #c82333;
        }

        .btn-export-csv {
            background: #17a2b8;
            color: white;
        }

        .btn-export-csv:hover {
            background: #138496;
        }

        .panel-no-aptos {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .panel-no-aptos h3 {
            color: #0070c0;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #0070c0;
            padding-bottom: 8px;
        }

        .panel-programados {
            margin-top: 20px;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            background: #d4edda;
        }

        .panel-programados h3 {
            color: #155724;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 8px;
        }

        .avance-siembra {
            table-layout: auto;
            width: 100%;
            min-width: 1000px;
        }

        .avance-siembra th {
            text-align: center !important;
            vertical-align: middle !important;
            padding: 6px 4px !important;
        }

        .avance-siembra td {
            text-align: center;
            vertical-align: middle;
        }

        .avance-siembra input {
            width: 100%;
            max-width: 70px;
            padding: 2px;
            font-size: 11px;
            text-align: center;
            box-sizing: border-box;
        }

        .avance-siembra th:nth-child(7),
        .avance-siembra th:nth-child(8),
        .avance-siembra th:nth-child(9),
        .avance-siembra td:nth-child(7),
        .avance-siembra td:nth-child(8),
        .avance-siembra td:nth-child(9) {
            width: 80px !important;
        }

        /* MODAL PARA SELECCION DE SEMANA PDA - CORREGIDO */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Por defecto oculto */
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex !important; /* Fuerza mostrar cuando tiene clase active */
        }

        .modal-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .modal-container h3 {
            color: #0070c0;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .modal-container .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .modal-container label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .modal-container input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-container .info-text {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #1565c0;
            text-align: left;
        }

        .modal-container .btn {
            margin-top: 10px;
        }

        .modal-container .error-msg {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        @media print {
    @page {
        size: landscape;
        margin: 3mm 2mm 3mm 2mm; /* M√°rgenes m√≠nimos: arriba, derecha, abajo, izquierda */
    }

    body {
        background: white !important;
        margin: 0;
        padding: 0;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .sidebar, .btn, #exportButtons, .welcome-screen, 
    .header, .main-content, .container {
        display: none !important;
    }

    /* CONTENEDOR DE IMPRESI√ìN ESPECIAL */
    #printContainer {
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
    }

    /* CADA SECCI√ìN EN HOJA NUEVA */
    .hoja-print {
        page-break-after: always !important;
        width: 100% !important;
        height: 100% !important;
        padding: 10mm !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
    }

    .hoja-print:last-child {
        page-break-after: auto !important;
    }

    /* ESCALADO AUTOM√ÅTICO PARA QUE QUEPA */
    .hoja-print .contenido-escalable {
        transform-origin: top left !important;
        width: 100% !important;
    }

    /* TABLAS COMPACTAS */
    .report-table {
        width: 100% !important;
        table-layout: fixed !important;
        font-size: 7pt !important;
        border-collapse: collapse !important;
        margin: 0 !important;
    }

    .report-table th,
    .report-table td {
        padding: 2px 3px !important;
        border: 0.5px solid #333 !important;
        word-wrap: break-word !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        max-width: 150px !important;
    }

    .report-table th {
        background-color: #667eea !important;
        color: white !important;
        font-size: 6.5pt !important;
        font-weight: bold !important;
    }

    /* MATRIZ DE CULTIVOS: TAMA√ëO AUMENTADO Y AJUSTE DE TEXTO */
    .tabla-matriz {
        font-size: 8pt !important;
        table-layout: fixed !important;
        width: 100% !important;
    }

    .tabla-matriz th,
    .tabla-matriz td {
        padding: 2px 2px !important;
        font-size: 7.5pt !important;
        max-width: 45px !important;
        min-width: 40px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }

    .tabla-matriz td:first-child,
    .tabla-matriz th:first-child {
        max-width: 55px !important;
        min-width: 50px !important;
        font-size: 7.5pt !important;
        font-weight: bold !important;
    }

    /* √öLTIMA COLUMNA (TOTAL) - FONDO VERDE CLARO, TEXTO NEGRO */
    .tabla-matriz th:last-child,
    .tabla-matriz td:last-child {
        max-width: 50px !important;
        min-width: 45px !important;
        background-color: #90EE90 !important; /* Verde m√°s oscuro */
        color: #000000 !important; /* TEXTO NEGRO */
        font-weight: bold !important;
        font-size: 8pt !important;
    }

    /* ENCABEZADO DE HOJA COMPACTO */
    .encabezado-hoja {
        text-align: center !important;
        margin-bottom: 4px !important;
        border-bottom: 0.5px solid #333 !important;
        padding-bottom: 3px !important;
        line-height: 1.2 !important;
    }

    .encabezado-hoja h2 {
        font-size: 9pt !important;
        margin: 0 0 2px 0 !important;
        color: #0070c0 !important;
    }

    .encabezado-hoja p {
        font-size: 6.5pt !important;
        margin: 1px 0 !important;
        color: #333 !important;
        line-height: 1.1 !important;
    }

    /* TARJETAS DE ESTAD√çSTICAS ULTRA-COMPACTAS */
    .stats-print {
        display: flex !important;
        justify-content: space-between !important;
        margin-bottom: 5px !important;
        gap: 3px !important;
    }

    .stat-box {
        flex: 1 !important;
        text-align: center !important;
        padding: 2px 3px !important;
        border: 0.5px solid #333 !important;
        background: #f8f9fa !important;
        line-height: 1.1 !important;
    }

    .stat-box h4 {
        font-size: 8pt !important;
        margin: 0 !important;
        color: #0070c0 !important;
        line-height: 1.2 !important;
    }

    .stat-box p {
        font-size: 5.5pt !important;
        margin: 0 !important;
        color: #333 !important;
        line-height: 1.1 !important;
    }

    /* EVITAR SALTOS DE P√ÅGINA DENTRO DE TABLAS */
    .report-table tbody tr {
        page-break-inside: avoid !important;
    }

    /* COLORES EN IMPRESI√ìN */
    .fila-totales-print {
        background-color: #228B22 !important;
        color: #000000 !important; /* TEXTO NEGRO */
        font-weight: bold !important;
        font-size: 8pt !important;
    }

    .celda-positiva {
        color: #155724 !important;
        font-weight: 600 !important;
    }

    .celda-cero {
        color: #999 !important;
        text-align: center !important;
    }
}

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
            .avance-siembra th small {
                font-size: 11px;
                display: block;
                margin-top: 2px;
                font-weight: normal;
            }
.avance-siembra th small {
            font-size: 11px;
            display: block;
            margin-top: 2px;
            font-weight: normal;
        }

        /* Estilos para matrices de cultivos */
        .report-table th {
            position: relative;
        }

        .report-table td {
            transition: background-color 0.2s;
        }

        .report-table tbody tr:hover td {
            background-color: #e3f2fd !important;
        }

        .report-table tbody tr:hover td:first-child {
            background-color: #bbdefb !important;
        }
.fila-sumatoria-toma {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            font-weight: bold !important;
        }
        
        .fila-sumatoria-toma td {
            border-top: 2px solid white !important;
            border-bottom: 2px solid white !important;
        }
        }
       #btnAccederConsolidado {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    margin-top: 10px;
}

#btnAccederConsolidado:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
} 
.area-semana[readonly] {
    cursor: not-allowed;
    border: 1px solid #dee2e6;
}

.area-semana[readonly]:focus {
    outline: none;
    border-color: #dee2e6;
    box-shadow: none;
}

/* Estilo cuando tiene usuarios programados (√°rea aumentada) */
.area-semana.programado {
    background-color: #e3f2fd !important;
    color: #0070c0 !important;
    font-weight: bold !important;
}
@media print {
    #tablaConsolidadoDemandas {
        width: 100% !important;
        font-size: 9px !important;
    }
    
    #tablaConsolidadoDemandas th,
    #tablaConsolidadoDemandas td {
        padding: 4px !important;
        border: 1px solid #333 !important;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-text">
                <h1>üåä COMISI√ìN DE USUARIOS DEL SUB SECTOR HIDR√ÅULICO MARGEN IZQUIERDA</h1>
                <h2>Unidad de Operaci√≥n y Tarifas de la CUSSHMI</h2>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="form-group">
                    <label for="fileUpload">üìÅ Cargar Archivo Excel (TOMAS.xlsx)</label>
                    <div class="file-upload-area" id="dropArea">
                        <p>üìÇ Arrastra tu archivo aqu√≠<br>o haz clic para seleccionar</p>
                        <input type="file" id="fileUpload" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="tomaSelect">üö∞ Seleccionar Toma</label>
                    <select id="tomaSelect">
                        <option value="">-- Primero carga el archivo --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipoReporte">üìä Tipo de Reporte</label>
                    <select id="tipoReporte">
                        <option value="aptos">Usuarios con Derecho de Uso de Riego</option>
                        <option value="noAptos">Usuarios sin Derecho de Uso de Riego (con Deuda)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cultivoFiltro">üå± Filtrar por Cultivo</label>
                    <select id="cultivoFiltro">
                        <option value="TODOS">-- Todos los cultivos --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="deudaMinima">üí∞ Deuda M√≠nima Permitida (S/)</label>
                    <input type="number" id="deudaMinima" value="0" min="0" step="0.01" placeholder="0.00">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Usuarios con deuda ‚â§ este monto ser√°n considerados aptos
                    </small>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="incluirGraficos" checked>
                    <label for="incluirGraficos">üìà Incluir gr√°ficos</label>
                </div>

                <button class="btn btn-primary" id="btnGenerar" disabled>
                    üîç Generar Reporte
                </button>

                <button class="btn btn-success" id="btnConsolidado" disabled>
                    üìë Reporte Consolidado
                </button>
                <button class="btn btn-primary" id="btnAvanceSiembra" disabled>
                    üå± Avance de Siembra por Toma
                </button>

                <button class="btn btn-secondary" id="btnLimpiar">
                    üîÑ Limpiar Datos
                </button>
<button class="btn btn-success" id="btnAccederConsolidado" onclick="mostrarConsolidadoDemandas()" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
    üìä Acceder a Consolidado por Grupo
</button>

                <div id="exportButtons">
                    <button class="btn-export btn-export-excel" id="btnExportExcel">
                        üìä Excel
                    </button>
                    <button class="btn-export btn-export-csv" id="btnExportCSV">
                        üìÑ CSV
                    </button>
                    <button class="btn-export btn-export-pdf" id="btnPrint">
                        üñ®Ô∏è Imprimir
                    </button>
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <div class="welcome-screen">
                    <div class="welcome-icon">üíß</div>
                    <h2>Bienvenido al Sistema de Gesti√≥n de Riego</h2>
                    <p>Carga tu archivo Excel TOMAS.xlsx para comenzar a generar reportes<br>
                    de usuarios con derecho de uso de agua para riego.</p>
                    
                    <div class="alert alert-info" style="text-align: left; max-width: 600px; margin: 30px auto;">
                        <strong>üìå Instrucciones:</strong><br>
                        1. Arrastra o selecciona tu archivo TOMAS.xlsx<br>
                        2. Elige la toma que deseas analizar<br>
                        3. Configura el tipo de reporte y deuda m√≠nima<br>
                        4. Haz clic en "Generar Reporte"
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- MODAL PARA CONFIRMACI√ìN AUTOM√ÅTICA DE SEMANA PDA -->
    <div id="modalSemanaPDA" class="modal-overlay">
        <div class="modal-container" style="text-align: center; padding: 30px;">
            <h3>üìÖ SEMANA DE EVALUACI√ìN</h3>
            
            <div class="form-group" style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 25px 0; text-align: center; border: 2px solid #4caf50;">
                <label style="font-size: 16px; color: #2e7d32; margin-bottom: 15px; display: block;">
                    üìä SEMANA A EVALUAR:
                </label>
                <div id="displaySemanaEvaluar" style="font-size: 22px; font-weight: bold; color: #0070c0; margin-bottom: 8px;">
                    <!-- Se llenar√° autom√°ticamente -->
                </div>
                <div id="displayRangoFechas" style="font-size: 14px; color: #666; font-weight: 600;">
                    <!-- Se llenar√° autom√°ticamente -->
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="confirmarSemanaAutomatica()" style="width: 80%;">
                ‚úÖ Confirmar y Continuar
            </button>
            
            <button class="btn btn-secondary" onclick="cerrarModalSemana()" style="margin-top: 10px; width: 80%;">
                ‚ùå Cancelar
            </button>
        </div>
    </div>

    <!-- Librer√≠a para leer Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Librer√≠a para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Variables globales
        let workbook = null;
        let tomasData = {};
        let currentChart = null;
        let usuariosSeleccionados = [];
        let usuariosProgramados = []; // Array para usuarios programados
        let semanaPDA = {
            fechaInicio: null,
            fechaFin: null
        };
        let tomaPendiente = null;
	let consolidadoDemandas = []; // NUEVO: Array para guardar todas las tomas
	let datosAnexoG2 = []; // NUEVO: Array para datos del Anexo G2

        // Referencias a elementos
        const fileUpload = document.getElementById('fileUpload');
        const dropArea = document.getElementById('dropArea');
        const tomaSelect = document.getElementById('tomaSelect');
        const tipoReporte = document.getElementById('tipoReporte');
        const cultivoFiltro = document.getElementById('cultivoFiltro');
        const deudaMinima = document.getElementById('deudaMinima');
        const incluirGraficos = document.getElementById('incluirGraficos');
        const btnGenerar = document.getElementById('btnGenerar');
        const btnConsolidado = document.getElementById('btnConsolidado');
        const btnLimpiar = document.getElementById('btnLimpiar');
        const contentArea = document.getElementById('contentArea');
        const exportButtons = document.getElementById('exportButtons');

        tomaSelect.addEventListener('change', () => {
            actualizarCultivosPorToma(tomaSelect.value);
        });

        // Eventos de drag & drop
        dropArea.addEventListener('click', () => fileUpload.click());
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Procesar archivo Excel
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Por favor selecciona un archivo Excel v√°lido (.xlsx o .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    workbook = XLSX.read(e.target.result, { type: 'binary' });
                    procesarWorkbook();
                    mostrarMensaje('success', `‚úÖ Archivo "${file.name}" cargado exitosamente`);
                } catch (error) {
                    mostrarMensaje('error', '‚ùå Error al leer el archivo: ' + error.message);
                }
            };
            reader.readAsBinaryString(file);
        }

        // Procesar datos del workbook
        function procesarWorkbook() {
            tomasData = {};
            tomaSelect.innerHTML = '<option value="">-- Selecciona una toma --</option>';
            tomaSelect.innerHTML += '<option value="CONSOLIDADO">üìä TODAS LAS TOMAS (Consolidado)</option>';

            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (data.length > 2) {
                    tomasData[sheetName] = procesarDatosToma(data);
                    tomaSelect.innerHTML += `<option value="${sheetName}">${sheetName}</option>`;
                }
            });
            cultivoFiltro.innerHTML = `<option value="TODOS">-- Todos los cultivos --</option>`;
            btnGenerar.disabled = false;
            btnConsolidado.disabled = false;
            document.getElementById('btnAvanceSiembra').disabled = false;
        }

        // Procesar datos de una toma espec√≠fica
        function procesarDatosToma(data) {
            const usuarios = [];
            
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                if (!row[0]) continue;

                const usuario = {
                    nombre: row[0] || '',
                    nombrePredio: row[1] || '',
                    unidadCatastral: row[2] || '',
                    tipoRiego: row[3] || '',
                    cultivo1: row[4] || '',
                    area1: parseFloat(row[5]) || 0,
                    cultivo2: row[6] || '',
                    area2: parseFloat(row[7]) || 0,
                    deudaCampana: parseFloat(row[8]) || 0,
                    deudaAtrasada: parseFloat(row[9]) || 0,
                    deudaConvenio: parseFloat(row[10]) || 0,
                    deudaTotal: parseFloat(row[11]) || 0,
                    alDia: row[12] || '',
                    debito: parseFloat(row[13]) || 0
                };

                usuarios.push(usuario);
            }

            return usuarios;
        }

        // Evaluar si usuario es apto
        function esUsuarioApto(usuario, deudaMax) {
            const tieneDeudaValida = usuario.deudaTotal <= deudaMax;
            const tieneCultivo = usuario.cultivo1 && usuario.cultivo1.trim() !== '';
            const tieneArea = usuario.area1 > 0;
            
            return tieneDeudaValida && tieneCultivo && tieneArea;
        }

        function generarAvanceSiembra(nombreToma) {
            const caudales = {
                "SD3":0.35,"SD4":0.25,"SD5":0.5,"SD6":0.35,"SD7":0.5,
                "SD8":1.2,"SD8.1":0.5,"SD9":0.25,"SD10":0.3,"SD11":0.45,
                "SD12":0.35,"SD12.1":0.095,"SD13":0.35,"SD14":0.3,
                "SD14.1":0.3,"SI3":0.29,"SI4":0.1,"SI5":0.25,
                "SI6":1.1,"SI7":0.05
            };

            const qMax = caudales[nombreToma] ?? "S/C";
            const usuarios = tomasData[nombreToma];
            if (!usuarios) return;

            const deudaMax = parseFloat(deudaMinima.value) || 0;
            const resumen = {};

            // Inicializar resumen con todos los cultivos
            usuarios.forEach(u => {
                const cultivos = [
                    { nombre: u.cultivo1, area: u.area1 },
                    { nombre: u.cultivo2, area: u.area2 }
                ];

                cultivos.forEach(c => {
                    if (!c.nombre || c.area <= 0) return;

                    if (!resumen[c.nombre]) {
                        resumen[c.nombre] = { areaTotal: 0, areaSemana: 0 };
                    }

                    resumen[c.nombre].areaTotal += c.area;

                    if (esUsuarioApto(u, deudaMax)) {
                        resumen[c.nombre].areaSemana += c.area;
                    }
                });
            });

            mostrarAvanceSiembra(nombreToma, resumen, qMax);
        }

        function mostrarAvanceSiembra(nombreToma, resumen, qMax) {
            let html = `
                <div style="text-align:center; margin-bottom:10px;">
                    <div style="
                        border:1px solid black;
                        display:inline-block;
                        padding:6px 20px;
                        font-weight:bold;
                        font-size:16px;
                        margin-bottom:8px;
                    ">
                        CAMPA√ëA AGR√çCOLA 2026 - I
                    </div>

                    <div style="
                        font-size:20px;
                        font-weight:bold;
                        text-decoration: underline;
                        margin-top:10px;
                    ">
                        CALCULO DE LAS DEMANDAS DE AGUA SEMANAL
                    </div>

                    <div style="margin-top:15px; font-size:14px;">
                        <strong>SEMANA PDA:</strong>
                        DEL <strong>${formatearFecha(semanaPDA.fechaInicio)}</strong>
                        AL <strong>${formatearFecha(semanaPDA.fechaFin)}</strong>
                    </div>
                </div>

                <div style="text-align:right; margin-bottom:10px;">
                    <button onclick="abrirProgramacionNoAptos()"
                        style="
                            background:#2e7d32;
                            color:white;
                            border:none;
                            padding:6px 12px;
                            border-radius:6px;
                            cursor:pointer;
                            font-weight:bold;
                        ">
                        ‚ûï Programar Usuarios No Aptos
                    </button>
                </div>

                <table class="report-table avance-siembra">
                    <thead>
                        <tr>
                            <th>CANAL</th>
                            <th>TOMA</th>
                            <th>Q MAX (m¬≥/s)</th>
                            <th>CULTIVO</th>
                            <th>AREA TOTAL<br><small>(ha)</small></th>
                            <th>AREA SEMANA<br><small>(ha)</small></th>
                            <th>PASE</th>
                            <th>MODULO<br><small>(m¬≥/ha)</small></th>
                            <th>EFICIENCIA<br><small>(%)</small></th>
                            <th>VOL BRUTO<br><small>(m¬≥)</small></th>
                            <th>VOL CORREGIDO<br><small>(m¬≥)</small></th>
                            <th>Q TEORICO<br><small>(m¬≥/s)</small></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(resumen).forEach(([cultivo, d], index) => {
                const alerta = d.areaTotal > 0 && d.areaSemana === 0;

                html += `
                    <tr class="${alerta ? 'totals-row' : ''}" data-cultivo="${cultivo}">
                        ${index === 0 ? `
                            <td rowspan="${Object.keys(resumen).length}" 
                                style="
                                    writing-mode: vertical-rl;
                                    transform: rotate(180deg);
                                    text-align: center;
                                    font-weight: bold;
                                ">
                                CANAL SUR
                            </td>` : ""}
                        ${index === 0 ? `<td rowspan="${Object.keys(resumen).length}">${nombreToma}</td>` : ""}
                        ${index === 0 ? `<td rowspan="${Object.keys(resumen).length}">${qMax}</td>` : ""}
                        <td class="cultivo-nombre">${cultivo}</td>
                        <td>${d.areaTotal.toFixed(2)}</td>
                        <td>
                            <input type="number"
                                step="0.01"
                                class="area-semana"
                                value="${d.areaSemana.toFixed(2)}"
                                ${d.areaSemana == 0 ? "disabled style='background:#eee;'" : ""}
                                oninput="recalcularAvance(this)">
                        </td>
                        <td><input class="input-mini" oninput="recalcularAvance(this)"></td>
                        <td>
                            <input type="number" step="0.01" 
                                class="input-mini modulo" 
                                oninput="recalcularAvance(this)">
                        </td>
                        <td>
                            <input type="number" step="0.01" 
                                class="input-mini eficiencia" 
                                oninput="recalcularAvance(this)">
                        </td>
                        <td class="volBruto">0.00</td>
                        <td class="volCorregido">0.00</td>
                        <td class="qTeorico">0.000</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            // Contenedor para los paneles de usuarios no aptos
            html += `<div id="contenedorPanelesNoAptos"></div>`;

            contentArea.innerHTML = html;
        }

        function recalcularAvance(input) {
    const fila = input.closest("tr");
    
    const areaSemanaInput = fila.querySelector(".area-semana");
    const moduloInput = fila.querySelector(".modulo");
    const eficienciaInput = fila.querySelector(".eficiencia");

    const areaSemana = parseFloat(areaSemanaInput?.value) || 0;
    
    // ‚úÖ SI TIENE √ÅREA, ASEGURAR QUE LA FILA TENGA FONDO BLANCO
    if (areaSemana > 0) {
        fila.style.backgroundColor = "white";
        fila.classList.remove('totals-row');
    }
    
    const modulo = parseFloat(moduloInput?.value) || 0;
    const eficienciaPorcentaje = parseFloat(eficienciaInput?.value) || 0;

    const eficienciaDecimal = eficienciaPorcentaje / 100;
    const volumenBruto = areaSemana * modulo;
    const volumenCorregido = eficienciaDecimal > 0 ? volumenBruto / eficienciaDecimal : 0;
    const qTeorico = volumenCorregido / (7 * 86400);

    fila.querySelector(".volBruto").innerText = volumenBruto.toFixed(2);
    fila.querySelector(".volCorregido").innerText = volumenCorregido.toFixed(2);
    fila.querySelector(".qTeorico").innerText = qTeorico.toFixed(3);
    
    // ‚úÖ LLAMAR A ACTUALIZAR TOTALES FINALES
    actualizarTotalesFinales();
}
function abrirProgramacionNoAptosToma() {
    console.log("=== ABRIR PROGRAMACION NO APTOS TOMA ===");
    
    // Obtener la toma de la tabla actual (m√°s confiable que window.tomaActualSeleccionada)
    const tabla = document.getElementById('tablaAvanceSiembra');
    if (!tabla) {
        alert('No se encontr√≥ la tabla de avance de siembra');
        return;
    }
    
    // Obtener el nombre de la toma de la primera fila de datos
    const primeraFila = tabla.querySelector('tbody tr.fila-cultivo');
    if (!primeraFila) {
        alert('No hay cultivos en la tabla');
        return;
    }
    
    // La toma est√° en el atributo data de la fila o en la celda
    let nombreToma = window.tomaActualSeleccionada;
    
    // Si no est√° en window, intentar obtenerlo de la tabla
    if (!nombreToma) {
        const celdaToma = tabla.querySelector('tbody tr td:nth-child(2)');
        if (celdaToma) {
            nombreToma = celdaToma.innerText.trim();
        }
    }
    
    console.log("Toma detectada:", nombreToma);
    
    if (!nombreToma) {
        alert('No se pudo detectar la toma actual');
        return;
    }
    
    // Buscar en tomasData
    let usuarios = null;
    let nombreHoja = null;
    
    // Primero buscar coincidencia exacta
    if (tomasData[nombreToma]) {
        usuarios = tomasData[nombreToma];
        nombreHoja = nombreToma;
    } else {
        // Buscar coincidencia parcial
        for (let hoja in tomasData) {
            const hojaUpper = hoja.toUpperCase();
            const tomaUpper = nombreToma.toUpperCase();
            
            if (hojaUpper.includes(tomaUpper) || tomaUpper.includes(hojaUpper)) {
                usuarios = tomasData[hoja];
                nombreHoja = hoja;
                console.log(`Coincidencia encontrada: hoja "${hoja}" para toma "${nombreToma}"`);
                break;
            }
        }
    }
    
    if (!usuarios) {
        console.error("No se encontraron datos para la toma:", nombreToma);
        console.log("Hojas disponibles:", Object.keys(tomasData));
        alert(`No se encontraron datos para la toma: ${nombreToma}\n\nHojas disponibles: ${Object.keys(tomasData).join(', ')}`);
        return;
    }
    
    console.log(`Usuarios encontrados en hoja "${nombreHoja}":`, usuarios.length);
    
    const deudaMax = parseFloat(deudaMinima.value) || 0;
    
    // Filtrar usuarios no aptos
    usuariosNoAptosDisponibles = usuarios.filter(u => {
        const tieneDeuda = parseFloat(u.deudaTotal) > 0;
        const noEsApto = !esUsuarioApto(u, deudaMax);
        const noExcluido = !debeExcluirse(u);
        return tieneDeuda && noEsApto && noExcluido;
    });
    
    // Agregar informaci√≥n de la toma a cada usuario
    usuariosNoAptosDisponibles.forEach(u => {
        u._tomaOrigen = nombreToma;
    });
    
    console.log(`Usuarios no aptos encontrados: ${usuariosNoAptosDisponibles.length}`);
    
    if (usuariosNoAptosDisponibles.length === 0) {
        alert(`No hay usuarios no aptos en la toma: ${nombreToma}\n\n(Todos los usuarios est√°n al d√≠a o no tienen deuda)`);
        return;
    }
    
    // Mostrar paneles
    generarPanelesNoAptosTomaSimple(nombreToma);
}
function generarPanelesNoAptosTomaSimple(nombreToma) {
    console.log("Generando paneles para toma:", nombreToma);
    
    // Eliminar contenedor anterior si existe
    let contenedor = document.getElementById('contenedorPanelesNoAptos');
    if (contenedor) {
        contenedor.remove();
    }
    
    // Crear nuevo contenedor
    contenedor = document.createElement('div');
    contenedor.id = 'contenedorPanelesNoAptos';
    contenedor.style.cssText = 'margin-top: 20px; border: 2px solid #0070c0; padding: 20px; border-radius: 8px; background: #f8f9fa;';
    
    // Insertar DESPU√âS de la tabla
    const tabla = document.getElementById('tablaAvanceSiembra');
    if (tabla && tabla.parentNode) {
        tabla.parentNode.insertBefore(contenedor, tabla.nextSibling);
    } else {
        contentArea.appendChild(contenedor);
    }
    
    // Generar HTML de los paneles
    let html = `
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
            <h3 style="color: #0070c0; margin-bottom: 15px; border-bottom: 2px solid #0070c0; padding-bottom: 8px;">
                üìã PROGRAMAR USUARIOS NO APTOS - TOMA: ${nombreToma}
            </h3>
            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                <strong>Total usuarios no aptos:</strong> ${usuariosNoAptosDisponibles.length}
            </div>
            
            <input type="text" 
                   id="buscadorNoAptos"
                   placeholder="üîç Buscar por nombre o apellido..."
                   style="width:100%; padding:10px; margin-bottom:15px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;"
                   oninput="filtrarNoAptosTomaSimple()">
            
            <div style="max-height:300px; overflow-y:auto; border: 1px solid #dee2e6; border-radius: 6px;">
                <table class="report-table" id="tablaNoAptos" style="margin: 0; font-size: 13px;">
                    <thead style="background: #0070c0; color: white;">
                        <tr>
                            <th style="padding: 10px;">N¬∞</th>
                            <th style="padding: 10px;">USUARIO</th>
                            <th style="padding: 10px;">CULTIVO</th>
                            <th style="padding: 10px;">√ÅREA (ha)</th>
                            <th style="padding: 10px;">DEUDA TOTAL</th>
                            <th style="padding: 10px;">ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasNoAptosTomaSimple()}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="cerrarPanelNoAptosTomaSimple()" 
                    style="background:#dc3545; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight: bold;">
                    ‚ùå Cerrar Panel
                </button>
            </div>
        </div>
    `;

    // Panel de usuarios programados (inicialmente oculto si no hay programados)
    const programadosDeEstaToma = usuariosProgramados.filter(u => u._tomaOrigen === nombreToma);
    
    html += `
        <div id="panelNoAptosProgramados" style="background: #d4edda; padding: 15px; border-radius: 8px; border: 2px solid #28a745; display: ${programadosDeEstaToma.length > 0 ? 'block' : 'none'};">
            <h3 style="color: #155724; margin-bottom: 15px; border-bottom: 2px solid #28a745; padding-bottom: 8px;">
                ‚úÖ USUARIOS PROGRAMADOS PARA RIEGO
            </h3>
            <div style="max-height:250px; overflow-y:auto; border: 1px solid #28a745; border-radius: 6px; background: white;">
                <table class="report-table" id="tablaProgramados" style="margin: 0; font-size: 13px;">
                    <thead style="background: #28a745; color: white;">
                        <tr>
                            <th style="padding: 10px;">N¬∞</th>
                            <th style="padding: 10px;">USUARIO</th>
                            <th style="padding: 10px;">CULTIVO</th>
                            <th style="padding: 10px;">√ÅREA (ha)</th>
                            <th style="padding: 10px;">DEUDA TOTAL</th>
                            <th style="padding: 10px;">ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasProgramadosTomaSimple()}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    contenedor.innerHTML = html;
    
    // Scroll suave hacia el panel
    setTimeout(() => {
        contenedor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    
    console.log("Paneles generados exitosamente");
}
function generarFilasNoAptosTomaSimple() {
    let html = '';
    let item = 1;

    usuariosNoAptosDisponibles.forEach((usuario, index) => {
        html += `
            <tr data-index="${index}">
                <td>${item}</td>
                <td>${usuario.nombre}</td>
                <td>${usuario.cultivo1 || '-'}</td>
                <td>${(usuario.area1 || 0).toFixed(2)}</td>
                <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                <td>
                    <button onclick="programarUsuarioTomaSimple(${index})"
                        style="background:#0070c0;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                        Seleccionar
                    </button>
                </td>
            </tr>
        `;
        item++;
    });

    return html;
}

function generarFilasProgramadosTomaSimple() {
    let html = '';
    let item = 1;

    // Filtrar solo los usuarios programados de la toma actual
    const programadosDeEstaToma = usuariosProgramados.filter(u => 
        u._tomaOrigen === window.tomaActualSeleccionada
    );

    programadosDeEstaToma.forEach((usuario) => {
        const globalIndex = usuariosProgramados.findIndex(u => u === usuario);
        html += `
            <tr data-index="${globalIndex}">
                <td>${item}</td>
                <td>${usuario.nombre}</td>
                <td>${usuario.cultivo1 || '-'}</td>
                <td>${(usuario.area1 || 0).toFixed(2)}</td>
                <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                <td>
                    <button onclick="deshacerProgramacionTomaSimple(${globalIndex})"
                        style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                        Deshacer
                    </button>
                </td>
            </tr>
        `;
        item++;
    });

    return html;
}
function programarUsuarioTomaSimple(index) {
    const usuario = usuariosNoAptosDisponibles[index];
    
    // ‚úÖ ASEGURAR QUE TENGA REFERENCIA A LA TOMA
    if (!usuario._tomaOrigen) {
        usuario._tomaOrigen = window.tomaActualSeleccionada;
    }
    
    // Agregar a programados
    usuariosProgramados.push(usuario);
    
    // Quitar de disponibles
    usuariosNoAptosDisponibles.splice(index, 1);
    
    // Actualizar paneles
    actualizarPanelesNoAptosTomaSimple();
    
    // Actualizar el √°rea en la tabla principal
    actualizarAreaEnTablaPrincipalTomaSimple(usuario, 'sumar');
    
    console.log(`‚úÖ Usuario ${usuario.nombre} programado en toma ${usuario._tomaOrigen}, cultivo ${usuario.cultivo1}`);
    console.log(`   Total usuarios programados en ${usuario._tomaOrigen}:`, 
        usuariosProgramados.filter(u => u._tomaOrigen === usuario._tomaOrigen).length);
}

function deshacerProgramacionTomaSimple(index) {
    const usuario = usuariosProgramados[index];
    
    // Devolver a disponibles
    usuariosNoAptosDisponibles.push(usuario);
    
    // Quitar de programados
    usuariosProgramados.splice(index, 1);
    
    // Actualizar paneles
    actualizarPanelesNoAptosTomaSimple();
    
    // Actualizar el √°rea en la tabla principal
    actualizarAreaEnTablaPrincipalTomaSimple(usuario, 'restar');
    
    // Limpiar m√≥dulo y eficiencia si el √°rea queda en cero
    limpiarModuloYEficienciaTomaSimple(usuario.cultivo1);
}

function actualizarPanelesNoAptosTomaSimple() {
    // Actualizar tabla de disponibles
    const tbodyDisponibles = document.querySelector('#tablaNoAptos tbody');
    if (tbodyDisponibles) {
        tbodyDisponibles.innerHTML = generarFilasNoAptosTomaSimple();
    }

    // Actualizar tabla de programados
    const panelProgramados = document.getElementById('panelNoAptosProgramados');
    const tbodyProgramados = document.querySelector('#tablaProgramados tbody');
    
    const programadosDeEstaToma = usuariosProgramados.filter(u => 
        u._tomaOrigen === window.tomaActualSeleccionada
    );
    
    if (programadosDeEstaToma.length > 0) {
        panelProgramados.style.display = 'block';
        if (tbodyProgramados) {
            tbodyProgramados.innerHTML = generarFilasProgramadosTomaSimple();
        }
    } else {
        panelProgramados.style.display = 'none';
    }
    
    // Actualizar contador en el panel
    const contadorDiv = document.querySelector('#panelNoAptosDisponibles div[style*="background: #fff3cd"]');
    if (contadorDiv) {
        contadorDiv.innerHTML = `
            <strong>Toma seleccionada:</strong> ${window.tomaActualSeleccionada} | 
            <strong>Usuarios no aptos:</strong> ${usuariosNoAptosDisponibles.length}
        `;
    }
}

function actualizarAreaEnTablaPrincipalTomaSimple(usuario, operacion) {
    // Buscar la fila espec√≠fica en la tabla principal
    const filas = document.querySelectorAll("#tablaAvanceSiembra tbody tr.fila-cultivo");
    
    let filaEncontrada = null;
    
    filas.forEach(fila => {
        const cultivoFila = fila.querySelector(".cultivo-nombre")?.innerText.trim();
        
        // Debe coincidir exactamente el cultivo
        if (cultivoFila === usuario.cultivo1) {
            filaEncontrada = fila;
        }
    });
    
    if (!filaEncontrada) {
        console.warn(`No se encontr√≥ fila para cultivo ${usuario.cultivo1}`);
        return;
    }
    
    const inputArea = filaEncontrada.querySelector(".area-semana");
    let areaActual = parseFloat(inputArea.value) || 0;
    const areaOriginal = parseFloat(filaEncontrada.getAttribute('data-area-semana')) || 0;
    
    if (operacion === 'sumar') {
        areaActual += (usuario.area1 || 0);
    } else if (operacion === 'restar') {
        areaActual -= (usuario.area1 || 0);
        // No permitir bajar del √°rea original (usuarios aptos)
        if (areaActual < areaOriginal) areaActual = areaOriginal;
    }
    
    inputArea.value = areaActual.toFixed(2);
    
    // Cambiar color de fondo de la fila seg√∫n el √°rea
    if (areaActual > 0) {
        filaEncontrada.style.backgroundColor = "white";
        filaEncontrada.classList.remove('totals-row');
    } else {
        filaEncontrada.style.backgroundColor = "#fff3cd";
    }
    
    // Mantener siempre readonly, solo cambiar estilos visuales
inputArea.readOnly = true;
if (areaActual > areaOriginal) {
    // Tiene usuarios programados adicionales
    inputArea.style.background = "#e3f2fd"; // Azul claro
    inputArea.style.color = "#0070c0";
    inputArea.style.fontWeight = "bold";
    inputArea.style.cursor = "not-allowed";
} else {
    // Solo √°rea original
    inputArea.style.background = areaOriginal === 0 ? "#eee" : "#f8f9fa";
    inputArea.style.color = "black";
    inputArea.style.fontWeight = "normal";
    inputArea.style.cursor = "not-allowed";
}
    
    // Recalcular vol√∫menes y caudal
    recalcularAvance(inputArea);
    
    console.log(`√Årea actualizada en ${usuario.cultivo1}: ${areaActual.toFixed(2)} ha`);
}

function limpiarModuloYEficienciaTomaSimple(nombreCultivo) {
    const filas = document.querySelectorAll('#tablaAvanceSiembra tbody tr.fila-cultivo');
    
    filas.forEach(fila => {
        const cultivoFila = fila.querySelector('.cultivo-nombre')?.innerText.trim();
        const areaOriginal = parseFloat(fila.getAttribute('data-area-semana')) || 0;
        
        if (cultivoFila === nombreCultivo) {
            const inputArea = fila.querySelector('.area-semana');
            const areaActual = parseFloat(inputArea?.value) || 0;
            
            // Solo limpiar si el √°rea volvi√≥ al valor original
            if (areaActual <= areaOriginal) {
                const inputModulo = fila.querySelector('.modulo');
                const inputEficiencia = fila.querySelector('.eficiencia');
                
                if (inputModulo) inputModulo.value = "";
                if (inputEficiencia) inputEficiencia.value = "";
                
                // Restaurar color de alerta si el √°rea volvi√≥ a cero
                if (areaActual === 0) {
                    fila.style.backgroundColor = "#fff3cd";
                    fila.classList.add('totals-row');
                }
                
                recalcularAvance(inputArea);
            }
        }
    });
}
function cerrarPanelNoAptosTomaSimple() {
    const contenedor = document.getElementById('contenedorPanelesNoAptos');
    if (contenedor) {
        contenedor.style.transition = "opacity 0.3s ease";
        contenedor.style.opacity = "0";
        
        setTimeout(() => {
            contenedor.remove();
        }, 300);
    }
}
function actualizarSumatoriaToma(nombreToma) {
    // Buscar todas las filas de esta toma (excluyendo la fila de sumatoria)
    const filasToma = document.querySelectorAll(`tr.fila-toma-${nombreToma}`);
    const filaSumatoria = document.querySelector(`tr[data-toma-sumatoria="${nombreToma}"]`);
    
    if (!filaSumatoria) return;
    
    let sumaAreaSemana = 0;
    let sumaVolBruto = 0;
    let sumaVolCorregido = 0;
    let sumaQTeorico = 0;
    
    console.log(`=== ACTUALIZANDO SUMATORIA PARA ${nombreToma} ===`);
    console.log(`Filas encontradas: ${filasToma.length}`);
    
    filasToma.forEach((fila, index) => {
        const areaSemana = parseFloat(fila.querySelector('.area-semana')?.value) || 0;
        const volBruto = parseFloat(fila.querySelector('.volBruto')?.innerText) || 0;
        const volCorregido = parseFloat(fila.querySelector('.volCorregido')?.innerText) || 0;
        const qTeorico = parseFloat(fila.querySelector('.qTeorico')?.innerText) || 0;
        
        console.log(`Fila ${index}: √Årea=${areaSemana}, VolBruto=${volBruto}, VolCorregido=${volCorregido}, QTeorico=${qTeorico}`);
        
        sumaAreaSemana += areaSemana;
        sumaVolBruto += volBruto;
        sumaVolCorregido += volCorregido;
        sumaQTeorico += qTeorico;
    });
    
    // Actualizar TODAS las celdas de sumatoria
    const celdaAreaSemana = filaSumatoria.querySelector('.suma-area-semana');
    const celdaVolBruto = filaSumatoria.querySelector('.suma-vol-bruto');
    const celdaVolCorregido = filaSumatoria.querySelector('.suma-vol-corregido');
    const celdaQTeorico = filaSumatoria.querySelector('.suma-q-teorico');
    
    if (celdaAreaSemana) celdaAreaSemana.innerText = sumaAreaSemana.toFixed(2);
    if (celdaVolBruto) celdaVolBruto.innerText = sumaVolBruto.toFixed(2);
    if (celdaVolCorregido) celdaVolCorregido.innerText = sumaVolCorregido.toFixed(2);
    if (celdaQTeorico) celdaQTeorico.innerText = sumaQTeorico.toFixed(3);
    
    console.log(`Sumatoria actualizada para ${nombreToma}:`, {
        areaSemana: sumaAreaSemana,
        volBruto: sumaVolBruto,
        volCorregido: sumaVolCorregido,
        qTeorico: sumaQTeorico
    });
}

        // ========== FUNCIONES PARA C√ÅLCULO AUTOM√ÅTICO DE SEMANA PDA ==========

function abrirModalSemanaPDA() {
    const modal = document.getElementById('modalSemanaPDA');
    
    // Calcular semana autom√°ticamente
    const semana = calcularSemanaEvaluacionAutomatica();
    semanaPDA = semana;
    
    // Solo mostrar semana a evaluar y mes/a√±o
    document.getElementById('displaySemanaEvaluar').textContent = `SEMANA DEL ${formatearFecha(semana.fechaInicio)} AL ${formatearFecha(semana.fechaFin)}`;
    document.getElementById('displayRangoFechas').textContent = `${obtenerNombreMes(semana.fechaInicio)} ${semana.fechaInicio.split('-')[0]}`;
    
    // Mostrar modal
    modal.classList.add('active');
}

function calcularSemanaEvaluacionAutomatica() {
    const hoy = new Date();
    const diaSemana = hoy.getDay(); // 0=Domingo, 1=Lunes, ..., 6=S√°bado
    const fechaHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
    
    // Encontrar el jueves de esta semana (d√≠a de env√≠o de reporte)
    let diasParaJueves = 4 - diaSemana; // 4 = Jueves
    if (diasParaJueves < 0) {
        diasParaJueves += 7; // Jueves de la pr√≥xima semana
    }
    
    const proximoJueves = new Date(fechaHoy);
    proximoJueves.setDate(fechaHoy.getDate() + diasParaJueves);
    
    // La semana a evaluar comienza el LUNES DESPU√âS del pr√≥ximo jueves
    const fechaInicio = new Date(fechaHoy);
    fechaInicio.setDate(fechaHoy.getDate() + diasParaJueves + 4); // Jueves + 4 d√≠as = Lunes siguiente
    
    // Calcular fecha fin
    let fechaFin;
    
    // √öltimo d√≠a del mes de inicio
    const ultimoDiaMes = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth() + 1, 0);
    const domingoNatural = new Date(fechaInicio);
    domingoNatural.setDate(fechaInicio.getDate() + 6); // Lunes + 6 = Domingo natural
    
    // REGLA: Si el mes termina ANTES del domingo natural, cerrar en √∫ltimo d√≠a del mes
    if (ultimoDiaMes < domingoNatural) {
        fechaFin = ultimoDiaMes;
    } else {
        fechaFin = domingoNatural;
    }
    
    // Calcular d√≠as de riego reales
    const diasRiego = Math.floor((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1;
    
    return {
        fechaInicio: formatearFechaISO(fechaInicio),
        fechaFin: formatearFechaISO(fechaFin),
        proximoJueves: formatearFechaISO(proximoJueves),
        diasParaJueves: diasParaJueves,
        diasRiego: diasRiego,
        esCierreMes: ultimoDiaMes < domingoNatural
    };
}

function formatearFechaISO(fecha) {
    const a√±o = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    return `${a√±o}-${mes}-${dia}`;
}

function obtenerNombreMes(fechaISO) {
    const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 
                   'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
    const fecha = new Date(fechaISO + 'T00:00:00');
    return meses[fecha.getMonth()];
}

function confirmarSemanaAutomatica() {
    // Cerrar modal
    cerrarModalSemana();
    
    // Continuar al selector de grupos
    setTimeout(() => {
        mostrarSelectorDeGrupos();
    }, 100);
}

function cerrarModalSemana() {
    const modal = document.getElementById('modalSemanaPDA');
    if (modal) {
        modal.classList.remove('active');
    }
    tomaPendiente = null;
}

// Funci√≥n formatearFecha existente
function formatearFecha(fechaStr) {
    if (!fechaStr) return '-';
    const partes = fechaStr.split('-');
    return `${partes[2]}/${partes[1]}/${partes[0]}`;
}

        function debeExcluirse(usuario) {
            const sinDeuda = usuario.deudaTotal === 0;
            const sinCultivo = !usuario.cultivo1 || usuario.cultivo1.trim() === '';
            const sinArea = usuario.area1 === 0;
            
            return sinDeuda && sinCultivo && sinArea;
        }

        function obtenerTipoRiego(tipo) {
            if (!tipo || tipo.trim() === '') return 'NO ESPECIFICADO';
            const t = tipo.toUpperCase().trim();
            if (t === 'G' || t.includes('GRAVEDAD')) return 'GRAVEDAD';
            if (t === 'T' || t.includes('TECNIFICADO')) return 'TECNIFICADO';
            if (t === 'B' || t.includes('BOMBEO')) return 'BOMBEO';
            return 'NO ESPECIFICADO';
        }

        function actualizarCultivosPorToma(nombreToma) {
            cultivoFiltro.innerHTML = `<option value="TODOS">-- Todos los cultivos --</option>`;
            if (!nombreToma || nombreToma === "CONSOLIDADO") return;

            const usuarios = tomasData[nombreToma];
            if (!usuarios) return;

            let cultivosSet = new Set();
            usuarios.forEach(u => {
                if (u.cultivo1 && u.cultivo1.trim() !== "") {
                    cultivosSet.add(u.cultivo1.trim());
                }
            });

            [...cultivosSet].sort().forEach(cultivo => {
                cultivoFiltro.innerHTML += `<option value="${cultivo}">${cultivo}</option>`;
            });
        }

        btnGenerar.addEventListener('click', () => {
            const tomaSeleccionada = tomaSelect.value;
            if (!tomaSeleccionada) {
                alert('Por favor selecciona una toma');
                return;
            }
            if (tomaSeleccionada === 'CONSOLIDADO') {
                generarReporteConsolidado();
            } else {
                generarReporteIndividual(tomaSeleccionada);
            }
        });

        btnConsolidado.addEventListener('click', () => {
            generarReporteConsolidado();
        });

        document.getElementById('btnAvanceSiembra').addEventListener('click', () => {
    // Ya no requiere selecci√≥n previa de toma
    // Ir directo a seleccionar la semana PDA
    tomaPendiente = null; // Se determinar√° despu√©s
    abrirModalSemanaPDA();
});

        function generarReporteIndividual(nombreToma) {
            const usuarios = tomasData[nombreToma];
            if (!usuarios) {
                alert('No se encontraron datos para esta toma');
                return;
            }

            const deudaMax = parseFloat(deudaMinima.value) || 0;
            const tipo = tipoReporte.value;
            const cultivoSeleccionado = cultivoFiltro.value;
            
            let usuariosFiltrados = [];
            let usuariosExcluidos = [];
            let totalArea = 0;
            let totalDeuda = 0;
            let totalAptos = 0;
            let totalNoAptos = 0;

            usuarios.forEach(usuario => {
                if (debeExcluirse(usuario)) {
                    usuariosExcluidos.push(usuario);
                    return;
                }

                const esApto = esUsuarioApto(usuario, deudaMax);
                if (esApto) totalAptos++;
                else totalNoAptos++;

                const coincideCultivo =
                    cultivoSeleccionado === "TODOS" ||
                    usuario.cultivo1 === cultivoSeleccionado ||
                    usuario.cultivo2 === cultivoSeleccionado;

                if (!coincideCultivo) return;

                if (tipo === 'aptos' && esApto) {
                    usuariosFiltrados.push(usuario);
                    if (cultivoSeleccionado === "TODOS") {
                        totalArea += usuario.area1 + usuario.area2;
                    } else if (usuario.cultivo1 === cultivoSeleccionado) {
                        totalArea += usuario.area1;
                    } else if (usuario.cultivo2 === cultivoSeleccionado) {
                        totalArea += usuario.area2;
                    }
                } else if (tipo === 'noAptos' && !esApto) {
                    usuariosFiltrados.push(usuario);
                    if (cultivoSeleccionado === "TODOS") {
                        totalArea += usuario.area1 + usuario.area2;
                    } else if (usuario.cultivo1 === cultivoSeleccionado) {
                        totalArea += usuario.area1;
                    } else if (usuario.cultivo2 === cultivoSeleccionado) {
                        totalArea += usuario.area2;
                    }
                    totalDeuda += usuario.deudaTotal;
                }
            });

            mostrarReporte(nombreToma, usuariosFiltrados, usuariosExcluidos, {
                totalArea,
                totalDeuda,
                totalAptos,
                totalNoAptos,
                deudaMax,
                tipo
            });
        }

        function mostrarReporte(nombreToma, usuarios, excluidos, stats) {
            let html = `
                <div class="alert alert-success">
                    <strong>‚úÖ Reporte Generado</strong><br>
                    Toma: ${nombreToma} | Tipo: ${stats.tipo === 'aptos' ? 'Usuarios Aptos' : 'Usuarios con Deuda'} | Deuda M√°xima: S/ ${stats.deudaMax.toFixed(2)}
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>${stats.totalAptos}</h3>
                        <p>Usuarios Aptos</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalNoAptos}</h3>
                        <p>Con Deuda</p>
                    </div>
                    <div class="stat-card">
                        <h3>${usuarios.length}</h3>
                        <p>En este Reporte</p>
                    </div>
                    <div class="stat-card">
                        <h3>${excluidos.length}</h3>
                        <p>Excluidos</p>
                    </div>
                </div>

                <table class="report-table">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>Nombre del Usuario</th>
                            <th>U. Catastral</th>
                            <th>Tipo Riego</th>
                            <th>Cultivo</th>
                            <th>√Årea (ha)</th>
                            <th>Apto</th>
                            ${stats.tipo === 'aptos' ? '<th>D√©bito (S/)</th>' 
                                : '<th>D. Campa√±a</th><th>D. Atrasada</th><th>D. Convenio</th><th>Deuda Total (S/)</th>'}
                        </tr>
                    </thead>
                    <tbody>
            `;

            usuarios.forEach((u, i) => {
                const esApto = esUsuarioApto(u, stats.deudaMax);
                const cultivos = [];

                if (u.cultivo1) {
                    if (cultivoFiltro.value === "TODOS" || u.cultivo1 === cultivoFiltro.value) {
                        cultivos.push({ nombre: u.cultivo1 || "-", area: u.area1 || 0 });
                    }
                }

                if (u.cultivo2) {
                    if (cultivoFiltro.value === "TODOS" || u.cultivo2 === cultivoFiltro.value) {
                        cultivos.push({ nombre: u.cultivo2 || "-", area: u.area2 || 0 });
                    }
                }

                if (cultivos.length === 0 && u.deudaTotal > 0) {
                    cultivos.push({ nombre: "-", area: 0 });
                }

                const filas = cultivos.length || 1;

                cultivos.forEach((c, index) => {
                    html += `<tr>`;

                    if (index === 0) {
                        html += `
                            <td rowspan="${filas}" style="text-align:center;"><strong>${i + 1}</strong></td>
                            <td rowspan="${filas}">${u.nombre}</td>
                            <td rowspan="${filas}">${u.unidadCatastral}</td>
                            <td rowspan="${filas}">${obtenerTipoRiego(u.tipoRiego)}</td>
                        `;
                    }

                    html += `
                        <td>${c.nombre}</td>
                        <td>${c.area.toFixed(2)}</td>
                    `;

                    if (index === 0) {
                        html += `
                            <td rowspan="${filas}">
                                <span class="badge ${esApto ? 'badge-success' : 'badge-danger'}">
                                    ${esApto ? 'S√ç' : 'NO'}
                                </span>
                            </td>
                        `;

                        if (stats.tipo === 'aptos') {
                            html += `<td rowspan="${filas}">S/ ${u.debito.toFixed(2)}</td>`;
                        } else {
                            html += `
                                <td rowspan="${filas}">S/ ${u.deudaCampana.toFixed(2)}</td>
                                <td rowspan="${filas}">S/ ${u.deudaAtrasada.toFixed(2)}</td>
                                <td rowspan="${filas}">S/ ${u.deudaConvenio.toFixed(2)}</td>
                                <td rowspan="${filas}"><strong>S/ ${u.deudaTotal.toFixed(2)}</strong></td>
                            `;
                        }
                    }

                    html += `</tr>`;
                });
            });

            html += `
                    <tr class="totals-row">
                        <td colspan="5"><strong>TOTALES</strong></td>
                        <td><strong>${stats.totalArea.toFixed(2)} ha</strong></td>
                        <td></td>
                        ${stats.tipo === 'aptos' 
                            ? `<td><strong>S/ ${usuarios.reduce((sum,u)=>sum+u.debito,0).toFixed(2)}</strong></td>`
                            : `<td colspan="3" style="text-align:right"><strong>TOTAL DEUDA:</strong></td>
                                <td><strong>S/ ${stats.totalDeuda.toFixed(2)}</strong></td>`
                        }
                    </tr>
                </tbody>
                </table>
            `;

            if (excluidos.length > 0) {
                html += `
                    <div class="excluded-section">
                        <h3>‚ö†Ô∏è Usuarios Excluidos (Sin deuda y sin cultivo/√°rea)</h3>
                        <p><strong>Total:</strong> ${excluidos.length} usuarios</p>
                        <ul>
                            ${excluidos.map(u => `<li>${u.nombre}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (incluirGraficos.checked) {
                html += `
                    <div class="chart-container">
                        <canvas id="reportChart"></canvas>
                    </div>
                `;
            }

            contentArea.innerHTML = html;
            exportButtons.classList.add('show');

            if (incluirGraficos.checked) {
                generarGrafico(stats.totalAptos, stats.totalNoAptos);
            }
        }

        function generarReporteConsolidado() {
    const deudaMax = parseFloat(deudaMinima.value) || 0;
    
    // ========== RECOLECTAR DATOS ==========
    
    // Datos para tabla resumen (deuda por toma)
    let tomasResumen = [];
    let totalGeneralDeuda = 0;
    let totalGeneralAptos = 0;
    let totalGeneralNoAptos = 0;
    let totalGeneralAreaAptos = 0;
    let totalGeneralAreaNoAptos = 0;

    Object.keys(tomasData).forEach(nombreToma => {
        const usuarios = tomasData[nombreToma];
        let aptos = 0, noAptos = 0, deudaToma = 0, areaAptos = 0, areaNoAptos = 0;

        usuarios.forEach(usuario => {
            if (debeExcluirse(usuario)) return;
            if (esUsuarioApto(usuario, deudaMax)) {
                aptos++;
                areaAptos += usuario.area1;
            } else {
                noAptos++;
                areaNoAptos += usuario.area1;
                deudaToma += usuario.deudaTotal;
            }
        });

// ‚úÖ ORDENAR TOMAS SEG√öN GRUPOS DEFINIDOS
const nombresTomas = tomasResumen.map(t => t.nombre);
const nombresOrdenados = obtenerTomasOrdenadasPorGrupo(nombresTomas);
tomasResumen.sort((a, b) => {
    const indexA = nombresOrdenados.indexOf(a.nombre);
    const indexB = nombresOrdenados.indexOf(b.nombre);
    return indexA - indexB;
});
        tomasResumen.push({ nombre: nombreToma, aptos, noAptos, total: aptos + noAptos, 
                          areaAptos, areaNoAptos, deuda: deudaToma });
        totalGeneralDeuda += deudaToma;
        totalGeneralAptos += aptos;
        totalGeneralNoAptos += noAptos;
        totalGeneralAreaAptos += areaAptos;
        totalGeneralAreaNoAptos += areaNoAptos;
    });

    // ========== GENERAR HTML PARA IMPRESI√ìN EN 3 HOJAS ==========
    
    let html = `
        <div id="printContainer">
            
            <!-- ========== HOJA 1: USUARIOS CON DERECHO DE USO DE RIEGO ========== -->
            <div class="hoja-print">
                <div class="encabezado-hoja">
                    <h2>COMISI√ìN DE USUARIOS DEL SUB SECTOR HIDR√ÅULICO MARGEN IZQUIERDA</h2>
                    <p><strong>CUSSHMI - Unidad de Operaci√≥n y Tarifas</strong></p>
                    <p style="font-size: 10pt; color: #155724; margin-top: 5px;">
                        üìã HOJA 1: USUARIOS CON DERECHO DE USO DE RIEGO
                    </p>
                    <p style="font-size: 7pt;">Deuda M√°xima Permitida: S/ ${deudaMax.toFixed(2)} | 
                       Fecha: ${new Date().toLocaleDateString('es-PE')}</p>
                </div>

                <div class="stats-print">
                    <div class="stat-box">
                        <h4>${totalGeneralAptos}</h4>
                        <p>Total Usuarios Aptos</p>
                    </div>
                    <div class="stat-box">
                        <h4>${totalGeneralAreaAptos.toFixed(2)}</h4>
                        <p>√Årea Total (ha)</p>
                    </div>
                    <div class="stat-box">
                        <h4>${Object.keys(tomasData).length}</h4>
                        <p>Tomas Analizadas</p>
                    </div>
                </div>

                <div class="contenido-escalable">
                    ${generarMatrizCultivosTomaPrint('aptos', deudaMax)}
                </div>
            </div>

            <!-- ========== HOJA 2: USUARIOS SIN DERECHO DE USO DE RIEGO ========== -->
            <div class="hoja-print">
                <div class="encabezado-hoja">
                    <h2>COMISI√ìN DE USUARIOS DEL SUB SECTOR HIDR√ÅULICO MARGEN IZQUIERDA</h2>
                    <p><strong>CUSSHMI - Unidad de Operaci√≥n y Tarifas</strong></p>
                    <p style="font-size: 10pt; color: #dc3545; margin-top: 5px;">
                        üìã HOJA 2: USUARIOS SIN DERECHO DE USO DE RIEGO (CON DEUDA)
                    </p>
                    <p style="font-size: 7pt;">Deuda M√°xima Permitida: S/ ${deudaMax.toFixed(2)} | 
                       Fecha: ${new Date().toLocaleDateString('es-PE')}</p>
                </div>

                <div class="stats-print">
                    <div class="stat-box">
                        <h4>${totalGeneralNoAptos}</h4>
                        <p>Total Usuarios No Aptos</p>
                    </div>
                    <div class="stat-box">
                        <h4>${totalGeneralAreaNoAptos.toFixed(2)}</h4>
                        <p>√Årea Total (ha)</p>
                    </div>
                    <div class="stat-box">
                        <h4>S/ ${totalGeneralDeuda.toFixed(2)}</h4>
                        <p>Deuda Total</p>
                    </div>
                </div>

                <div class="contenido-escalable">
                    ${generarMatrizCultivosTomaPrint('noAptos', deudaMax)}
                </div>
            </div>

            <!-- ========== HOJA 3: RESUMEN DE DEUDA POR TOMA ========== -->
            <div class="hoja-print">
                <div class="encabezado-hoja">
                    <h2>COMISI√ìN DE USUARIOS DEL SUB SECTOR HIDR√ÅULICO MARGEN IZQUIERDA</h2>
                    <p><strong>CUSSHMI - Unidad de Operaci√≥n y Tarifas</strong></p>
                    <p style="font-size: 10pt; color: #0070c0; margin-top: 5px;">
                        üìã HOJA 3: RESUMEN DE DEUDA Y USUARIOS POR TOMA
                    </p>
                    <p style="font-size: 7pt;">Deuda M√°xima Permitida: S/ ${deudaMax.toFixed(2)} | 
                       Fecha: ${new Date().toLocaleDateString('es-PE')}</p>
                </div>

                <div class="stats-print">
                    <div class="stat-box">
                        <h4>${totalGeneralAptos + totalGeneralNoAptos}</h4>
                        <p>Total Usuarios</p>
                    </div>
                    <div class="stat-box">
                        <h4>S/ ${totalGeneralDeuda.toFixed(2)}</h4>
                        <p>Deuda Total General</p>
                    </div>
                    <div class="stat-box">
                        <h4>${((totalGeneralAreaAptos + totalGeneralAreaNoAptos)).toFixed(2)}</h4>
                        <p>√Årea Total (ha)</p>
                    </div>
                </div>

                <div class="contenido-escalable">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Toma</th>
                                <th>Usuarios Aptos</th>
                                <th>√Årea Aptos (ha)</th>
                                <th>Usuarios No Aptos</th>
                                <th>√Årea No Aptos (ha)</th>
                                <th>Total Usuarios</th>
                                <th>Deuda Total (S/)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tomasResumen.map(toma => `
                                <tr>
                                    <td style="font-weight: bold;">${toma.nombre}</td>
                                    <td style="text-align: center; color: #155724;">${toma.aptos}</td>
                                    <td style="text-align: right;">${toma.areaAptos.toFixed(2)}</td>
                                    <td style="text-align: center; color: #dc3545;">${toma.noAptos}</td>
                                    <td style="text-align: right;">${toma.areaNoAptos.toFixed(2)}</td>
                                    <td style="text-align: center; font-weight: bold;">${toma.total}</td>
                                    <td style="text-align: right; font-weight: bold;">${toma.deuda.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                            <tr class="fila-totales-print">
                                <td style="font-weight: bold;">TOTAL GENERAL</td>
                                <td style="text-align: center;">${totalGeneralAptos}</td>
                                <td style="text-align: right;">${totalGeneralAreaAptos.toFixed(2)}</td>
                                <td style="text-align: center;">${totalGeneralNoAptos}</td>
                                <td style="text-align: right;">${totalGeneralAreaNoAptos.toFixed(2)}</td>
                                <td style="text-align: center;">${totalGeneralAptos + totalGeneralNoAptos}</td>
                                <td style="text-align: right;">${totalGeneralDeuda.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 15px; font-size: 7pt; color: #666; text-align: center; border-top: 1px solid #ccc; padding-top: 10px;">
                    <p><strong>Nota:</strong> Los usuarios no aptos son aquellos con deuda superior a S/ ${deudaMax.toFixed(2)}.</p>
                    <p>Reporte generado el ${new Date().toLocaleString('es-PE')}</p>
                </div>
            </div>

        </div>
    `;

    contentArea.innerHTML = html;
    exportButtons.classList.add('show');

    if (incluirGraficos.checked) {
        generarGraficoConsolidado(tomasResumen);
    }
}
// ========== FUNCI√ìN PARA GENERAR MATRIZ DE CULTIVOS POR TOMA ==========

function generarMatrizCultivosToma(tipo, deudaMax) {
    // Obtener todos los cultivos √∫nicos de todas las tomas
    const todosLosCultivos = new Set();
    const datosPorToma = {};
    
    Object.keys(tomasData).forEach(nombreToma => {
        const usuarios = tomasData[nombreToma];
        const cultivosToma = {};
        
        usuarios.forEach(usuario => {
            if (debeExcluirse(usuario)) return;
            
            const esApto = esUsuarioApto(usuario, deudaMax);
            const incluir = (tipo === 'aptos' && esApto) || (tipo === 'noAptos' && !esApto);
            
            if (!incluir) return;
            
            // Procesar cultivo 1
            if (usuario.cultivo1 && usuario.cultivo1.trim() !== '' && usuario.area1 > 0) {
                const cultivo = usuario.cultivo1.trim();
                todosLosCultivos.add(cultivo);
                cultivosToma[cultivo] = (cultivosToma[cultivo] || 0) + usuario.area1;
            }
            
            // Procesar cultivo 2
            if (usuario.cultivo2 && usuario.cultivo2.trim() !== '' && usuario.area2 > 0) {
                const cultivo = usuario.cultivo2.trim();
                todosLosCultivos.add(cultivo);
                cultivosToma[cultivo] = (cultivosToma[cultivo] || 0) + usuario.area2;
            }
        });
        
        // Solo agregar toma si tiene cultivos de este tipo
        if (Object.keys(cultivosToma).length > 0) {
            datosPorToma[nombreToma] = cultivosToma;
        }
    });
    
    // Convertir a array ordenado
    const cultivosOrdenados = Array.from(todosLosCultivos).sort();
    const tomasConDatos = Object.keys(datosPorToma).sort();
    
    if (tomasConDatos.length === 0) {
        return '<div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666;">No hay datos para mostrar</div>';
    }
    
    // Calcular totales por columna (cultivo)
    const totalesPorCultivo = {};
    let granTotal = 0;
    
    cultivosOrdenados.forEach(cultivo => {
        let suma = 0;
        tomasConDatos.forEach(toma => {
            suma += datosPorToma[toma][cultivo] || 0;
        });
        totalesPorCultivo[cultivo] = suma;
        granTotal += suma;
    });
    
    // Generar HTML de la tabla
    let html = '<table class="report-table" style="font-size: 12px; min-width: 800px;">';
    
    // Encabezado
    html += '<thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">';
    html += '<th style="padding: 10px; min-width: 100px; position: sticky; left: 0; background: #667eea; z-index: 10;">TOMA</th>';
    
    cultivosOrdenados.forEach(cultivo => {
        html += `<th style="padding: 10px; min-width: 80px; text-align: center; white-space: nowrap;">${cultivo}</th>`;
    });
    
    html += '<th style="padding: 10px; min-width: 90px; background: #155724;">TOTAL TOMA</th>';
    html += '</tr></thead>';
    
    // Cuerpo
    html += '<tbody>';
    
    // Filas de datos por toma
    tomasConDatos.forEach((toma, index) => {
    const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
    let totalToma = 0;
    
    html += `<tr style="background-color: ${bgColor};">`;
    html += `<td style="font-weight: bold; font-size: 7.5pt; border-right: 1px solid #333; padding: 2px; text-align: center;">${toma}</td>`;
    
    cultivosGrupo.forEach(cultivo => {
        const area = datosPorToma[toma][cultivo] || 0;
        totalToma += area;
        
        if (area > 0) {
            html += `<td style="text-align: right; color: #000000; font-weight: 600; font-size: 7.5pt; padding: 2px;">${area.toFixed(2)}</td>`;
        } else {
            html += `<td style="text-align: center; color: #999; font-size: 7.5pt; padding: 2px;">-</td>`;
        }
    });
    
    html += `<td style="text-align: right; font-weight: bold; background: #90EE90; color: #000000; font-size: 8pt; padding: 2px;">${totalToma.toFixed(2)}</td>`;
    html += '</tr>';
});

html += '<tr style="background: #228B22; color: #000000; font-weight: bold;">';
html += '<td style="font-size: 8pt; padding: 2px; color: #000000; text-align: center; font-weight: bold;">TOTAL</td>';

cultivosGrupo.forEach(cultivo => {
    const total = totalesPorCultivo[cultivo];
    html += `<td style="text-align: right; font-size: 7.5pt; padding: 2px; color: #000000; font-weight: bold;">${total.toFixed(2)}</td>`;
});

html += `<td style="text-align: right; font-size: 8pt; padding: 2px; background-color: #006400 !important; color: #FFFFFF !important; font-weight: bold;">${granTotal.toFixed(2)}</td>`;
html += '</tr>';
    
    html += '</tbody></table>';
    
    return html;
}
// ========== FUNCI√ìN PARA GENERAR MATRIZ OPTIMIZADA PARA IMPRESI√ìN ==========

function generarMatrizCultivosTomaPrint(tipo, deudaMax) {
    // Obtener todos los cultivos √∫nicos
    const todosLosCultivos = new Set();
    const datosPorToma = {};
    
    Object.keys(tomasData).forEach(nombreToma => {
        const usuarios = tomasData[nombreToma];
        const cultivosToma = {};
        
        usuarios.forEach(usuario => {
            if (debeExcluirse(usuario)) return;
            
            const esApto = esUsuarioApto(usuario, deudaMax);
            const incluir = (tipo === 'aptos' && esApto) || (tipo === 'noAptos' && !esApto);
            
            if (!incluir) return;
            
            if (usuario.cultivo1?.trim() && usuario.area1 > 0) {
                const cultivo = usuario.cultivo1.trim();
                todosLosCultivos.add(cultivo);
                cultivosToma[cultivo] = (cultivosToma[cultivo] || 0) + usuario.area1;
            }
            if (usuario.cultivo2?.trim() && usuario.area2 > 0) {
                const cultivo = usuario.cultivo2.trim();
                todosLosCultivos.add(cultivo);
                cultivosToma[cultivo] = (cultivosToma[cultivo] || 0) + usuario.area2;
            }
        });
        
        if (Object.keys(cultivosToma).length > 0) {
            datosPorToma[nombreToma] = cultivosToma;
        }
    });
    
    const cultivosOrdenados = Array.from(todosLosCultivos).sort();
    
    // ‚úÖ CORREGIDO: Orden espec√≠fico de tomas por grupos (con sub-tomas inmediatamente despu√©s)
const ordenTomas = [
    // GRUPO 1: SD3 a SD8 (con SD8.1 despu√©s de SD8)
    "SD3", "SI3", "SD4", "SI4", "SD5", "SI5", "SD6", "SD7", "SD8", "SD8.1",
    // GRUPO 2: SI6 a SD14.1 (con SD12.1 despu√©s de SD12, SD14.1 despu√©s de SD14)
    "SI6", "SD9", "SD10", "SD11", "SI7", "SD12", "SD12.1", "SD13", "SD14", "SD14.1",
    // GRUPO 3: Agroaurora y Agr√≠cola del Chira
    "AGROAURORA", "AGRICOLA DEL CHIRA"
];
    
    // ‚úÖ NUEVO: Ordenar tomas seg√∫n el orden definido, manteniendo solo las que existen en datos
    const tomasConDatos = [];
    
    // Primero agregar las tomas del orden definido que existen en los datos
    ordenTomas.forEach(tomaOrden => {
        // Buscar si existe esta toma en los datos (coincidencia exacta o parcial)
        const tomaEncontrada = Object.keys(datosPorToma).find(tomaData => {
            const dataUpper = tomaData.toUpperCase().trim();
            const ordenUpper = tomaOrden.toUpperCase().trim();
            return dataUpper === ordenUpper || 
                   dataUpper.includes(ordenUpper) || 
                   ordenUpper.includes(dataUpper);
        });
        
        if (tomaEncontrada && !tomasConDatos.includes(tomaEncontrada)) {
            tomasConDatos.push(tomaEncontrada);
        }
    });
    
    // Si hay tomas en los datos que no est√°n en el orden definido, agregarlas al final
    Object.keys(datosPorToma).forEach(tomaData => {
        if (!tomasConDatos.includes(tomaData)) {
            tomasConDatos.push(tomaData);
        }
    });
    
    if (tomasConDatos.length === 0) {
        return '<div style="padding: 20px; text-align: center; color: #666;">No hay datos disponibles</div>';
    }

    // AUMENTAR A 16 CULTIVOS POR TABLA PARA MEJOR DISTRIBUCI√ìN
    const MAX_CULTIVOS_POR_TABLA = 16;
    const numGrupos = Math.ceil(cultivosOrdenados.length / MAX_CULTIVOS_POR_TABLA);
    
    let htmlTotal = '';
    
    for (let g = 0; g < numGrupos; g++) {
        const inicio = g * MAX_CULTIVOS_POR_TABLA;
        const fin = Math.min((g + 1) * MAX_CULTIVOS_POR_TABLA, cultivosOrdenados.length);
        const cultivosGrupo = cultivosOrdenados.slice(inicio, fin);
        
        // Calcular totales para este grupo
        const totalesPorCultivo = {};
        let granTotal = 0;
        
        cultivosGrupo.forEach(cultivo => {
            let suma = 0;
            tomasConDatos.forEach(toma => {
                suma += datosPorToma[toma][cultivo] || 0;
            });
            totalesPorCultivo[cultivo] = suma;
            granTotal += suma;
        });
        
        // Generar tabla para este grupo
        let html = '<table class="report-table tabla-matriz" style="margin-bottom: 15px;">';
        
        // Encabezado
        html += '<thead><tr>';
        html += '<th style="width: 70px; background: #667eea; color: white; font-size: 7pt; font-weight: bold; vertical-align: middle;">TOMA</th>';
        
        cultivosGrupo.forEach(cultivo => {
            const nombreFormateado = formatearNombreCultivoDosLineas(cultivo);
            
            html += `<th style="
                width: 55px; 
                min-width: 50px;
                background: #667eea; 
                color: white; 
                font-size: 6.5pt; 
                font-weight: bold;
                text-align: center;
                vertical-align: middle;
                line-height: 1.3;
                padding: 4px 2px;
            ">${nombreFormateado}</th>`;
        });
        
        html += '<th style="width: 50px; background: #155724; color: white; font-size: 7pt; font-weight: bold; vertical-align: middle;">TOTAL</th>';
        html += '</tr></thead>';
        
        // Cuerpo - ‚úÖ AHORA EN EL ORDEN DEFINIDO DE GRUPOS
        html += '<tbody>';
        
        tomasConDatos.forEach((toma, index) => {
            const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
            let totalToma = 0;
            
            html += `<tr style="background-color: ${bgColor};">`;
            html += `<td style="font-weight: bold; font-size: 7.5pt; border-right: 1px solid #333; padding: 2px; text-align: center;">${toma}</td>`;
            
            cultivosGrupo.forEach(cultivo => {
                const area = datosPorToma[toma][cultivo] || 0;
                totalToma += area;
                
                if (area > 0) {
                    html += `<td style="text-align: right; color: #000000; font-weight: 600; font-size: 7.5pt; padding: 2px;">${area.toFixed(2)}</td>`;
                } else {
                    html += `<td style="text-align: center; color: #999; font-size: 7.5pt; padding: 2px;">-</td>`;
                }
            });
            
            html += `<td style="text-align: right; font-weight: bold; background: #90EE90; color: #000000; font-size: 8pt; padding: 2px;">${totalToma.toFixed(2)}</td>`;
        });
        
        // Fila de totales
        html += '<tr style="background: #228B22; color: #000000; font-weight: bold;">';
        html += '<td style="font-size: 8pt; padding: 2px; color: #000000; text-align: center; font-weight: bold;">TOTAL</td>';
        
        cultivosGrupo.forEach(cultivo => {
            const total = totalesPorCultivo[cultivo];
            html += `<td style="text-align: right; font-size: 7.5pt; padding: 2px; color: #000000; font-weight: bold;">${total.toFixed(2)}</td>`;
        });
        
        html += `<td style="text-align: right; font-size: 8pt; padding: 2px; background-color: #006400 !important; color: #FFFFFF !important; font-weight: bold;">${granTotal.toFixed(2)}</td>`;
        html += '</tr>';
        
        html += '</tbody></table>';
        
        if (numGrupos > 1) {
            html = `<div style="margin-bottom: 20px;"><p style="font-size: 8pt; color: #666; margin-bottom: 5px;"><strong>Grupo ${g + 1} de ${numGrupos}</strong> (Cultivos ${inicio + 1} - ${fin})</p>${html}</div>`;
        }
        
        htmlTotal += html;
    }
    
    return htmlTotal;
}
// ‚úÖ NUEVA FUNCI√ìN GLOBAL: Obtener tomas ordenadas seg√∫n los 3 grupos
function obtenerTomasOrdenadasPorGrupo(tomasDisponibles) {
    // Orden definido por el usuario
    const ordenTomas = [
        // GRUPO 1: SD3 a SD8 (con SD8.1 despu√©s de SD8)
        "SD3", "SI3", "SD4", "SI4", "SD5", "SI5", "SD6", "SD7", "SD8", "SD8.1",
        // GRUPO 2: SI6 a SD14.1 (con SD12.1 despu√©s de SD12, SD14.1 despu√©s de SD14)
        "SI6", "SD9", "SD10", "SD11", "SI7", "SD12", "SD12.1", "SD13", "SD14", "SD14.1",
        // GRUPO 3: Agroaurora y Agr√≠cola del Chira
        "AGROAURORA", "AGRICOLA DEL CHIRA"
    ];
    
    const tomasOrdenadas = [];
    
    // Primero agregar las tomas del orden definido que existen en los datos
    ordenTomas.forEach(tomaOrden => {
        const tomaEncontrada = tomasDisponibles.find(tomaData => {
            const dataUpper = tomaData.toUpperCase().trim();
            const ordenUpper = tomaOrden.toUpperCase().trim();
            return dataUpper === ordenUpper || 
                   dataUpper.includes(ordenUpper) || 
                   ordenUpper.includes(dataUpper);
        });
        
        if (tomaEncontrada && !tomasOrdenadas.includes(tomaEncontrada)) {
            tomasOrdenadas.push(tomaEncontrada);
        }
    });
    
    // Si hay tomas en los datos que no est√°n en el orden definido, agregarlas al final
    tomasDisponibles.forEach(tomaData => {
        if (!tomasOrdenadas.includes(tomaData)) {
            tomasOrdenadas.push(tomaData);
        }
    });
    
    return tomasOrdenadas;
}

// ========== FUNCI√ìN PARA GENERAR MATRIZ OPTIMIZADA PARA IMPRESI√ìN ==========
function generarMatrizCultivosTomaPrint(tipo, deudaMax) {
    // Obtener todos los cultivos √∫nicos
    const todosLosCultivos = new Set();
    const datosPorToma = {};
    
    Object.keys(tomasData).forEach(nombreToma => {
        const usuarios = tomasData[nombreToma];
        const cultivosToma = {};
        
        usuarios.forEach(usuario => {
            if (debeExcluirse(usuario)) return;
            
            const esApto = esUsuarioApto(usuario, deudaMax);
            const incluir = (tipo === 'aptos' && esApto) || (tipo === 'noAptos' && !esApto);
            
            if (!incluir) return;
            
            if (usuario.cultivo1?.trim() && usuario.area1 > 0) {
                const cultivo = usuario.cultivo1.trim();
                todosLosCultivos.add(cultivo);
                cultivosToma[cultivo] = (cultivosToma[cultivo] || 0) + usuario.area1;
            }
            if (usuario.cultivo2?.trim() && usuario.area2 > 0) {
                const cultivo = usuario.cultivo2.trim();
                todosLosCultivos.add(cultivo);
                cultivosToma[cultivo] = (cultivosToma[cultivo] || 0) + usuario.area2;
            }
        });
        
        if (Object.keys(cultivosToma).length > 0) {
            datosPorToma[nombreToma] = cultivosToma;
        }
    });
    
    const cultivosOrdenados = Array.from(todosLosCultivos).sort();
    
    // ‚úÖ USAR LA NUEVA FUNCI√ìN DE ORDENAMIENTO
    const tomasConDatos = obtenerTomasOrdenadasPorGrupo(Object.keys(datosPorToma));
    
    if (tomasConDatos.length === 0) {
        return '<div style="padding: 20px; text-align: center; color: #666;">No hay datos disponibles</div>';
    }

    // AUMENTAR A 16 CULTIVOS POR TABLA PARA MEJOR DISTRIBUCI√ìN
    const MAX_CULTIVOS_POR_TABLA = 16;
    const numGrupos = Math.ceil(cultivosOrdenados.length / MAX_CULTIVOS_POR_TABLA);
    
    let htmlTotal = '';
    
    for (let g = 0; g < numGrupos; g++) {
        const inicio = g * MAX_CULTIVOS_POR_TABLA;
        const fin = Math.min((g + 1) * MAX_CULTIVOS_POR_TABLA, cultivosOrdenados.length);
        const cultivosGrupo = cultivosOrdenados.slice(inicio, fin);
        
        // Calcular totales para este grupo
        const totalesPorCultivo = {};
        let granTotal = 0;
        
        cultivosGrupo.forEach(cultivo => {
            let suma = 0;
            tomasConDatos.forEach(toma => {
                suma += datosPorToma[toma][cultivo] || 0;
            });
            totalesPorCultivo[cultivo] = suma;
            granTotal += suma;
        });
        
        // Generar tabla para este grupo
        let html = '<table class="report-table tabla-matriz" style="margin-bottom: 15px;">';
        
        // Encabezado
        html += '<thead><tr>';
        html += '<th style="width: 70px; background: #667eea; color: white; font-size: 7pt; font-weight: bold; vertical-align: middle;">TOMA</th>';
        
        cultivosGrupo.forEach(cultivo => {
            const nombreFormateado = formatearNombreCultivoDosLineas(cultivo);
            
            html += `<th style="
                width: 55px; 
                min-width: 50px;
                background: #667eea; 
                color: white; 
                font-size: 6.5pt; 
                font-weight: bold;
                text-align: center;
                vertical-align: middle;
                line-height: 1.3;
                padding: 4px 2px;
            ">${nombreFormateado}</th>`;
        });
        
        html += '<th style="width: 50px; background: #155724; color: white; font-size: 7pt; font-weight: bold; vertical-align: middle;">TOTAL</th>';
        html += '</tr></thead>';
        
        // Cuerpo - AHORA EN EL ORDEN CORRECTO DE GRUPOS
        html += '<tbody>';
        
        tomasConDatos.forEach((toma, index) => {
            const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
            let totalToma = 0;
            
            html += `<tr style="background-color: ${bgColor};">`;
            html += `<td style="font-weight: bold; font-size: 7.5pt; border-right: 1px solid #333; padding: 2px; text-align: center;">${toma}</td>`;
            
            cultivosGrupo.forEach(cultivo => {
                const area = datosPorToma[toma][cultivo] || 0;
                totalToma += area;
                
                if (area > 0) {
                    html += `<td style="text-align: right; color: #000000; font-weight: 600; font-size: 7.5pt; padding: 2px;">${area.toFixed(2)}</td>`;
                } else {
                    html += `<td style="text-align: center; color: #999; font-size: 7.5pt; padding: 2px;">-</td>`;
                }
            });
            
            html += `<td style="text-align: right; font-weight: bold; background: #90EE90; color: #000000; font-size: 8pt; padding: 2px;">${totalToma.toFixed(2)}</td>`;
        });
        
        // Fila de totales
        html += '<tr style="background: #228B22; color: #000000; font-weight: bold;">';
        html += '<td style="font-size: 8pt; padding: 2px; color: #000000; text-align: center; font-weight: bold;">TOTAL</td>';
        
        cultivosGrupo.forEach(cultivo => {
            const total = totalesPorCultivo[cultivo];
            html += `<td style="text-align: right; font-size: 7.5pt; padding: 2px; color: #000000; font-weight: bold;">${total.toFixed(2)}</td>`;
        });
        
        html += `<td style="text-align: right; font-size: 8pt; padding: 2px; background-color: #006400 !important; color: #FFFFFF !important; font-weight: bold;">${granTotal.toFixed(2)}</td>`;
        html += '</tr>';
        
        html += '</tbody></table>';
        
        if (numGrupos > 1) {
            html = `<div style="margin-bottom: 20px;"><p style="font-size: 8pt; color: #666; margin-bottom: 5px;"><strong>Grupo ${g + 1} de ${numGrupos}</strong> (Cultivos ${inicio + 1} - ${fin})</p>${html}</div>`;
        }
        
        htmlTotal += html;
    }
    
    return htmlTotal;
}

// Funci√≥n auxiliar para dividir nombres en dos l√≠neas
function formatearNombreCultivoDosLineas(nombreCultivo) {
    if (!nombreCultivo || nombreCultivo.length <= 8) {
        return nombreCultivo;
    }
    
    const palabras = nombreCultivo.trim().split(/\s+/);
    
    if (palabras.length >= 3) {
        const mitadSuperior = palabras.slice(0, Math.ceil(palabras.length / 2)).join(' ');
        const mitadInferior = palabras.slice(Math.ceil(palabras.length / 2)).join(' ');
        return `${mitadSuperior}<br>${mitadInferior}`;
    }
    
    if (palabras.length === 2) {
        return `${palabras[0]}<br>${palabras[1]}`;
    }
    
    if (nombreCultivo.length > 12) {
        const mitad = Math.ceil(nombreCultivo.length / 2);
        let corte = mitad;
        for (let i = 0; i < 3; i++) {
            if (nombreCultivo[mitad + i] === ' ') {
                corte = mitad + i;
                break;
            }
            if (nombreCultivo[mitad - i] === ' ') {
                corte = mitad - i;
                break;
            }
        }
        return `${nombreCultivo.substring(0, corte)}<br>${nombreCultivo.substring(corte).trim()}`;
    }
    
    return nombreCultivo;
}
// Funci√≥n auxiliar para dividir nombres en dos l√≠neas (mantener la anterior)
function formatearNombreCultivoDosLineas(nombreCultivo) {
    if (!nombreCultivo || nombreCultivo.length <= 8) {
        return nombreCultivo;
    }
    
    const palabras = nombreCultivo.trim().split(/\s+/);
    
    if (palabras.length >= 3) {
        const mitadSuperior = palabras.slice(0, Math.ceil(palabras.length / 2)).join(' ');
        const mitadInferior = palabras.slice(Math.ceil(palabras.length / 2)).join(' ');
        return `${mitadSuperior}<br>${mitadInferior}`;
    }
    
    if (palabras.length === 2) {
        return `${palabras[0]}<br>${palabras[1]}`;
    }
    
    if (nombreCultivo.length > 12) {
        const mitad = Math.ceil(nombreCultivo.length / 2);
        let corte = mitad;
        for (let i = 0; i < 3; i++) {
            if (nombreCultivo[mitad + i] === ' ') {
                corte = mitad + i;
                break;
            }
            if (nombreCultivo[mitad - i] === ' ') {
                corte = mitad - i;
                break;
            }
        }
        return `${nombreCultivo.substring(0, corte)}<br>${nombreCultivo.substring(corte).trim()}`;
    }
    
    return nombreCultivo;
}

// ‚úÖ NUEVA FUNCI√ìN: Divide el nombre del cultivo en dos l√≠neas de manera inteligente
function formatearNombreCultivoDosLineas(nombreCultivo) {
    if (!nombreCultivo || nombreCultivo.length <= 8) {
        // Nombres cortos no necesitan divisi√≥n
        return nombreCultivo;
    }
    
    const palabras = nombreCultivo.trim().split(/\s+/);
    
    // CASO 1: "CA√ëA DE AZUCAR" ‚Üí "CA√ëA DE<br>AZUCAR"
    if (palabras.length >= 3) {
        const mitadSuperior = palabras.slice(0, Math.ceil(palabras.length / 2)).join(' ');
        const mitadInferior = palabras.slice(Math.ceil(palabras.length / 2)).join(' ');
        return `${mitadSuperior}<br>${mitadInferior}`;
    }
    
    // CASO 2: "FRIJOL CHILENO" ‚Üí "FRIJOL<br>CHILENO"
    if (palabras.length === 2) {
        return `${palabras[0]}<br>${palabras[1]}`;
    }
    
    // CASO 3: Una sola palabra larga, dividir por mitad aproximada
    // "BANANO" (corto, no entra aqu√≠ por el if inicial)
    // "ALFALFA" ‚Üí no se divide
    if (nombreCultivo.length > 12) {
        const mitad = Math.ceil(nombreCultivo.length / 2);
        // Buscar el espacio m√°s cercano al centro para no cortar palabras
        let corte = mitad;
        for (let i = 0; i < 3; i++) {
            if (nombreCultivo[mitad + i] === ' ') {
                corte = mitad + i;
                break;
            }
            if (nombreCultivo[mitad - i] === ' ') {
                corte = mitad - i;
                break;
            }
        }
        return `${nombreCultivo.substring(0, corte)}<br>${nombreCultivo.substring(corte).trim()}`;
    }
    
    return nombreCultivo;
}
        function generarGrafico(aptos, noAptos) {
            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('reportChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Usuarios Aptos', 'Usuarios con Deuda'],
                    datasets: [{
                        data: [aptos, noAptos],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Proporci√≥n de Usuarios',
                            font: { size: 16 }
                        }
                    }
                }
            });
        }

        function generarGraficoConsolidado(tomasResumen) {
            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('reportChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tomasResumen.map(t => t.nombre),
                    datasets: [{
                        label: 'Deuda Total (S/)',
                        data: tomasResumen.map(t => t.deuda),
                        backgroundColor: '#0070c0',
                        borderColor: '#005a9c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Deuda Total por Toma',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('btnExportExcel').addEventListener('click', () => {
            const table = document.querySelector('.report-table');
            if (!table) {
                alert('No hay reporte para exportar');
                return;
            }

            const wb = XLSX.utils.book_new();
            const data = XLSX.utils.table_to_sheet(table);
            const ws_data = [];
            
            ws_data.push(['COMISI√ìN DE USUARIOS DEL SUB SECTOR HIDR√ÅULICO MARGEN IZQUIERDA']);
            ws_data.push(['CUSSHMI']);
            ws_data.push(['']);
            ws_data.push(['√ÅREA ENCARGADA: Unidad de Operaci√≥n y Tarifas']);
            ws_data.push(['']);
            ws_data.push(['REPORTE: USUARIOS CON DERECHO DE USO DE AGUA PARA RIEGO']);
            ws_data.push(['Fecha de generaci√≥n: ' + new Date().toLocaleString('es-PE')]);
            ws_data.push(['']);
            
            const range = XLSX.utils.decode_range(data['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const row = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = {c:C, r:R};
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    const cell = data[cell_ref];
                    row.push(cell ? cell.v : '');
                }
                ws_data.push(row);
            }
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            XLSX.writeFile(wb, `Reporte_Riego_${new Date().toISOString().split('T')[0]}.xlsx`);
        });

        document.getElementById('btnExportCSV').addEventListener('click', () => {
            const table = document.querySelector('.report-table');
            if (!table) {
                alert('No hay reporte para exportar');
                return;
            }

            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, `Reporte_${new Date().toISOString().split('T')[0]}.csv`);
        });

        document.getElementById('btnPrint').addEventListener('click', () => {
    // Para el consolidado, usar el contenedor especial de impresi√≥n
    const printContainer = document.getElementById('printContainer');
    
    if (printContainer) {
        // Si existe el contenedor de impresi√≥n (modo consolidado), imprimir solo eso
        const ventanaImpresion = window.open('', '_blank', 'width=1200,height=800');
        
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Reporte Consolidado - CUSSHMI</title>
                <style>
                    @page { size: landscape; margin: 5mm; }
                    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
                    ${document.querySelector('style').innerHTML}
                </style>
            </head>
            <body>
                ${printContainer.outerHTML}
                <script>
                    window.onload = function() { 
                        setTimeout(function() { 
                            window.print(); 
                            setTimeout(function() { window.close(); }, 500);
                        }, 500);
                    };
                <\/script>
            </body>
            </html>
        `);
        
        ventanaImpresion.document.close();
    } else {
        // ‚úÖ NUEVO: Modo normal (reporte individual) - Crear ventana independiente
        const contentArea = document.getElementById('contentArea');
        const tipoReporteSelect = document.getElementById('tipoReporte');
        const tomaSelect = document.getElementById('tomaSelect');
        
        if (!contentArea) {
            alert('No hay contenido para imprimir');
            return;
        }
        
        // Obtener el contenido actual (sin los botones de exportar)
        const contenidoHTML = contentArea.innerHTML;
        
        // Crear ventana de impresi√≥n independiente
        const ventanaImpresion = window.open('', '_blank', 'width=1200,height=800');
        
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Reporte ${tomaSelect?.value || ''} - CUSSHMI</title>
                <meta charset="UTF-8">
                <style>
                    @page { size: landscape; margin: 10mm; }
                    body { 
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                        margin: 0; 
                        padding: 20px; 
                        font-size: 12px;
                    }
                    .header-print {
                        text-align: center;
                        margin-bottom: 20px;
                        border-bottom: 3px solid #0070c0;
                        padding-bottom: 15px;
                    }
                    .header-print h1 {
                        color: #0070c0;
                        font-size: 18px;
                        margin: 0 0 10px 0;
                    }
                    .header-print h2 {
                        color: #333;
                        font-size: 14px;
                        margin: 5px 0;
                    }
                    .header-print p {
                        color: #666;
                        font-size: 11px;
                        margin: 3px 0;
                    }
                    .report-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 15px;
                        font-size: 11px;
                    }
                    .report-table thead {
                        background: #0070c0;
                        color: white;
                    }
                    .report-table th {
                        padding: 8px;
                        text-align: left;
                        font-weight: 600;
                        border: 1px solid #333;
                    }
                    .report-table td {
                        padding: 6px;
                        border: 1px solid #333;
                    }
                    .report-table tbody tr:nth-child(even) {
                        background: #f8f9fa;
                    }
                    .totals-row {
                        background: #fff3cd !important;
                        font-weight: bold;
                    }
                    .badge-success {
                        background: #d4edda;
                        color: #155724;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 10px;
                    }
                    .badge-danger {
                        background: #f8d7da;
                        color: #721c24;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 10px;
                    }
                    .stats-cards, .alert, .chart-container, .excluded-section {
                        display: none !important;
                    }
                    .stats-print {
                        display: flex !important;
                        justify-content: space-between;
                        margin-bottom: 15px;
                        gap: 10px;
                    }
                    .stat-box {
                        flex: 1;
                        text-align: center;
                        padding: 10px;
                        border: 1px solid #333;
                        background: #f8f9fa;
                    }
                    .stat-box h4 {
                        margin: 0;
                        color: #0070c0;
                        font-size: 14px;
                    }
                    .stat-box p {
                        margin: 5px 0 0 0;
                        font-size: 10px;
                    }
                </style>
            </head>
            <body>
                <div class="header-print">
                    <h1>COMISI√ìN DE USUARIOS DEL SUB SECTOR HIDR√ÅULICO MARGEN IZQUIERDA</h1>
                    <h2>CUSSHMI - Unidad de Operaci√≥n y Tarifas</h2>
                    <p><strong>REPORTE:</strong> ${tipoReporteSelect?.value === 'noAptos' ? 'USUARIOS SIN DERECHO DE USO DE RIEGO (CON DEUDA)' : 'USUARIOS CON DERECHO DE USO DE RIEGO'}</p>
                    <p><strong>TOMA:</strong> ${tomaSelect?.value || 'No especificada'}</p>
                    <p><strong>Fecha de generaci√≥n:</strong> ${new Date().toLocaleString('es-PE')}</p>
                </div>
                
                ${contenidoHTML}
                
                <script>
                    window.onload = function() { 
                        setTimeout(function() { 
                            window.print(); 
                            setTimeout(function() { window.close(); }, 500);
                        }, 500);
                    };
                <\/script>
            </body>
            </html>
        `);
        
        ventanaImpresion.document.close();
    }
});

        // ========== FUNCIONES PARA GESTI√ìN DE USUARIOS NO APTOS ==========

        // Variable global para almacenar usuarios no aptos disponibles
        let usuariosNoAptosDisponibles = [];

       function abrirProgramacionNoAptosGrupo() {
    if (!window.datosGrupoActual) {
        alert("No hay grupo seleccionado");
        return;
    }

    const tomasGrupo = window.datosGrupoActual.tomas;
    
    // Crear modal para seleccionar toma espec√≠fica
    const modalHTML = `
        <div id="modalSeleccionarTomaNoAptos" class="modal-overlay active">
            <div class="modal-container" style="max-width: 450px;">
                <h3>üö∞ SELECCIONAR TOMA PARA PROGRAMAR USUARIOS NO APTOS</h3>
                
                <div class="info-text">
                    <strong>Grupo:</strong> ${window.datosGrupoActual.nombreGrupo}<br>
                    Selecciona la toma espec√≠fica de la cual quieres programar usuarios no aptos.
                </div>
                
                <div class="form-group" style="text-align: left; margin: 20px 0;">
                    <label for="selectTomaNoAptos">Toma:</label>
                    <select id="selectTomaNoAptos" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                        <option value="">-- Selecciona una toma --</option>
                        ${tomasGrupo.map(toma => `<option value="${toma}">${toma}</option>`).join('')}
                    </select>
                </div>
                
                <button onclick="confirmarTomaNoAptos()" class="btn btn-primary">
                    ‚úÖ Confirmar
                </button>
                
                <button onclick="cerrarModalTomaNoAptos()" class="btn btn-secondary" style="margin-top: 10px;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}

function cerrarModalTomaNoAptos() {
    const modal = document.getElementById('modalSeleccionarTomaNoAptos');
    if (modal) {
        modal.remove();
    }
}

function confirmarTomaNoAptos() {
    const selectToma = document.getElementById('selectTomaNoAptos');
    const tomaSeleccionada = selectToma.value;
    
    if (!tomaSeleccionada) {
        alert('Por favor selecciona una toma');
        return;
    }
    
    // Cerrar modal
    cerrarModalTomaNoAptos();
    
    // Guardar toma seleccionada para programaci√≥n
    window.tomaNoAptosSeleccionada = tomaSeleccionada;
    
    // Cargar usuarios no aptos de esa toma espec√≠fica
    cargarUsuariosNoAptosPorToma(tomaSeleccionada);
}
function cargarUsuariosNoAptosPorToma(nombreToma) {
    const deudaMax = parseFloat(deudaMinima.value) || 0;
    
    // Buscar la hoja de datos para esta toma
    let usuarios = null;
    for (let hoja in tomasData) {
        if (hoja.toUpperCase().includes(nombreToma.toUpperCase()) || 
            nombreToma.toUpperCase().includes(hoja.toUpperCase())) {
            usuarios = tomasData[hoja];
            break;
        }
    }
    if (!usuarios) usuarios = tomasData[nombreToma];
    
    if (!usuarios) {
        alert(`No se encontraron datos para la toma: ${nombreToma}`);
        return;
    }
    
    // Filtrar usuarios no aptos de esta toma espec√≠fica
    usuariosNoAptosDisponibles = usuarios.filter(u => {
        const tieneDeuda = parseFloat(u.deudaTotal) > 0;
        const noEsApto = !esUsuarioApto(u, deudaMax);
        const noExcluido = !debeExcluirse(u);
        return tieneDeuda && noEsApto && noExcluido;
    });
    
    // Agregar informaci√≥n de la toma a cada usuario
    usuariosNoAptosDisponibles.forEach(u => {
        u._tomaOrigen = nombreToma;
    });
    
    if (usuariosNoAptosDisponibles.length === 0) {
        alert(`No hay usuarios no aptos en la toma: ${nombreToma}`);
        return;
    }
    
    console.log(`Usuarios no aptos encontrados en ${nombreToma}: ${usuariosNoAptosDisponibles.length}`);
    
    // Mostrar paneles con datos de esta toma espec√≠fica
    generarPanelesNoAptosTomaEspecifica(nombreToma);
}
function generarPanelesNoAptosTomaEspecifica(nombreToma) {
    let contenedor = document.getElementById('contenedorPanelesNoAptos');
    
    if (contenedor) {
        contenedor.remove();
    }
    
    contenedor = document.createElement('div');
    contenedor.id = 'contenedorPanelesNoAptos';
    contenedor.style.cssText = 'margin-top: 20px;';
    contentArea.appendChild(contenedor);
    
    let html = '';

    // Panel 1: Programar Usuarios No Aptos (solo de esta toma)
    html += `
        <div class="panel-no-aptos" id="panelNoAptosDisponibles" style="margin-bottom: 20px;">
            <h3>üìã PROGRAMAR USUARIOS NO APTOS - TOMA: <span style="color: #0070c0;">${nombreToma}</span></h3>
            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
                <strong>Grupo:</strong> ${window.datosGrupoActual?.nombreGrupo || ''} | 
                <strong>Toma seleccionada:</strong> ${nombreToma} | 
                <strong>Usuarios no aptos:</strong> ${usuariosNoAptosDisponibles.length}
            </div>
            <input type="text" 
                   id="buscadorNoAptos"
                   placeholder="Buscar por nombre o apellido..."
                   style="width:100%; padding:6px; margin-bottom:10px;"
                   oninput="filtrarNoAptos()">
            <div style="max-height:300px; overflow-y:auto;">
                <table class="report-table" id="tablaNoAptos">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>USUARIO</th>
                            <th>CULTIVO</th>
                            <th>√ÅREA (ha)</th>
                            <th>DEUDA TOTAL</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasNoAptosTomaEspecifica()}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 10px; text-align: center;">
                <button onclick="abrirProgramacionNoAptosGrupo()" 
                    style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; margin-right: 10px;">
                    üîÑ Cambiar de Toma
                </button>
                <button onclick="cerrarPanelNoAptos()" 
                    style="background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
                    ‚ùå Cerrar
                </button>
            </div>
        </div>
    `;

    // Panel 2: Usuarios Programados (de todas las tomas, para referencia)
    html += `
        <div class="panel-programados" id="panelNoAptosProgramados" style="display: ${usuariosProgramados.length > 0 ? 'block' : 'none'};">
            <h3>‚úÖ USUARIOS PROGRAMADOS (Todas las Tomas)</h3>
            <div style="max-height:250px; overflow-y:auto;">
                <table class="report-table" id="tablaProgramados">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>TOMA</th>
                            <th>USUARIO</th>
                            <th>CULTIVO</th>
                            <th>√ÅREA (ha)</th>
                            <th>DEUDA TOTAL</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasProgramadosTodasTomas()}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    contenedor.innerHTML = html;
    
    setTimeout(() => {
        contenedor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}
function cerrarPanelNoAptos() {
    const contenedor = document.getElementById('contenedorPanelesNoAptos');
    if (contenedor) {
        // Animaci√≥n suave de cierre
        contenedor.style.transition = "opacity 0.3s ease";
        contenedor.style.opacity = "0";
        
        setTimeout(() => {
            contenedor.remove();
        }, 300);
    }
    
    // Limpiar la toma seleccionada
    window.tomaNoAptosSeleccionada = null;
    
    console.log("Panel de usuarios no aptos cerrado");
}
function generarFilasNoAptosTomaEspecifica() {
    let html = '';
    let item = 1;

    usuariosNoAptosDisponibles.forEach((usuario, index) => {
        html += `
            <tr data-index="${index}">
                <td>${item}</td>
                <td>${usuario.nombre}</td>
                <td>${usuario.cultivo1 || '-'}</td>
                <td>${(usuario.area1 || 0).toFixed(2)}</td>
                <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                <td>
                    <button onclick="programarUsuarioTomaEspecifica(${index})"
                        style="background:#0070c0;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                        Seleccionar
                    </button>
                </td>
            </tr>
        `;
        item++;
    });

    return html;
}

function generarFilasProgramadosTodasTomas() {
    let html = '';
    let item = 1;

    // Mostrar todos los usuarios programados, agrupados por toma
    const programadosPorToma = {};
    usuariosProgramados.forEach(u => {
        const toma = u._tomaOrigen || 'SIN TOMA';
        if (!programadosPorToma[toma]) programadosPorToma[toma] = [];
        programadosPorToma[toma].push(u);
    });

    Object.keys(programadosPorToma).sort().forEach(toma => {
        programadosPorToma[toma].forEach((usuario, idx) => {
            const globalIndex = usuariosProgramados.findIndex(u => u === usuario);
            html += `
                <tr data-index="${globalIndex}" style="${toma === window.tomaNoAptosSeleccionada ? 'background: #e3f2fd;' : ''}">
                    <td>${item}</td>
                    <td><strong>${toma}</strong></td>
                    <td>${usuario.nombre}</td>
                    <td>${usuario.cultivo1 || '-'}</td>
                    <td>${(usuario.area1 || 0).toFixed(2)}</td>
                    <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                    <td>
                        <button onclick="deshacerProgramacionTomaEspecifica(${globalIndex})"
                            style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                            Deshacer
                        </button>
                    </td>
                </tr>
            `;
            item++;
        });
    });

    return html;
}
function programarUsuarioTomaEspecifica(index) {
    const usuario = usuariosNoAptosDisponibles[index];
    
    // ‚úÖ ASEGURAR QUE TENGA REFERENCIA A LA TOMA
    if (!usuario._tomaOrigen) {
        usuario._tomaOrigen = window.tomaNoAptosSeleccionada || window.tomaActualSeleccionada;
    }
    
    // Agregar a programados
    usuariosProgramados.push(usuario);
    
    // Quitar de disponibles
    usuariosNoAptosDisponibles.splice(index, 1);
    
    // Actualizar paneles
    actualizarPanelesNoAptosTomaEspecifica();
    
    // Actualizar el √°rea en la tabla principal
    actualizarAreaEnTablaPrincipal(usuario, 'sumar');
    
    console.log(`‚úÖ Usuario ${usuario.nombre} programado en toma ${usuario._tomaOrigen}, cultivo ${usuario.cultivo1}`);
    console.log(`   Total usuarios programados en ${usuario._tomaOrigen}:`, 
        usuariosProgramados.filter(u => u._tomaOrigen === usuario._tomaOrigen).length);
}

function deshacerProgramacionTomaEspecifica(index) {
    const usuario = usuariosProgramados[index];
    
    // Devolver a disponibles solo si es la misma toma que estamos viendo
    if (usuario._tomaOrigen === window.tomaNoAptosSeleccionada) {
        usuariosNoAptosDisponibles.push(usuario);
    }
    
    // Quitar de programados
    usuariosProgramados.splice(index, 1);
    
    // Actualizar paneles
    actualizarPanelesNoAptosTomaEspecifica();
    
    // ‚úÖ ACTUALIZAR SOLO LA FILA CORRESPONDIENTE EN LA TABLA PRINCIPAL
    actualizarAreaEnTablaPrincipal(usuario, 'restar');
    
    // Limpiar m√≥dulo y eficiencia si el √°rea queda en cero
    limpiarModuloYEficienciaTomaEspecifica(usuario.cultivo1, usuario._tomaOrigen);
}

function actualizarPanelesNoAptosTomaEspecifica() {
    // Actualizar tabla de disponibles (solo si hay usuarios en la toma actual)
    const tbodyDisponibles = document.querySelector('#tablaNoAptos tbody');
    if (tbodyDisponibles) {
        tbodyDisponibles.innerHTML = generarFilasNoAptosTomaEspecifica();
    }

    // Actualizar tabla de programados
    const panelProgramados = document.getElementById('panelNoAptosProgramados');
    const tbodyProgramados = document.querySelector('#tablaProgramados tbody');
    
    if (usuariosProgramados.length > 0) {
        panelProgramados.style.display = 'block';
        if (tbodyProgramados) {
            tbodyProgramados.innerHTML = generarFilasProgramadosTodasTomas();
        }
    } else {
        panelProgramados.style.display = 'none';
    }
    
    // Actualizar contador en el panel
    const contadorDiv = document.querySelector('#panelNoAptosDisponibles div[style*="background: #fff3cd"]');
    if (contadorDiv) {
        contadorDiv.innerHTML = `
            <strong>Grupo:</strong> ${window.datosGrupoActual?.nombreGrupo || ''} | 
            <strong>Toma seleccionada:</strong> ${window.tomaNoAptosSeleccionada} | 
            <strong>Usuarios no aptos:</strong> ${usuariosNoAptosDisponibles.length}
        `;
    }
}

function actualizarAreaEnTablaPrincipal(usuario, operacion) {
    // Buscar la fila espec√≠fica en la tabla principal del grupo
    const filas = document.querySelectorAll("#tablaAvanceSiembraGrupo tbody tr");
    
    let filaEncontrada = null;
    
    filas.forEach(fila => {
        const tomaFila = fila.getAttribute('data-toma');
        const cultivoFila = fila.querySelector(".cultivo-nombre")?.innerText.trim();
        
        // Debe coincidir exactamente la toma y el cultivo
        if (tomaFila === usuario._tomaOrigen && cultivoFila === usuario.cultivo1) {
            filaEncontrada = fila;
        }
    });
    
    if (!filaEncontrada) {
        console.warn(`No se encontr√≥ fila para toma ${usuario._tomaOrigen} y cultivo ${usuario.cultivo1}`);
        return;
    }
    
    const inputArea = filaEncontrada.querySelector(".area-semana");
    let areaActual = parseFloat(inputArea.value) || 0;
    const areaOriginal = parseFloat(filaEncontrada.getAttribute('data-area-original')) || 0;
    
    if (operacion === 'sumar') {
        areaActual += (usuario.area1 || 0);
    } else if (operacion === 'restar') {
        areaActual -= (usuario.area1 || 0);
        // No permitir bajar del √°rea original (usuarios aptos)
        if (areaActual < areaOriginal) areaActual = areaOriginal;
    }
    
    inputArea.value = areaActual.toFixed(2);
    
   // ‚úÖ CAMBIAR COLOR DE FONDO DE LA FILA SEG√öN EL √ÅREA
    const fila = inputArea.closest('tr');
    
    if (areaActual > 0) {
        // Si tiene √°rea, fondo blanco (como las filas normales)
        fila.style.backgroundColor = "white";
        fila.classList.remove('totals-row'); // Quitar clase de alerta si existe
    } else {
        // Si no tiene √°rea, mantener fondo de alerta
        fila.style.backgroundColor = "#fff3cd"; // Color amarillo de alerta
    }
    
    // Mantener readonly siempre, solo cambiar estilos visuales
inputArea.readOnly = true;
if (areaActual > areaOriginal) {
    // Tiene usuarios programados adicionales - destacar en azul
    inputArea.style.background = "#e3f2fd"; // Azul claro
    inputArea.style.color = "#0070c0"; // Azul
    inputArea.style.fontWeight = "bold";
    inputArea.style.cursor = "not-allowed";
} else {
    // Solo √°rea original - estilo normal
    inputArea.style.background = areaOriginal === 0 ? "#eee" : "#f8f9fa";
    inputArea.style.color = "black";
    inputArea.style.fontWeight = "normal";
    inputArea.style.cursor = "not-allowed";
}
    
    // Recalcular vol√∫menes y caudal
    recalcularAvance(inputArea);
    
    console.log(`√Årea actualizada en ${usuario._tomaOrigen} - ${usuario.cultivo1}: ${areaActual.toFixed(2)} ha`);
}

function limpiarModuloYEficienciaTomaEspecifica(nombreCultivo, nombreToma) {
    const filas = document.querySelectorAll('#tablaAvanceSiembraGrupo tbody tr');
    
    filas.forEach(fila => {
        const tomaFila = fila.getAttribute('data-toma');
        const cultivoFila = fila.querySelector('.cultivo-nombre')?.innerText.trim();
        const areaOriginal = parseFloat(fila.getAttribute('data-area-original')) || 0;
        
        if (tomaFila === nombreToma && cultivoFila === nombreCultivo) {
            const inputArea = fila.querySelector('.area-semana');
            const areaActual = parseFloat(inputArea?.value) || 0;
            
            // Solo limpiar si el √°rea volvi√≥ al valor original (sin usuarios programados adicionales)
            if (areaActual <= areaOriginal) {
                const inputModulo = fila.querySelector('.modulo');
                const inputEficiencia = fila.querySelector('.eficiencia');
                
                if (inputModulo) inputModulo.value = "";
                if (inputEficiencia) inputEficiencia.value = "";
                
                recalcularAvance(inputArea);
            }
        }
    });
}
       function generarPanelesNoAptos() {
    // Buscar si ya existe el contenedor de paneles
    let contenedor = document.getElementById('contenedorPanelesNoAptos');
    
    // Si existe, eliminarlo para recrearlo limpio
    if (contenedor) {
        contenedor.remove();
    }
    
    // Crear nuevo contenedor de paneles
    contenedor = document.createElement('div');
    contenedor.id = 'contenedorPanelesNoAptos';
    contenedor.style.cssText = 'margin-top: 20px;';
    
    // AGREGAR AL FINAL DEL CONTENT AREA (DESPU√âS DE TODO LO DEM√ÅS)
    contentArea.appendChild(contenedor);
    
    let html = '';

    // Panel 1: Programar Usuarios No Aptos
    html += `
        <div class="panel-no-aptos" id="panelNoAptosDisponibles" style="margin-bottom: 20px;">
            <h3>üìã PROGRAMAR USUARIOS NO APTOS</h3>
            <input type="text" 
                   id="buscadorNoAptos"
                   placeholder="Buscar por nombre o apellido..."
                   style="width:100%; padding:6px; margin-bottom:10px;"
                   oninput="filtrarNoAptos()">
            <div style="max-height:250px; overflow-y:auto;">
                <table class="report-table" id="tablaNoAptos">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>USUARIO</th>
                            <th>CULTIVO</th>
                            <th>√ÅREA (ha)</th>
                            <th>DEUDA TOTAL</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasNoAptosDisponibles()}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // Panel 2: Usuarios No Aptos Programados para Riego
    html += `
        <div class="panel-programados" id="panelNoAptosProgramados" style="display: ${usuariosProgramados.length > 0 ? 'block' : 'none'};">
            <h3>‚úÖ USUARIOS NO APTOS PROGRAMADOS PARA RIEGO</h3>
            <div style="max-height:250px; overflow-y:auto;">
                <table class="report-table" id="tablaProgramados">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>USUARIO</th>
                            <th>CULTIVO</th>
                            <th>√ÅREA (ha)</th>
                            <th>DEUDA TOTAL</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasNoAptosProgramados()}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    contenedor.innerHTML = html;
    
    // Hacer scroll suave hacia los paneles
    setTimeout(() => {
        contenedor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}
function generarPanelesNoAptosGrupo() {
    let contenedor = document.getElementById('contenedorPanelesNoAptos');
    
    if (contenedor) {
        contenedor.remove();
    }
    
    contenedor = document.createElement('div');
    contenedor.id = 'contenedorPanelesNoAptos';
    contenedor.style.cssText = 'margin-top: 20px;';
    contentArea.appendChild(contenedor);
    
    let html = '';

    // Panel 1: Programar Usuarios No Aptos
    html += `
        <div class="panel-no-aptos" id="panelNoAptosDisponibles" style="margin-bottom: 20px;">
            <h3>üìã PROGRAMAR USUARIOS NO APTOS - GRUPO: ${window.datosGrupoActual?.nombreGrupo || ''}</h3>
            <input type="text" 
                   id="buscadorNoAptos"
                   placeholder="Buscar por nombre, apellido o toma..."
                   style="width:100%; padding:6px; margin-bottom:10px;"
                   oninput="filtrarNoAptos()">
            <div style="max-height:300px; overflow-y:auto;">
                <table class="report-table" id="tablaNoAptos">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>TOMA</th>
                            <th>USUARIO</th>
                            <th>CULTIVO</th>
                            <th>√ÅREA (ha)</th>
                            <th>DEUDA TOTAL</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasNoAptosDisponiblesGrupo()}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // Panel 2: Usuarios No Aptos Programados
    html += `
        <div class="panel-programados" id="panelNoAptosProgramados" style="display: ${usuariosProgramados.length > 0 ? 'block' : 'none'};">
            <h3>‚úÖ USUARIOS NO APTOS PROGRAMADOS PARA RIEGO</h3>
            <div style="max-height:250px; overflow-y:auto;">
                <table class="report-table" id="tablaProgramados">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>TOMA</th>
                            <th>USUARIO</th>
                            <th>CULTIVO</th>
                            <th>√ÅREA (ha)</th>
                            <th>DEUDA TOTAL</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generarFilasNoAptosProgramadosGrupo()}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    contenedor.innerHTML = html;
    
    setTimeout(() => {
        contenedor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

function generarFilasNoAptosDisponiblesGrupo() {
    let html = '';
    let item = 1;

    usuariosNoAptosDisponibles.forEach((usuario, index) => {
        html += `
            <tr data-index="${index}">
                <td>${item}</td>
                <td><strong>${usuario._tomaOrigen || '-'}</strong></td>
                <td>${usuario.nombre}</td>
                <td>${usuario.cultivo1 || '-'}</td>
                <td>${(usuario.area1 || 0).toFixed(2)}</td>
                <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                <td>
                    <button onclick="programarUsuarioGrupo(${index})"
                        style="background:#0070c0;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                        Seleccionar
                    </button>
                </td>
            </tr>
        `;
        item++;
    });

    return html;
}

function generarFilasNoAptosProgramadosGrupo() {
    let html = '';
    let item = 1;

    usuariosProgramados.forEach((usuario, index) => {
        html += `
            <tr data-index="${index}">
                <td>${item}</td>
                <td><strong>${usuario._tomaOrigen || '-'}</strong></td>
                <td>${usuario.nombre}</td>
                <td>${usuario.cultivo1 || '-'}</td>
                <td>${(usuario.area1 || 0).toFixed(2)}</td>
                <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                <td>
                    <button onclick="deshacerProgramacionGrupo(${index})"
                        style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                        Deshacer
                    </button>
                </td>
            </tr>
        `;
        item++;
    });

    return html;
}
function programarUsuarioGrupo(index) {
    const usuario = usuariosNoAptosDisponibles[index];
    
    // ‚úÖ ASEGURAR QUE TENGA REFERENCIA A LA TOMA
    if (!usuario._tomaOrigen) {
        usuario._tomaOrigen = usuario._tomaOrigen || window.tomaActualSeleccionada;
    }
    
    usuariosProgramados.push(usuario);
    usuariosNoAptosDisponibles.splice(index, 1);

    actualizarTablasNoAptosGrupo();
    actualizarAreaEnAvanceSiembraGrupo(usuario, 'sumar');
    
    console.log(`‚úÖ Usuario ${usuario.nombre} programado en toma ${usuario._tomaOrigen}`);
}

function deshacerProgramacionGrupo(index) {
    const usuario = usuariosProgramados[index];
    usuariosNoAptosDisponibles.push(usuario);
    usuariosProgramados.splice(index, 1);

    actualizarTablasNoAptosGrupo();
    actualizarAreaEnAvanceSiembraGrupo(usuario, 'restar');
    limpiarModuloYEficienciaSiEsNecesarioGrupo(usuario.cultivo1, usuario._tomaOrigen);
}

function actualizarTablasNoAptosGrupo() {
    const tbodyDisponibles = document.querySelector('#tablaNoAptos tbody');
    if (tbodyDisponibles) {
        tbodyDisponibles.innerHTML = generarFilasNoAptosDisponiblesGrupo();
    }

    const panelProgramados = document.getElementById('panelNoAptosProgramados');
    const tbodyProgramados = document.querySelector('#tablaProgramados tbody');
    
    if (usuariosProgramados.length > 0) {
        panelProgramados.style.display = 'block';
        if (tbodyProgramados) {
            tbodyProgramados.innerHTML = generarFilasNoAptosProgramadosGrupo();
        }
    } else {
        panelProgramados.style.display = 'none';
    }
}

function actualizarAreaEnAvanceSiembraGrupo(usuario, operacion) {
    // Buscar la fila que corresponde a la toma y cultivo del usuario
    const filas = document.querySelectorAll("#tablaAvanceSiembraGrupo tbody tr");

    filas.forEach(fila => {
        const tomaFila = fila.getAttribute('data-toma');
        const cultivoFila = fila.querySelector(".cultivo-nombre")?.innerText.trim();
        
        // Verificar que coincida la toma y el cultivo
        if (tomaFila === usuario._tomaOrigen && cultivoFila === usuario.cultivo1) {
            const inputArea = fila.querySelector(".area-semana");
            let areaActual = parseFloat(inputArea.value) || 0;
            
            if (operacion === 'sumar') {
                areaActual += (usuario.area1 || 0);
            } else if (operacion === 'restar') {
                areaActual -= (usuario.area1 || 0);
                if (areaActual < 0) areaActual = 0;
            }
            
            inputArea.value = areaActual.toFixed(2);
            
            // Mantener siempre readonly
inputArea.readOnly = true;
if (areaActual > 0) {
    inputArea.style.background = "#f8f9fa";
    inputArea.style.cursor = "not-allowed";
} else {
    inputArea.style.background = "#eee";
    inputArea.style.cursor = "not-allowed";
}
            
            recalcularAvance(inputArea);
        }
    });
}

function limpiarModuloYEficienciaSiEsNecesarioGrupo(nombreCultivo, nombreToma) {
    const filas = document.querySelectorAll('#tablaAvanceSiembraGrupo tbody tr');
    
    filas.forEach(fila => {
        const tomaFila = fila.getAttribute('data-toma');
        const cultivoFila = fila.querySelector('.cultivo-nombre')?.innerText.trim();
        
        if (tomaFila === nombreToma && cultivoFila === nombreCultivo) {
            const inputArea = fila.querySelector('.area-semana');
            const areaActual = parseFloat(inputArea?.value) || 0;
            
            if (areaActual <= areaOriginal) {
                const inputModulo = fila.querySelector('.modulo');
                const inputEficiencia = fila.querySelector('.eficiencia');
                
                if (inputModulo) inputModulo.value = "";
                if (inputEficiencia) inputEficiencia.value = "";
                
                // ‚úÖ RESTAURAR COLOR DE ALERTA SI EL √ÅREA VOLVI√ì A CERO
                if (areaActual === 0) {
                    fila.style.backgroundColor = "#fff3cd"; // Amarillo de alerta
                    fila.classList.add('totals-row');
                }
                
                recalcularAvance(inputArea);
            }
        }
    });
}
        function generarFilasNoAptosDisponibles() {
            let html = '';
            let item = 1;

            usuariosNoAptosDisponibles.forEach((usuario, index) => {
                html += `
                    <tr data-index="${index}">
                        <td>${item}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.cultivo1 || '-'}</td>
                        <td>${(usuario.area1 || 0).toFixed(2)}</td>
                        <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                        <td>
                            <button onclick="programarUsuario(${index})"
                                style="background:#0070c0;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                                Seleccionar
                            </button>
                        </td>
                    </tr>
                `;
                item++;
            });

            return html;
        }

        function generarFilasNoAptosProgramados() {
            let html = '';
            let item = 1;

            usuariosProgramados.forEach((usuario, index) => {
                html += `
                    <tr data-index="${index}">
                        <td>${item}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.cultivo1 || '-'}</td>
                        <td>${(usuario.area1 || 0).toFixed(2)}</td>
                        <td>S/ ${(usuario.deudaTotal || 0).toFixed(2)}</td>
                        <td>
                            <button onclick="deshacerProgramacion(${index})"
                                style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                                Deshacer
                            </button>
                        </td>
                    </tr>
                `;
                item++;
            });

            return html;
        }

        function programarUsuario(index) {
            // Mover usuario de disponibles a programados
            const usuario = usuariosNoAptosDisponibles[index];
            usuariosProgramados.push(usuario);
            usuariosNoAptosDisponibles.splice(index, 1);

            // Actualizar ambas tablas
            actualizarTablasNoAptos();

            // Actualizar el √°rea en la tabla de avance de siembra
            actualizarAreaEnAvanceSiembra(usuario, 'sumar');
        }

        function deshacerProgramacion(index) {
    // Mover usuario de programados a disponibles
    const usuario = usuariosProgramados[index];
    usuariosNoAptosDisponibles.push(usuario);
    usuariosProgramados.splice(index, 1);

    // Actualizar ambas tablas
    actualizarTablasNoAptos();

    // Actualizar el √°rea en la tabla de avance de siembra
    actualizarAreaEnAvanceSiembra(usuario, 'restar');
    
    // LIMPIAR M√ìDULO Y EFICIENCIA SI EL √ÅREA QUEDA EN CERO O MENOR
    limpiarModuloYEficienciaSiEsNecesario(usuario.cultivo1);
}

        function actualizarTablasNoAptos() {
            // Actualizar tabla de disponibles
            const tbodyDisponibles = document.querySelector('#tablaNoAptos tbody');
            if (tbodyDisponibles) {
                tbodyDisponibles.innerHTML = generarFilasNoAptosDisponibles();
            }

            // Actualizar tabla de programados
            const panelProgramados = document.getElementById('panelNoAptosProgramados');
            const tbodyProgramados = document.querySelector('#tablaProgramados tbody');
            
            if (usuariosProgramados.length > 0) {
                panelProgramados.style.display = 'block';
                if (tbodyProgramados) {
                    tbodyProgramados.innerHTML = generarFilasNoAptosProgramados();
                }
            } else {
                panelProgramados.style.display = 'none';
            }
        }

        function actualizarAreaEnAvanceSiembra(usuario, operacion) {
    const filasCultivos = document.querySelectorAll(".avance-siembra tbody tr");

    filasCultivos.forEach(fila => {
        const nombreCultivo = fila.querySelector(".cultivo-nombre")?.innerText.trim();
        
        if (nombreCultivo === usuario.cultivo1) {
            const inputArea = fila.querySelector(".area-semana");
            let areaActual = parseFloat(inputArea.value) || 0;
            
            if (operacion === 'sumar') {
                areaActual += (usuario.area1 || 0);
            } else if (operacion === 'restar') {
                areaActual -= (usuario.area1 || 0);
                if (areaActual < 0) areaActual = 0;
            }
            
            inputArea.value = areaActual.toFixed(2);
            
            // Mantener siempre readonly
inputArea.readOnly = true;
if (areaActual > 0) {
    inputArea.style.background = "#f8f9fa";
    inputArea.style.cursor = "not-allowed";
} else {
    inputArea.style.background = "#eee";
    inputArea.style.cursor = "not-allowed";
    
    // LIMPIAR M√ìDULO Y EFICIENCIA CUANDO EL √ÅREA QUEDA EN CERO
    const inputModulo = fila.querySelector(".modulo");
    const inputEficiencia = fila.querySelector(".eficiencia");
    
    if (inputModulo) inputModulo.value = "";
    if (inputEficiencia) inputEficiencia.value = "";
    
    // Recalcular para actualizar vol√∫menes y caudal a cero
    recalcularAvance(inputArea);
}
            
            // Recalcular caudal te√≥rico solo si no se hizo arriba
            if (areaActual > 0) {
                recalcularAvance(inputArea);
            }
        }
    });
}

        function filtrarNoAptosTomaSimple() {
    const texto = document.getElementById("buscadorNoAptos").value.toLowerCase();
    const filas = document.querySelectorAll("#tablaNoAptos tbody tr");

    filas.forEach(fila => {
        const nombre = fila.children[1].innerText.toLowerCase();
        fila.style.display = nombre.includes(texto) ? "" : "none";
    });
}

        function mostrarMensaje(tipo, mensaje) {
            const clase = tipo === 'success' ? 'alert-success' : tipo === 'error' ? 'alert-warning' : 'alert-info';
            const html = `<div class="alert ${clase}">${mensaje}</div>`;
            
            const alertDiv = document.createElement('div');
            alertDiv.innerHTML = html;
            contentArea.insertBefore(alertDiv.firstChild, contentArea.firstChild);
            
            setTimeout(() => {
                const alert = contentArea.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }
// ========== FUNCIONES PARA SELECCI√ìN DE GRUPOS ==========

function mostrarSelectorDeGrupos() {
    // LIMPIAR DATOS PREVIOS AL CAMBIAR DE GRUPO
    limpiarDatosPrevios();
    
    // ‚úÖ NUEVO: Resetear toma pendiente para forzar selecci√≥n de toma espec√≠fica despu√©s
    tomaPendiente = null;
    
    const modalHTML = `
        <div id="modalSelectorGrupos" class="modal-overlay active">
            <div class="modal-container" style="max-width: 500px;">
                <h3>üìã SELECCIONAR GRUPO DE TOMAS</h3>
                
                <div class="info-text">
                    Selecciona el grupo de tomas que deseas programar para la semana del 
                    <strong>${formatearFecha(semanaPDA.fechaInicio)}</strong> al 
                    <strong>${formatearFecha(semanaPDA.fechaFin)}</strong>.
                </div>
                
                <div style="text-align: left; margin: 20px 0;">
                    <button onclick="seleccionarGrupo(1)" class="btn btn-primary" style="margin-bottom: 10px; width: 100%;">
                        üèûÔ∏è GRUPO 1 (SD3 - SD8)
                    </button>
                    <button onclick="seleccionarGrupo(2)" class="btn btn-primary" style="margin-bottom: 10px; width: 100%;">
                        üèûÔ∏è GRUPO 2 (SD8.1 - SD14.1)
                    </button>
                    <button onclick="seleccionarGrupo(3)" class="btn btn-primary" style="margin-bottom: 10px; width: 100%;">
                        üåä GRUPO 3 (R√çO CHIRA)
                    </button>
                </div>
                
                <button onclick="cerrarModalGrupos()" class="btn btn-secondary" style="width: 100%;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    `;
    
    // Agregar modal al body
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}

function seleccionarGrupo(numeroGrupo) {
    // Cerrar modal de grupos
    const modalGrupos = document.getElementById('modalSelectorGrupos');
    if (modalGrupos) {
        modalGrupos.remove();
    }
    
    // Definir tomas seg√∫n el grupo seleccionado
    let tomasGrupo = [];
    let nombreGrupo = "";
    
    switch(numeroGrupo) {
        case 1:
            tomasGrupo = ["SD3", "SI3", "SD4", "SI4", "SD5", "SI5", "SD6", "SD7", "SD8"];
            nombreGrupo = "GRUPO 1 (SD3 - SD8)";
            break;
        case 2:
            tomasGrupo = ["SD8.1", "SI6", "SD9", "SD10", "SD11", "SI7", "SD12", "SD12.1", "SD13", "SD14", "SD14.1"];
            nombreGrupo = "GRUPO 2 (SD8.1 - SD14.1)";
            break;
        case 3:
            tomasGrupo = ["AGROAURORA", "AGRICOLA DEL CHIRA"];
            nombreGrupo = "GRUPO 3 (R√çO CHIRA)";
            break;
    }
    
    // ‚úÖ SOLO limpiar usuarios programados de toma anterior, NUNCA el consolidado
    if (window.tomaActualSeleccionada) {
        limpiarUsuariosProgramadosDeToma(window.tomaActualSeleccionada);
    }
    
    // ‚úÖ Solo regenerar Anexo G2 si cambia de grupo, pero mantener consolidado
    if (window.grupoSeleccionado && window.grupoSeleccionado.numero !== numeroGrupo) {
        datosAnexoG2 = []; // Forzar regeneraci√≥n del Anexo G2
        console.log("üîÑ Cambio de grupo detectado. Anexo G2 se regenerar√°. Consolidado preservado con", consolidadoDemandas.length, "tomas.");
    }
    
    // GUARDAR DATOS DEL GRUPO SELECCIONADO
    window.grupoSeleccionado = {
        numero: numeroGrupo,
        nombre: nombreGrupo,
        tomas: tomasGrupo
    };
    
    // ‚úÖ NUEVO FLUJO: Mostrar selector de toma espec√≠fica del grupo
    mostrarSelectorDeTomaEspecifica(tomasGrupo, nombreGrupo);
}

function mostrarSelectorDeTomaEspecifica(tomasGrupo, nombreGrupo) {
    // Crear opciones del select con las tomas del grupo
    let opcionesTomas = tomasGrupo.map(toma => {
        // Verificar si hay datos disponibles para esta toma
        let tieneDatos = false;
        for (let hoja in tomasData) {
            if (hoja.toUpperCase().includes(toma.toUpperCase()) || 
                toma.toUpperCase().includes(hoja.toUpperCase()) ||
                hoja === toma) {
                tieneDatos = true;
                break;
            }
        }
        
        const estado = tieneDatos ? '‚úÖ' : '‚ö†Ô∏è';
        const color = tieneDatos ? '' : 'style="color: #999;"';
        return `<option value="${toma}" ${!tieneDatos ? 'disabled' : ''} ${color}>${estado} ${toma}</option>`;
    }).join('');
    
    const modalHTML = `
        <div id="modalSelectorTomaEspecifica" class="modal-overlay active">
            <div class="modal-container" style="max-width: 450px;">
                <h3>üö∞ SELECCIONAR TOMA ESPEC√çFICA</h3>
                
                <div class="info-text">
                    <strong>Grupo:</strong> ${nombreGrupo}<br>
                    <strong>Semana:</strong> ${formatearFecha(semanaPDA.fechaInicio)} al ${formatearFecha(semanaPDA.fechaFin)}<br>
                    Selecciona la toma espec√≠fica que deseas programar.
                </div>
                
                <div class="form-group" style="text-align: left; margin: 20px 0;">
                    <label for="selectTomaEspecificaFinal">Toma:</label>
                    <select id="selectTomaEspecificaFinal" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;">
                        <option value="">-- Selecciona una toma --</option>
                        ${opcionesTomas}
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ‚úÖ = Datos disponibles | ‚ö†Ô∏è = Sin datos cargados
                    </small>
                </div>
                
                <button onclick="confirmarTomaEspecificaFinal()" class="btn btn-primary" style="width: 100%;">
                    ‚úÖ Confirmar y Generar Reporte
                </button>
                
                <button onclick="cerrarModalTomaEspecifica()" class="btn btn-secondary" style="margin-top: 10px; width: 100%;">
                    ‚ùå Cancelar
                </button>
                
                <button onclick="volverASeleccionDeGrupo()" class="btn btn-secondary" style="margin-top: 10px; width: 100%; background: #6c757d;">
                    ‚¨ÖÔ∏è Volver a Selecci√≥n de Grupo
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}

function cerrarModalTomaEspecifica() {
    const modal = document.getElementById('modalSelectorTomaEspecifica');
    if (modal) {
        modal.remove();
    }
}

function volverASeleccionDeGrupo() {
    cerrarModalTomaEspecifica();
    setTimeout(() => {
        mostrarSelectorDeGrupos();
    }, 100);
}

function confirmarTomaEspecificaFinal() {
    const selectToma = document.getElementById('selectTomaEspecificaFinal');
    const tomaSeleccionada = selectToma.value;
    
    if (!tomaSeleccionada) {
        alert('Por favor selecciona una toma');
        return;
    }
    
    // ‚úÖ CORRECCI√ìN: Buscar la hoja EXACTA con prioridad a las m√°s espec√≠ficas
    let hojaEncontrada = null;
    
    // Primero buscar coincidencia EXACTA
    if (tomasData[tomaSeleccionada]) {
        hojaEncontrada = tomaSeleccionada;
    } else {
        // Buscar coincidencias y ordenar por longitud (m√°s espec√≠ficas primero)
        const hojasCoincidentes = [];
        
        for (let hoja in tomasData) {
            const hojaUpper = hoja.toUpperCase().trim();
            const tomaUpper = tomaSeleccionada.toUpperCase().trim();
            
            if (hojaUpper === tomaUpper || 
                hojaUpper.includes(tomaUpper) || 
                tomaUpper.includes(hojaUpper)) {
                hojasCoincidentes.push(hoja);
            }
        }
        
        // Ordenar por longitud descendente (SD8.1 > SD8, SD12.1 > SD12)
        hojasCoincidentes.sort((a, b) => b.length - a.length);
        
        if (hojasCoincidentes.length > 0) {
            hojaEncontrada = hojasCoincidentes[0];
        }
    }
    
    if (!hojaEncontrada) {
        alert(`No se encontraron datos cargados para la toma: ${tomaSeleccionada}\n\nPor favor carga el archivo Excel correspondiente.`);
        return;
    }
    
    // Cerrar modal
    cerrarModalTomaEspecifica();
    
    // ‚úÖ LIMPIAR SOLO USUARIOS PROGRAMADOS DE TOMA ANTERIOR SI ES DIFERENTE
    if (window.tomaActualSeleccionada && window.tomaActualSeleccionada !== tomaSeleccionada) {
        limpiarUsuariosProgramadosDeToma(window.tomaActualSeleccionada);
    }
    
    // ‚úÖ NO limpiar el consolidado aqu√≠ - solo actualizar referencias
    tomaPendiente = hojaEncontrada;
    window.tomaActualSeleccionada = tomaSeleccionada;
    
    console.log("Toma espec√≠fica seleccionada:", tomaSeleccionada);
    console.log("Hoja EXACTA de datos:", hojaEncontrada);
    console.log("üìä Estado actual del consolidado:", consolidadoDemandas.length, "tomas guardadas:", consolidadoDemandas.map(t => t.toma).join(', '));
    
    // Generar avance de siembra para la toma espec√≠fica
    generarAvanceSiembraPorTomaEspecifica(tomaSeleccionada);
}
function cerrarModalGrupos() {
    const modalGrupos = document.getElementById('modalSelectorGrupos');
    if (modalGrupos) {
        modalGrupos.remove();
    }
    tomaPendiente = null;
}

function generarAvanceSiembraPorGrupo(tomasGrupo, nombreGrupo) {
    const caudales = {
        "SD3":0.35,"SD4":0.25,"SD5":0.5,"SD6":0.35,"SD7":0.5,
        "SD8":1.2,"SD8.1":0.5,"SD9":0.25,"SD10":0.3,"SD11":0.45,
        "SD12":0.35,"SD12.1":0.095,"SD13":0.35,"SD14":0.3,
        "SD14.1":0.3,"SI3":0.29,"SI4":0.1,"SI5":0.25,
        "SI6":1.1,"SI7":0.05,"AGROAURORA":3.2,"AGRICOLA DEL CHIRA":2.5,
        "SIFON TAPIA 13+652":0.01,"SIFON PALOMINO SD10":0,"SIFON HERRERA SI7":0
    };

    const usuarios = tomasData[tomaPendiente];
    if (!usuarios) return;

    const deudaMax = parseFloat(deudaMinima.value) || 0;
    const resumen = {};

    // Filtrar usuarios solo del grupo seleccionado
    usuarios.forEach(u => {
        // Verificar si el usuario pertenece a alguna toma del grupo
        const perteneceAlGrupo = tomasGrupo.some(toma => 
            u.cultivo1?.includes(toma) || 
            u.cultivo2?.includes(toma) ||
            u.nombre?.includes(toma)
        );

        // Para el grupo 3 (R√≠o Chira), usar l√≥gica especial
        if (nombreGrupo.includes("GRUPO 3")) {
            // Aqu√≠ puedes definir criterios espec√≠ficos para las empresas
        }

        const cultivos = [
            { nombre: u.cultivo1, area: u.area1 },
            { nombre: u.cultivo2, area: u.area2 }
        ];

        cultivos.forEach(c => {
            if (!c.nombre || c.area <= 0) return;

            if (!resumen[c.nombre]) {
                resumen[c.nombre] = { areaTotal: 0, areaSemana: 0 };
            }

            resumen[c.nombre].areaTotal += c.area;

            if (esUsuarioApto(u, deudaMax)) {
                resumen[c.nombre].areaSemana += c.area;
            }
        });
    });

    mostrarAvanceSiembraConGrupo(tomaPendiente, resumen, nombreGrupo, tomasGrupo);
}
// DEBUG: Mostrar resultados
    console.log("Usuarios de la toma seleccionada:", usuariosDeToma);
    console.log("Cultivos encontrados:", Object.keys(resumen));
    console.log("Resumen completo:", resumen);

    // ‚úÖ VERIFICACI√ìN: Si no hay cultivos, mostrar alerta pero igual mostrar tabla vac√≠a
    if (Object.keys(resumen).length === 0) {
        console.warn('No se encontraron cultivos para la toma:', tomaSeleccionada);
        alert(`Advertencia: No se encontraron cultivos con √°rea para la toma ${tomaSeleccionada}.\n\nVerifica que:\n1. Los usuarios tengan cultivos asignados en el archivo TOMAS.xlsx\n2. Las √°reas sean mayores a 0\n3. Los nombres de cultivos no est√©n vac√≠os`);
    }
function mostrarAvanceSiembraConTomaEspecifica(tomaSeleccionada, resumen, qMax) {
    // Verificar que tenemos datos de semana
    if (!semanaPDA.fechaInicio || !semanaPDA.fechaFin) {
        alert('Error: No se ha calculado la semana de evaluaci√≥n');
        return;
    }
    
    let html = `
        <div style="text-align:center; margin-bottom:10px;">
            <div style="
                border:1px solid black;
                display:inline-block;
                padding:6px 20px;
                font-weight:bold;
                font-size:16px;
                margin-bottom:8px;
            ">
                CAMPA√ëA AGR√çCOLA 2026 - I
            </div>

            <div style="
                font-size:20px;
                font-weight:bold;
                text-decoration: underline;
                margin-top:10px;
            ">
                CALCULO DE LAS DEMANDAS DE AGUA SEMANAL
            </div>

            <div style="margin-top:15px; font-size:14px; background: #e3f2fd; padding: 10px; border-radius: 8px; display: inline-block;">
                <strong>SEMANA PDA:</strong>
                DEL <strong>${formatearFecha(semanaPDA.fechaInicio)}</strong>
                AL <strong>${formatearFecha(semanaPDA.fechaFin)}</strong>
                ${semanaPDA.esCierreMes ? '<br><span style="color: #d32f2f; font-size: 12px;">‚ö†Ô∏è CIERRE DE MES</span>' : ''}
            </div>

            <div style="margin-top:10px; padding:8px; background:#e8f5e9; border-radius:4px; display:inline-block; font-size: 12px;">
                <strong>TOMA:</strong> ${tomaSeleccionada}<br>
                <small>Reporte generado: ${new Date().toLocaleDateString('es-PE')}</small>
            </div>
        </div>

        <div style="text-align:right; margin-bottom:10px;">
            <button onclick="mostrarSelectorDeGrupos()"
                style="
                    background:#6c757d;
                    color:white;
                    border:none;
                    padding:6px 12px;
                    border-radius:6px;
                    cursor:pointer;
                    font-weight:bold;
                    margin-right:5px;
                ">
                üîÑ Cambiar Grupo/Toma
            </button>
            <button onclick="abrirProgramacionNoAptosToma()"
                style="
                    background:#2e7d32;
                    color:white;
                    border:none;
                    padding:6px 12px;
                    border-radius:6px;
                    cursor:pointer;
                    font-weight:bold;
                    margin-right:5px;
                ">
                ‚ûï Programar Usuarios No Aptos
            </button>
           <button onclick="solicitarDiasTurnados()"
                style="
                    background:#dc3545;
                    color:white;
                    border:none;
                    padding:6px 12px;
                    border-radius:6px;
                    cursor:pointer;
                    font-weight:bold;
                ">
                üíæ Guardar
            </button>
        </div>
    `;
    
    // TABLA DE AVANCE DE SIEMBRA - CON SUMATORIA FINAL
    html += `
        <table class="report-table avance-siembra" id="tablaAvanceSiembra">
            <thead>
                <tr>
                    <th>CANAL</th>
                    <th>TOMA</th>
                    <th>Q MAX (m¬≥/s)</th>
                    <th>CULTIVO</th>
                    <th>AREA TOTAL<br><small>(ha)</small></th>
                    <th>AREA SEMANA<br><small>(ha)</small></th>
                    <th>PASE</th>
                    <th>MODULO<br><small>(m¬≥/ha)</small></th>
                    <th>EFICIENCIA<br><small>(%)</small></th>
                    <th>VOL BRUTO<br><small>(m¬≥)</small></th>
                    <th>VOL CORREGIDO<br><small>(m¬≥)</small></th>
                    <th>Q TEORICO<br><small>(m¬≥/s)</small></th>
                </tr>
            </thead>
            <tbody>
    `;

    // Variables para acumular totales
    let totalAreaTotal = 0;
    let totalAreaSemana = 0;

    // SI NO HAY CULTIVOS, MOSTRAR MENSAJE
    if (Object.keys(resumen).length === 0) {
        html += `
            <tr>
                <td colspan="12" style="text-align: center; padding: 20px; color: #666;">
                    No se encontraron cultivos con √°rea para esta toma.<br>
                    <small>Verifica que los usuarios tengan cultivos asignados en el archivo TOMAS.xlsx</small>
                </td>
            </tr>
        `;
    } else {
        const numCultivos = Object.keys(resumen).length;
        
        Object.entries(resumen).forEach(([cultivo, d], index) => {
            const alerta = d.areaTotal > 0 && d.areaSemana === 0;
            
            // Acumular totales
            totalAreaTotal += d.areaTotal;
            totalAreaSemana += d.areaSemana;

            html += `
                <tr class="${alerta ? 'totals-row' : ''} fila-cultivo" 
                    data-cultivo="${cultivo}"
                    data-area-total="${d.areaTotal.toFixed(2)}"
                    data-area-semana="${d.areaSemana.toFixed(2)}">
                    ${index === 0 ? `
                        <td rowspan="${numCultivos + 1}" 
                            style="
                                writing-mode: vertical-rl;
                                transform: rotate(180deg);
                                text-align: center;
                                font-weight: bold;
                            ">
                            CANAL SUR
                        </td>` : ""}
                    ${index === 0 ? `<td rowspan="${numCultivos + 1}">${tomaSeleccionada}</td>` : ""}
                    ${index === 0 ? `<td rowspan="${numCultivos + 1}">${qMax}</td>` : ""}
                    <td class="cultivo-nombre">${cultivo}</td>
                    <td class="col-area-total">${d.areaTotal.toFixed(2)}</td>
                   <td>
    <input type="number"
        step="0.01"
        class="area-semana"
        value="${d.areaSemana.toFixed(2)}"
        readonly
        style="${d.areaSemana == 0 ? 'background:#eee;' : 'background:#f8f9fa; cursor:not-allowed;'}"
        oninput="recalcularAvance(this); actualizarTotalesToma();">
</td>
                    <td><input class="input-mini pase-input" oninput="recalcularAvance(this)"></td>
                    <td>
                        <input type="number" step="0.01" 
                            class="input-mini modulo" 
                            oninput="recalcularAvance(this)">
                    </td>
                    <td>
                        <input type="number" step="0.01" 
                            class="input-mini eficiencia" 
                            oninput="recalcularAvance(this)">
                    </td>
                    <td class="volBruto">0.00</td>
                    <td class="volCorregido">0.00</td>
                    <td class="qTeorico">0.000</td>
                </tr>
            `;
        });

        // ‚úÖ FILA DE TOTALES AL FINAL DEL CUADRO
        html += `
            <tr class="fila-totales-finales" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold;">
                <td style="text-align: center; font-weight: bold; font-size: 13px; background: rgba(255,255,255,0.2);">
                    TOTAL ${tomaSeleccionada}
                </td>
                <td class="total-area-total" style="font-weight: bold;">${totalAreaTotal.toFixed(2)}</td>
                <td class="total-area-semana" style="font-weight: bold;">${totalAreaSemana.toFixed(2)}</td>
                <td style="background: rgba(255,255,255,0.1);">-</td>
                <td style="background: rgba(255,255,255,0.1);">-</td>
                <td style="background: rgba(255,255,255,0.1);">-</td>
                <td class="total-vol-bruto" style="font-weight: bold;">0.00</td>
                <td class="total-vol-corregido" style="font-weight: bold;">0.00</td>
                <td class="total-q-teorico" style="font-weight: bold;">0.000</td>
            </tr>
        `;
    }

    html += `</tbody></table>`;
    
    // CONTENEDOR PARA LOS PANELES DE USUARIOS NO APTOS
    html += `<div id="contenedorPanelesNoAptos" style="margin-top: 20px;"></div>`;

    contentArea.innerHTML = html;
    
    // Guardar referencia global
    window.tomaActualSeleccionada = tomaSeleccionada;
    window.datosTomaActual = {
        toma: tomaSeleccionada,
        qMax: qMax,
        resumen: resumen
    };
}
function actualizarTotalesFinales() {
    // Buscar todas las filas de cultivos (excluyendo la fila de totales)
    const filasCultivos = document.querySelectorAll('#tablaAvanceSiembra tbody tr.fila-cultivo');
    const filaTotales = document.querySelector('#tablaAvanceSiembra tbody tr.fila-totales-finales');
    
    if (!filaTotales) return;
    
    let sumaAreaTotal = 0;
    let sumaAreaSemana = 0;
    let sumaVolBruto = 0;
    let sumaVolCorregido = 0;
    let sumaQTeorico = 0;
    
    filasCultivos.forEach(fila => {
        // √Årea total (est√°tica, del atributo data)
        const areaTotal = parseFloat(fila.getAttribute('data-area-total')) || 0;
        sumaAreaTotal += areaTotal;
        
        // √Årea semana (del input, puede cambiar)
        const areaSemana = parseFloat(fila.querySelector('.area-semana')?.value) || 0;
        sumaAreaSemana += areaSemana;
        
        // Vol√∫menes y caudal (de las celdas calculadas)
        const volBruto = parseFloat(fila.querySelector('.volBruto')?.innerText) || 0;
        const volCorregido = parseFloat(fila.querySelector('.volCorregido')?.innerText) || 0;
        const qTeorico = parseFloat(fila.querySelector('.qTeorico')?.innerText) || 0;
        
        sumaVolBruto += volBruto;
        sumaVolCorregido += volCorregido;
        sumaQTeorico += qTeorico;
    });
    
    // Actualizar celdas de totales
    const celdaAreaTotal = filaTotales.querySelector('.total-area-total');
    const celdaAreaSemana = filaTotales.querySelector('.total-area-semana');
    const celdaVolBruto = filaTotales.querySelector('.total-vol-bruto');
    const celdaVolCorregido = filaTotales.querySelector('.total-vol-corregido');
    const celdaQTeorico = filaTotales.querySelector('.total-q-teorico');
    
    if (celdaAreaTotal) celdaAreaTotal.innerText = sumaAreaTotal.toFixed(2);
    if (celdaAreaSemana) celdaAreaSemana.innerText = sumaAreaSemana.toFixed(2);
    if (celdaVolBruto) celdaVolBruto.innerText = sumaVolBruto.toFixed(2);
    if (celdaVolCorregido) celdaVolCorregido.innerText = sumaVolCorregido.toFixed(2);
    if (celdaQTeorico) celdaQTeorico.innerText = sumaQTeorico.toFixed(3);
    
    console.log('Totales actualizados:', {
        areaTotal: sumaAreaTotal,
        areaSemana: sumaAreaSemana,
        volBruto: sumaVolBruto,
        volCorregido: sumaVolCorregido,
        qTeorico: sumaQTeorico
    });
}
// ========== FUNCIONES PARA SELECCI√ìN DE TOMA ESPEC√çFICA ==========

function mostrarSelectorDeToma(tomasGrupo, nombreGrupo) {
    // Crear opciones del select
    let opcionesTomas = tomasGrupo.map(toma => 
        `<option value="${toma}">${toma}</option>`
    ).join('');
    
    const modalHTML = `
        <div id="modalSelectorToma" class="modal-overlay active">
            <div class="modal-container" style="max-width: 450px;">
                <h3>üö∞ SELECCIONAR TOMA ESPEC√çFICA</h3>
                
                <div class="info-text">
                    <strong>Grupo:</strong> ${nombreGrupo}<br>
                    Selecciona la toma espec√≠fica que deseas programar.
                </div>
                
                <div class="form-group" style="text-align: left; margin: 20px 0;">
                    <label for="selectTomaEspecifica">Toma:</label>
                    <select id="selectTomaEspecifica" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                        <option value="">-- Selecciona una toma --</option>
                        ${opcionesTomas}
                    </select>
                </div>
                
                <button onclick="confirmarTomaSeleccionada()" class="btn btn-primary">
                    ‚úÖ Confirmar y Continuar
                </button>
                
                <button onclick="cerrarModalToma()" class="btn btn-secondary" style="margin-top: 10px;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}

function cerrarModalToma() {
    const modalToma = document.getElementById('modalSelectorToma');
    if (modalToma) {
        modalToma.remove();
    }
}

function confirmarTomaSeleccionada() {
    const selectToma = document.getElementById('selectTomaEspecifica');
    const tomaSeleccionada = selectToma.value;
    
    if (!tomaSeleccionada) {
        alert('Por favor selecciona una toma');
        return;
    }
    
    // Cerrar modal PRIMERO
    const modalToma = document.getElementById('modalSelectorToma');
    if (modalToma) {
        modalToma.remove();
    }
    
    // LIMPIAR DATOS PREVIOS ANTES DE GENERAR LA NUEVA TOMA
    limpiarDatosPrevios();
    
    // ‚úÖ CORRECCI√ìN: Actualizar tomaPendiente con la toma seleccionada
    // Esto es crucial para que generarAvanceSiembraPorTomaEspecifica encuentre los datos
    tomaPendiente = tomaSeleccionada;
    
    // Guardar nueva toma seleccionada
    window.tomaActualSeleccionada = tomaSeleccionada;
    
    // Generar avance de siembra para la toma espec√≠fica
    generarAvanceSiembraPorTomaEspecifica(tomaSeleccionada);
}
function generarAvanceSiembraPorTomaEspecifica(tomaSeleccionada) {
    // ‚úÖ SOLO limpiar datos de usuarios de la toma anterior espec√≠fica, NO el consolidado
    if (window.tomaActualSeleccionada && window.tomaActualSeleccionada !== tomaSeleccionada) {
        limpiarUsuariosProgramadosDeToma(window.tomaActualSeleccionada);
    }
    
    // Limpiar arrays de usuarios para la nueva toma (pero NO el consolidado)
    usuariosProgramados = [];
    usuariosNoAptosDisponibles = [];
    
    // Eliminar paneles de UI si existen
    const contenedorPaneles = document.getElementById('contenedorPanelesNoAptos');
    if (contenedorPaneles) contenedorPaneles.remove();
    const vistaPrevia = document.getElementById('vistaPreviaTurnosRiego');
    if (vistaPrevia) vistaPrevia.remove();
    
    // ‚úÖ VERIFICAR SI YA EXISTE ESTA TOMA EN EL CONSOLIDADO
    const tomaExistente = consolidadoDemandas.find(item => item.toma === tomaSeleccionada);
    if (tomaExistente) {
        console.log(`‚ö†Ô∏è La toma ${tomaSeleccionada} ya existe en el consolidado. Se actualizar√° al guardar.`);
    }
    
    // ACTUALIZAR TOMA ACTUAL SELECCIONADA
    window.tomaActualSeleccionada = tomaSeleccionada;
    
    const caudales = {
        "SD3":0.35,"SD4":0.25,"SD5":0.5,"SD6":0.35,"SD7":0.5,
        "SD8":1.2,"SD8.1":0.5,"SD9":0.25,"SD10":0.3,"SD11":0.45,
        "SD12":0.35,"SD12.1":0.095,"SD13":0.35,"SD14":0.3,
        "SD14.1":0.3,"SI3":0.29,"SI4":0.1,"SI5":0.25,
        "SI6":1.1,"SI7":0.05,"AGROAURORA":3.2,"AGRICOLA DEL CHIRA":2.5,
        "SIFON TAPIA 13+652":0.01,"SIFON PALOMINO SD10":0,"SIFON HERRERA SI7":0
    };
    
    const qMax = caudales[tomaSeleccionada] || "S/C";
    
    // ‚úÖ CORRECCI√ìN: Buscar la hoja EXACTA en tomasData, no por coincidencia parcial
    let nombreHojaExacta = null;
    
    // Primero buscar coincidencia EXACTA
    if (tomasData[tomaSeleccionada]) {
        nombreHojaExacta = tomaSeleccionada;
    } else {
        // Si no hay exacta, buscar la que contenga el nombre pero sea la m√°s espec√≠fica
        // Priorizar las m√°s largas (SD8.1 antes que SD8, SD12.1 antes que SD12)
        const hojasCoincidentes = [];
        
        for (let hoja in tomasData) {
            const hojaUpper = hoja.toUpperCase().trim();
            const tomaUpper = tomaSeleccionada.toUpperCase().trim();
            
            // Verificar si la hoja contiene la toma o viceversa
            if (hojaUpper === tomaUpper || 
                hojaUpper.includes(tomaUpper) || 
                tomaUpper.includes(hojaUpper)) {
                hojasCoincidentes.push(hoja);
            }
        }
        
        // Ordenar por longitud descendente (las m√°s espec√≠ficas primero)
        // SD8.1 (4 chars) > SD8 (3 chars), SD12.1 (5 chars) > SD12 (4 chars)
        hojasCoincidentes.sort((a, b) => b.length - a.length);
        
        // Tomar la primera (la m√°s espec√≠fica)
        if (hojasCoincidentes.length > 0) {
            nombreHojaExacta = hojasCoincidentes[0];
        }
    }
    
    // ‚úÖ VERIFICAR QUE EXISTAN DATOS PARA LA HOJA ENCONTRADA
    if (!nombreHojaExacta || !tomasData[nombreHojaExacta]) {
        alert(`Error: No hay datos cargados para la toma seleccionada: ${tomaSeleccionada}\n\nHojas disponibles: ${Object.keys(tomasData).join(', ')}`);
        return;
    }
    
    // ‚úÖ USAR LA HOJA EXACTA ENCONTRADA, NO tomaPendiente
    tomaPendiente = nombreHojaExacta;
    
    const usuarios = tomasData[nombreHojaExacta];
    
    console.log("=== GENERANDO AVANCE DE SIEMBRA ===");
    console.log("Toma seleccionada:", tomaSeleccionada);
    console.log("Hoja EXACTA encontrada:", nombreHojaExacta);
    console.log("Total usuarios:", usuarios.length);

    const deudaMax = parseFloat(deudaMinima.value) || 0;
    const resumen = {};
    
    // PROCESAR TODOS LOS USUARIOS DE LA HOJA
    usuarios.forEach((u, index) => {
        const cultivos = [
            { nombre: u.cultivo1, area: u.area1 },
            { nombre: u.cultivo2, area: u.area2 }
        ];

        cultivos.forEach(c => {
            if (!c.nombre || c.area <= 0) return;

            if (!resumen[c.nombre]) {
                resumen[c.nombre] = { areaTotal: 0, areaSemana: 0 };
            }

            resumen[c.nombre].areaTotal += c.area;

            if (esUsuarioApto(u, deudaMax)) {
                resumen[c.nombre].areaSemana += c.area;
            }
        });
    });
    
    console.log("Cultivos encontrados:", Object.keys(resumen));

    // Mostrar el reporte
    mostrarAvanceSiembraConTomaEspecifica(tomaSeleccionada, resumen, qMax);
}
function generarAvanceSiembraPorGrupo(tomasGrupo, nombreGrupo) {
    // LIMPIAR DATOS PREVIOS
    limpiarDatosPrevios();
    
    const caudales = {
        "SD3":0.35,"SD4":0.25,"SD5":0.5,"SD6":0.35,"SD7":0.5,
        "SD8":1.2,"SD8.1":0.5,"SD9":0.25,"SD10":0.3,"SD11":0.45,
        "SD12":0.35,"SD12.1":0.095,"SD13":0.35,"SD14":0.3,
        "SD14.1":0.3,"SI3":0.29,"SI4":0.1,"SI5":0.25,
        "SI.6":1.1,"SI 7":0.05,"AGROAURORA":3.2,"AGRICOLA DEL CHIRA":2.5,
        "SIFON TAPIA 13+652":0.01,"SIFON PALOMINO SD10":0,"SIFON HERRERA SI7":0
    };

    const deudaMax = parseFloat(deudaMinima.value) || 0;
    
    // Objeto para almacenar resumen por toma
    const resumenPorToma = {};
    let totalGeneralArea = 0;
    let totalGeneralVolumen = 0;
    
    console.log("=== GENERANDO REPORTE POR GRUPO ===");
    console.log("Grupo:", nombreGrupo);
    console.log("Tomas:", tomasGrupo);
    
    // PROCESAR CADA TOMA DEL GRUPO
    tomasGrupo.forEach(nombreToma => {
        // Buscar datos de la toma en tomasData
        let usuariosToma = null;
        let nombreHoja = null;
        
        // Buscar la hoja que corresponde a esta toma
        for (let hoja in tomasData) {
            if (hoja.toUpperCase().includes(nombreToma.toUpperCase()) || 
                nombreToma.toUpperCase().includes(hoja.toUpperCase())) {
                usuariosToma = tomasData[hoja];
                nombreHoja = hoja;
                break;
            }
        }
        
        // Si no se encontr√≥ por coincidencia parcial, buscar exacta
        if (!usuariosToma && tomasData[nombreToma]) {
            usuariosToma = tomasData[nombreToma];
            nombreHoja = nombreToma;
        }
        
        if (!usuariosToma) {
            console.warn(`No se encontraron datos para toma: ${nombreToma}`);
            return;
        }
        
        console.log(`Procesando ${nombreToma} (hoja: ${nombreHoja}), usuarios: ${usuariosToma.length}`);
        
        const resumenToma = {};
        
        usuariosToma.forEach(u => {
            const cultivos = [
                { nombre: u.cultivo1, area: u.area1 },
                { nombre: u.cultivo2, area: u.area2 }
            ];

            cultivos.forEach(c => {
                if (!c.nombre || c.area <= 0) return;

                const claveCultivo = `${nombreToma}_${c.nombre}`;
                
                if (!resumenToma[c.nombre]) {
                    resumenToma[c.nombre] = { 
                        areaTotal: 0, 
                        areaSemana: 0,
                        toma: nombreToma,
                        cultivo: c.nombre
                    };
                }

                resumenToma[c.nombre].areaTotal += c.area;

                if (esUsuarioApto(u, deudaMax)) {
                    resumenToma[c.nombre].areaSemana += c.area;
                }
            });
        });
        
        resumenPorToma[nombreToma] = {
            usuarios: usuariosToma,
            cultivos: resumenToma,
            qMax: caudales[nombreToma] || "S/C"
        };
    });
    
    // Mostrar el reporte consolidado del grupo
    mostrarAvanceSiembraGrupo(nombreGrupo, tomasGrupo, resumenPorToma);
}
function mostrarAvanceSiembraGrupo(nombreGrupo, tomasGrupo, resumenPorToma) {
    let html = `
        <div style="text-align:center; margin-bottom:10px;">
            <div style="
                border:1px solid black;
                display:inline-block;
                padding:6px 20px;
                font-weight:bold;
                font-size:16px;
                margin-bottom:8px;
            ">
                CAMPA√ëA AGR√çCOLA 2026 - I
            </div>

            <div style="
                font-size:20px;
                font-weight:bold;
                text-decoration: underline;
                margin-top:10px;
            ">
                CALCULO DE LAS DEMANDAS DE AGUA SEMANAL
            </div>

            <div style="margin-top:15px; font-size:14px;">
                <strong>SEMANA PDA:</strong>
                DEL <strong>${formatearFecha(semanaPDA.fechaInicio)}</strong>
                AL <strong>${formatearFecha(semanaPDA.fechaFin)}</strong>
            </div>

            <div style="margin-top:10px; padding:8px; background:#e3f2fd; border-radius:4px; display:inline-block;">
                <strong>GRUPO:</strong> ${nombreGrupo}<br>
                <small>Tomas incluidas: ${tomasGrupo.join(', ')}</small>
            </div>
        </div>

        <div style="text-align:right; margin-bottom:10px;">
            <button onclick="mostrarSelectorDeGrupos()"
                style="
                    background:#6c757d;
                    color:white;
                    border:none;
                    padding:6px 12px;
                    border-radius:6px;
                    cursor:pointer;
                    font-weight:bold;
                    margin-right:5px;
                ">
                üîÑ Cambiar Grupo
            </button>
             <button onclick="abrirProgramacionNoAptosToma()"
                style="
                    background:#2e7d32;
                    color:white;
                    border:none;
                    padding:6px 12px;
                    border-radius:6px;
                    cursor:pointer;
                    font-weight:bold;
                    margin-right:5px;
                ">
                ‚ûï Programar Usuarios No Aptos por Toma
            </button>
           <button onclick="solicitarDiasTurnadosGrupo()"
                style="
                    background:#dc3545;
                    color:white;
                    border:none;
                    padding:6px 12px;
                    border-radius:6px;
                    cursor:pointer;
                    font-weight:bold;
                ">
                üíæ Guardar
            </button>
        </div>
    `;
    
    // TABLA DE AVANCE DE SIEMBRA POR GRUPO
    html += `
        <table class="report-table avance-siembra" id="tablaAvanceSiembraGrupo">
            <thead>
                <tr>
                    <th>CANAL</th>
                    <th>TOMA</th>
                    <th>Q MAX (m¬≥/s)</th>
                    <th>CULTIVO</th>
                    <th>AREA TOTAL<br><small>(ha)</small></th>
                    <th>AREA SEMANA<br><small>(ha)</small></th>
                    <th>PASE</th>
                    <th>MODULO<br><small>(m¬≥/ha)</small></th>
                    <th>EFICIENCIA<br><small>(%)</small></th>
                    <th>VOL BRUTO<br><small>(m¬≥)</small></th>
                    <th>VOL CORREGIDO<br><small>(m¬≥)</small></th>
                    <th>Q TEORICO<br><small>(m¬≥/s)</small></th>
                </tr>
            </thead>
            <tbody>
    `;

    let hayDatos = false;
    let totalFilas = 0;

   // Generar filas para cada toma del grupo
    tomasGrupo.forEach(nombreToma => {
        const datosToma = resumenPorToma[nombreToma];
        if (!datosToma) return;
        
        const cultivos = Object.values(datosToma.cultivos);
        if (cultivos.length === 0) return;
        
        hayDatos = true;
        const qMax = datosToma.qMax;
        const numCultivos = cultivos.length;
        
        // Variables para sumatoria de esta toma
        let sumaAreaTotal = 0;
        let sumaAreaSemana = 0;
        let sumaVolBruto = 0;
        let sumaVolCorregido = 0;
        let sumaQTeorico = 0;
        
        cultivos.forEach((c, index) => {
            const alerta = c.areaTotal > 0 && c.areaSemana === 0;
            
            // Acumular para sumatoria
            sumaAreaTotal += c.areaTotal;
            sumaAreaSemana += c.areaSemana;
            
            html += `
                <tr class="${alerta ? 'totals-row' : ''} fila-toma-${nombreToma}" 
                    data-toma="${nombreToma}" 
                    data-cultivo="${c.cultivo}"
                    data-area-original="${c.areaSemana.toFixed(2)}"
                    style="${c.areaSemana > 0 ? 'background-color: white;' : 'background-color: #fff3cd;'}">
                    ${index === 0 ? `
                        <td rowspan="${numCultivos + 1}" 
                            style="
                                writing-mode: vertical-rl;
                                transform: rotate(180deg);
                                text-align: center;
                                font-weight: bold;
                            ">
                            CANAL SUR
                        </td>` : ""}
                    ${index === 0 ? `<td rowspan="${numCultivos + 1}">${nombreToma}</td>` : ""}
                    ${index === 0 ? `<td rowspan="${numCultivos + 1}">${qMax}</td>` : ""}
                    <td class="cultivo-nombre">${c.cultivo}</td>
                    <td class="col-area-total">${c.areaTotal.toFixed(2)}</td>
                    <td>
    <input type="number"
        step="0.01"
        class="area-semana"
        value="${c.areaSemana.toFixed(2)}"
        readonly
        style="${c.areaSemana == 0 ? 'background:#eee; cursor:not-allowed;' : 'background:#f8f9fa; cursor:not-allowed;'}"
        oninput="recalcularAvance(this); actualizarSumatoriaToma('${nombreToma}');"
        data-toma-ref="${nombreToma}">
</td>
                    <td><input class="input-mini pase-input" oninput="recalcularAvance(this)"></td>
                    <td>
                        <input type="number" step="0.01" 
                            class="input-mini modulo" 
                            oninput="recalcularAvance(this)">
                    </td>
                    <td>
                        <input type="number" step="0.01" 
                            class="input-mini eficiencia" 
                            oninput="recalcularAvance(this)">
                    </td>
                    <td class="volBruto">0.00</td>
                    <td class="volCorregido">0.00</td>
                    <td class="qTeorico">0.000</td>
                </tr>
            `;
        });
        
        // ‚úÖ FILA DE SUMATORIA PARA ESTA TOMA - SOLO 9 CELDAS (sin CANAL, TOMA, Q MAX)
        html += `
            <tr class="fila-sumatoria-toma" 
                data-toma-sumatoria="${nombreToma}"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold;">
                <td style="text-align: center; font-weight: bold; font-size: 13px; background: rgba(255,255,255,0.2);">TOTAL ${nombreToma}</td>
                <td class="suma-area-total" style="font-weight: bold;">${sumaAreaTotal.toFixed(2)}</td>
                <td class="suma-area-semana" style="font-weight: bold;">${sumaAreaSemana.toFixed(2)}</td>
                <td style="background: rgba(255,255,255,0.1);">-</td>
                <td style="background: rgba(255,255,255,0.1);">-</td>
                <td style="background: rgba(255,255,255,0.1);">-</td>
                <td class="suma-vol-bruto" style="font-weight: bold;">0.00</td>
                <td class="suma-vol-corregido" style="font-weight: bold;">0.00</td>
                <td class="suma-q-teorico" style="font-weight: bold;">0.000</td>
            </tr>
        `;
    });

    if (!hayDatos) {
        html += `
            <tr>
                <td colspan="12" style="text-align: center; padding: 20px; color: #666;">
                    No se encontraron cultivos con √°rea para las tomas de este grupo.<br>
                    <small>Verifica que los archivos Excel contengan datos para: ${tomasGrupo.join(', ')}</small>
                </td>
            </tr>
        `;
    }

    html += `</tbody></table>`;
    
    // Guardar referencia global de datos del grupo
    window.datosGrupoActual = {
        nombreGrupo: nombreGrupo,
        tomas: tomasGrupo,
        resumen: resumenPorToma
    };
    
    // CONTENEDOR PARA PANELES DE USUARIOS NO APTOS
    html += `<div id="contenedorPanelesNoAptos" style="margin-top: 20px;"></div>`;

    contentArea.innerHTML = html;
    
    console.log(`Reporte generado con ${totalFilas} filas de cultivos`);
}
function limpiarDatosPrevios() {
    // ‚úÖ NO limpiar consolidadoDemandas aqu√≠ - solo limpiar datos de la toma actual
    // Limpiar arrays de usuarios programados de la toma espec√≠fica
    usuariosProgramados = [];
    usuariosNoAptosDisponibles = [];
    
    // Limpiar turnos de riego de la toma anterior si existe
    if (window.turnosDeRiego && window.tomaActualSeleccionada) {
        delete window.turnosDeRiego[window.tomaActualSeleccionada];
    }
    
    // Eliminar paneles de usuarios no aptos si existen
    const contenedorPaneles = document.getElementById('contenedorPanelesNoAptos');
    if (contenedorPaneles) {
        contenedorPaneles.remove();
    }
    
    // Eliminar vista previa de turnos de riego si existe
    const vistaPrevia = document.getElementById('vistaPreviaTurnosRiego');
    if (vistaPrevia) {
        vistaPrevia.remove();
    }
    
    console.log("üßπ Datos de toma anterior limpiados (consolidado preservado)");
}
function limpiarUsuariosProgramadosDeToma(nombreToma) {
    if (!nombreToma) return;
    
    const tomaUpper = nombreToma.toString().trim().toUpperCase();
    
    // Limpiar de window.usuariosProgramados
    if (window.usuariosProgramados) {
        window.usuariosProgramados = window.usuariosProgramados.filter(u => {
            const tomaUsuario = (u._tomaOrigen || '').toString().trim().toUpperCase();
            return tomaUsuario !== tomaUpper && !tomaUsuario.includes(tomaUpper);
        });
    }
    
    // Limpiar de usuariosProgramados global
    if (typeof usuariosProgramados !== 'undefined') {
        usuariosProgramados = usuariosProgramados.filter(u => {
            const tomaUsuario = (u._tomaOrigen || u.toma || '').toString().trim().toUpperCase();
            return tomaUsuario !== tomaUpper && !tomaUsuario.includes(tomaUpper);
        });
    }
    
    console.log(`üßπ Usuarios programados de ${nombreToma} limpiados`);
}
function verificarUsuarioPerteneceAToma(usuario, tomaSeleccionada) {
    if (!usuario || !tomaSeleccionada) return false;
    
    // Normalizar toma seleccionada
    const tomaNormalizada = tomaSeleccionada.toString().trim().toUpperCase();
    
    // DEBUG: Mostrar qu√© se est√° comparando
    console.log("Verificando usuario:", usuario.nombre, "contra toma:", tomaNormalizada);
    
    // OPCI√ìN 1: Si existe campo expl√≠cito 'toma' en el usuario
    if (usuario.toma) {
        const usuarioToma = usuario.toma.toString().trim().toUpperCase();
        if (usuarioToma === tomaNormalizada) return true;
    }
    
    // OPCI√ìN 2: Si el nombre del usuario contiene el c√≥digo de toma
    if (usuario.nombre) {
        const nombreUpper = usuario.nombre.toString().trim().toUpperCase();
        if (nombreUpper.includes(tomaNormalizada)) return true;
    }
    
    // OPCI√ìN 3: Si la unidad catastral contiene el c√≥digo de toma
    if (usuario.unidadCatastral) {
        const catastralUpper = usuario.unidadCatastral.toString().trim().toUpperCase();
        if (catastralUpper.includes(tomaNormalizada)) return true;
    }
    
    // OPCI√ìN 4: Si el cultivo1 contiene el c√≥digo de toma
    if (usuario.cultivo1) {
        const cultivo1Upper = usuario.cultivo1.toString().trim().toUpperCase();
        if (cultivo1Upper.includes(tomaNormalizada)) return true;
    }
    
    // OPCI√ìN 5: Si el cultivo2 contiene el c√≥digo de toma
    if (usuario.cultivo2) {
        const cultivo2Upper = usuario.cultivo2.toString().trim().toUpperCase();
        if (cultivo2Upper.includes(tomaNormalizada)) return true;
    }
    
    // OPCI√ìN 6: Si el nombre del predio contiene el c√≥digo de toma
    if (usuario.nombrePredio) {
        const predioUpper = usuario.nombrePredio.toString().trim().toUpperCase();
        if (predioUpper.includes(tomaNormalizada)) return true;
    }
    
    // ‚úÖ NUEVA OPCI√ìN 7: Si tomaPendiente (hoja del Excel) coincide con tomaSeleccionada
    // Esto significa que estamos en la hoja correcta del Excel
    if (tomaPendiente && tomaPendiente.toUpperCase() === tomaNormalizada) {
        console.log("  -> Coincide por hoja del Excel (tomaPendiente)");
        return true;
    }
    
    // DEBUG: Si no coincide con ninguna
    console.log("  -> NO coincide con ning√∫n criterio");
    return false;
}
// ========== FUNCI√ìN PARA GUARDAR EN TURNOS DE RIEGO ==========

function calcularDistribucionPorDias(qTeorico, areaSemana) {
    // Ejemplo simple: distribuir equitativamente entre 7 d√≠as
    // AJUSTA ESTA L√ìGICA SEG√öN TUS REQUERIMIENTOS
    
    const dias = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO'];
    const distribucion = {};
    
    // Si no hay caudal, todos los d√≠as son 0
    if (qTeorico === 0 || areaSemana === 0) {
        dias.forEach(dia => {
            distribucion[dia] = 0;
        });
        return distribucion;
    }
    
    // Distribuci√≥n simple: dividir entre d√≠as (puedes hacerlo m√°s complejo)
    const caudalPorDia = qTeorico / 7;
    dias.forEach(dia => {
        distribucion[dia] = caudalPorDia;
    });
    
    return distribucion;
}

function mostrarVistaPreviaTurnosRiego(datosTurno) {
    // Crear o actualizar panel de vista previa
    let panelPreview = document.getElementById('vistaPreviaTurnosRiego');
    
    if (!panelPreview) {
        panelPreview = document.createElement('div');
        panelPreview.id = 'vistaPreviaTurnosRiego';
        panelPreview.style.cssText = 'margin-top: 20px; border: 2px solid #28a745; padding: 15px; border-radius: 8px; background: #d4edda;';
        contentArea.appendChild(panelPreview);
    }
    
    let html = `
        <h3>üìã VISTA PREVIA - TURNOS DE RIEGO GUARDADOS</h3>
        <p><strong>TOMA:</strong> ${datosTurno.toma} | 
           <strong>SEMANA:</strong> ${formatearFecha(datosTurno.semanaInicio)} al ${formatearFecha(datosTurno.semanaFin)}</p>
        
        <table class="report-table" style="margin-top: 10px; font-size: 12px;">
            <thead>
                <tr>
                    <th>CULTIVO</th>
                    <th>√ÅREA (ha)</th>
                    <th>M√ìDULO</th>
                    <th>EFIC. (%)</th>
                    <th>VOL. CORREGIDO (m¬≥)</th>
                    <th>Q TE√ìRICO (m¬≥/s)</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    datosTurno.cultivos.forEach(c => {
        html += `
            <tr>
                <td>${c.cultivo}</td>
                <td>${c.areaSemana.toFixed(2)}</td>
                <td>${c.modulo.toFixed(2)}</td>
                <td>${c.eficiencia.toFixed(2)}</td>
                <td>${c.volCorregido.toFixed(2)}</td>
                <td>${c.qTeorico.toFixed(3)}</td>
            </tr>
        `;
    });
    
    html += `
            <tr style="background: #fff3cd; font-weight: bold;">
                <td colspan="4">TOTALES</td>
                <td>${datosTurno.totalVolumen.toFixed(2)}</td>
                <td>${datosTurno.promedioCaudal.toFixed(3)}</td>
            </tr>
        </tbody>
        </table>
        
        <div style="margin-top: 15px; text-align: center;">
            <button onclick="exportarTurnosDeRiegoAExcel()" 
                style="background: #217346; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                üìä Exportar a Excel (Turnos de Riego)
            </button>
            <button onclick="limpiarTurnosGuardados()" 
                style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                üóëÔ∏è Limpiar Datos
            </button>
        </div>
    `;
    
    panelPreview.innerHTML = html;
}

function limpiarTurnosGuardados() {
    if (confirm('¬øEst√°s seguro de limpiar todos los turnos guardados?')) {
        window.turnosDeRiego = {};
        const panel = document.getElementById('vistaPreviaTurnosRiego');
        if (panel) {
            panel.remove();
        }
        alert('Datos limpiados correctamente');
    }
}

function exportarTurnosDeRiegoAExcel() {
    if (!window.turnosDeRiego || Object.keys(window.turnosDeRiego).length === 0) {
        alert('No hay datos de turnos de riego para exportar');
        return;
    }
    
    // Preparar datos para Excel en formato de la pesta√±a "TURNOS DE RIEGO"
    const datosExcel = [];
    
    // Encabezados seg√∫n formato de la pesta√±a TURNOS DE RIEGO
    datosExcel.push(['CANAL PRINCIPAL (L1)', 'TOMA', 'VOL.PROGRAM.', 'DIAS TURNADOS', 'CAUDAL AJUST.', 
        'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO', 'DOMINGO', 
        'CAUDAL PROM.', 'VOLUMEN DE AGUA']);
    
    // Datos por cada toma guardada
    Object.values(window.turnosDeRiego).forEach(turno => {
        const fila = [
            'CANAL SUR', // Canal principal
            turno.toma,
            turno.totalVolumen.toFixed(2),
            '7', // D√≠as turnados (ajustar seg√∫n l√≥gica)
            turno.promedioCaudal.toFixed(3)
        ];
        
        // Agregar distribuci√≥n por d√≠as
        if (turno.cultivos.length > 0 && turno.cultivos[0].distribucionDias) {
            const dist = turno.cultivos[0].distribucionDias;
            fila.push(
                dist['LUNES']?.toFixed(3) || '0',
                dist['MARTES']?.toFixed(3) || '0',
                dist['MIERCOLES']?.toFixed(3) || '0',
                dist['JUEVES']?.toFixed(3) || '0',
                dist['VIERNES']?.toFixed(3) || '0',
                dist['SABADO']?.toFixed(3) || '0',
                dist['DOMINGO']?.toFixed(3) || '0'
            );
        } else {
            fila.push('0', '0', '0', '0', '0', '0', '0');
        }
        
        fila.push(turno.promedioCaudal.toFixed(3));
        fila.push(turno.totalVolumen.toFixed(2));
        
        datosExcel.push(fila);
    });
    
    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(datosExcel);
    XLSX.utils.book_append_sheet(wb, ws, "TURNOS DE RIEGO");
    
    // Guardar archivo
    const fecha = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Turnos_Riego_${fecha}.xlsx`);
}
function limpiarModuloYEficienciaSiEsNecesario(nombreCultivo) {
    const filas = document.querySelectorAll('.avance-siembra tbody tr');
    
    filas.forEach(fila => {
        const cultivoFila = fila.querySelector('.cultivo-nombre')?.innerText.trim();
        if (cultivoFila === nombreCultivo) {
            const inputModulo = fila.querySelector('.modulo');
            const inputEficiencia = fila.querySelector('.eficiencia');
            
            if (inputModulo) {
                inputModulo.value = '';
            }
            if (inputEficiencia) {
                inputEficiencia.value = '';
            }
            
            // Recalcular para poner vol√∫menes en cero
            const inputArea = fila.querySelector('.area-semana');
            if (inputArea) {
                recalcularAvance(inputArea);
            }
        }
    });
}
// ========== FUNCIONES PARA C√ÅLCULO DE TURNOS DE RIEGO ==========

function calcularTotalesTurnosRiegoGrupo() {
    const filas = document.querySelectorAll('#tablaAvanceSiembraGrupo tbody tr');
    
    let totalVolCorregido = 0;
    let totalQTeorico = 0;
    let totalAreaSemana = 0;
    let cultivosConArea = 0;
    
    console.log("=== CALCULANDO TOTALES GRUPO ===");
    console.log("Total filas:", filas.length);
    
    filas.forEach((fila, index) => {
        const inputArea = fila.querySelector('.area-semana');
        const areaSemana = parseFloat(inputArea?.value) || 0;
        
        console.log(`Fila ${index}: Toma=${fila.getAttribute('data-toma')}, Cultivo=${fila.querySelector('.cultivo-nombre')?.innerText}, √Årea=${areaSemana}`);
        
        if (areaSemana > 0) {
            const volCorregido = parseFloat(fila.querySelector('.volCorregido')?.innerText) || 0;
            const qTeorico = parseFloat(fila.querySelector('.qTeorico')?.innerText) || 0;
            
            totalVolCorregido += volCorregido;
            totalQTeorico += qTeorico;
            totalAreaSemana += areaSemana;
            cultivosConArea++;
        }
    });
    
    console.log("Resultados:", { totalVolCorregido, totalQTeorico, totalAreaSemana, cultivosConArea });
    
    return {
        volumenProgramado: totalVolCorregido,
        caudalAjustado: totalQTeorico,
        totalArea: totalAreaSemana,
        cultivosActivos: cultivosConArea
    };
}

function solicitarDiasTurnados() {
    // Verificar que hay datos con caudal para guardar
    const filas = document.querySelectorAll('#tablaAvanceSiembra tbody tr');
    let hayDatos = false;
    let volumenCorregidoTotal = 0;

    filas.forEach(fila => {
        const qTeorico = parseFloat(fila.querySelector('.qTeorico')?.innerText) || 0;
        const volCorregido = parseFloat(fila.querySelector('.volCorregido')?.innerText) || 0;
        if (qTeorico > 0) {
            hayDatos = true;
            volumenCorregidoTotal += volCorregido;
        }
    });

    if (!hayDatos) {
        alert('No hay datos para guardar. Verifica que hayas ingresado m√≥dulo y eficiencia para calcular el caudal te√≥rico.');
        return;
    }

    // Calcular caudal te√≥rico total de la toma (PRECISI√ìN COMPLETA)
    const caudalTeoricoTotal = volumenCorregidoTotal / (7 * 86400);
    
    // Guardar datos para el modal
    window.datosParaProgramacion = {
        volumenCorregidoTotal: volumenCorregidoTotal,
        caudalTeoricoTotal: caudalTeoricoTotal, // Precisi√≥n completa para c√°lculos
        toma: window.tomaActualSeleccionada
    };
    
    // Mostrar modal de programaci√≥n de d√≠as
    mostrarModalProgramacionDias();
}
function mostrarModalProgramacionDias() {
    const datos = window.datosParaProgramacion;
    const caudalPorDiaDefault = datos.caudalTeoricoTotal;
    
    const modalHTML = `
        <div id="modalProgramacionDias" class="modal-overlay active">
            <div class="modal-container" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <h3>üìÖ PROGRAMACI√ìN DE D√çAS Y CAUDALES - ${datos.toma}</h3>
                
                <div class="info-text" style="margin-bottom: 15px;">
                    <strong>Volumen Corregido Original (7 d√≠as):</strong> ${datos.volumenCorregidoTotal.toFixed(2)} m¬≥<br>
                    <strong>Caudal Te√≥rico Original:</strong> ${datos.caudalTeoricoTotal.toFixed(3)} m¬≥/s <small style="color: #666;">(${datos.caudalTeoricoTotal} m¬≥/s preciso)</small><br>
                    <small>Selecciona los d√≠as y ajusta el caudal para cada d√≠a. El volumen total no debe exceder el original.</small>
                </div>
                
                <div style="margin: 20px 0;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #0070c0; color: white;">
                                <th style="padding: 10px; text-align: center;">D√çA</th>
                                <th style="padding: 10px; text-align: center;">PROGRAMAR</th>
                                <th style="padding: 10px; text-align: center;">CAUDAL (m¬≥/s)</th>
                                <th style="padding: 10px; text-align: center;">VOLUMEN D√çA (m¬≥)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'].map((dia, index) => `
                                <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                    <td style="padding: 10px; font-weight: bold; text-align: center;">${dia}</td>
                                    <td style="padding: 10px; text-align: center;">
                                        <input type="checkbox" id="check${dia}" checked onchange="calcularVolumenProgramado()">
                                    </td>
                                    <td style="padding: 10px; text-align: center;">
                                        <input type="number" id="caudal${dia}" step="any" 
                                            value="${caudalPorDiaDefault}" 
                                            style="width: 120px; padding: 5px; text-align: right;"
                                            oninput="validarCaudalIndividual('${dia}', ${caudalPorDiaDefault}); calcularVolumenProgramado()">
                                    </td>
                                    <td style="padding: 10px; text-align: right; font-weight: bold;" id="volumen${dia}">
                                        ${(caudalPorDiaDefault * 86400).toFixed(2)}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div id="resumenProgramacion" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #0070c0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div><strong>D√≠as programados:</strong> <span id="diasProgramados">7</span></div>
                        <div><strong>Volumen Programado:</strong> <span id="volumenProgramado">${datos.volumenCorregidoTotal.toFixed(2)}</span> m¬≥</div>
                        <div><strong>Volumen Original:</strong> ${datos.volumenCorregidoTotal.toFixed(2)} m¬≥</div>
                        <div id="diferenciaVolumen" style="color: #28a745; font-weight: bold;">
                            Diferencia: 0.00 m¬≥ (0.00%)
                        </div>
                    </div>
                </div>
                
                <div id="alertaVolumen" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107; font-size: 12px;">
                    ‚ö†Ô∏è <span id="mensajeAlerta"></span>
                </div>
                
                <button onclick="confirmarProgramacionDias()" class="btn btn-primary" id="btnConfirmarProg" style="width: 100%;">
                    ‚úÖ Confirmar y Guardar
                </button>
                
                <button onclick="cerrarModalProgramacionDias()" class="btn btn-secondary" style="margin-top: 10px; width: 100%;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
    
    // Calcular inicial
    calcularVolumenProgramado();
}
function validarCaudalIndividual(dia, caudalMaximo) {
    const input = document.getElementById(`caudal${dia}`);
    let valor = parseFloat(input.value) || 0;
    
    // Permitir cualquier valor, pero marcar en rojo si excede el m√°ximo
    if (valor > caudalMaximo * 1.5) { // Permitir hasta 150% del original como l√≠mite pr√°ctico
        input.style.backgroundColor = '#f8d7da';
        input.style.color = '#721c24';
    } else if (valor > caudalMaximo) {
        input.style.backgroundColor = '#fff3cd';
        input.style.color = '#856404';
    } else {
        input.style.backgroundColor = '#d4edda';
        input.style.color = '#155724';
    }
}
function calcularVolumenProgramado() {
    const dias = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
    let volumenTotal = 0;
    let diasActivos = 0;
    const datos = window.datosParaProgramacion;
    
    dias.forEach(dia => {
        const check = document.getElementById(`check${dia}`);
        const inputCaudal = document.getElementById(`caudal${dia}`);
        const celdaVolumen = document.getElementById(`volumen${dia}`);
        
        if (check.checked) {
            const caudal = parseFloat(inputCaudal.value) || 0;
            const volumenDia = caudal * 86400;
            volumenTotal += volumenDia;
            diasActivos++;
            celdaVolumen.innerText = volumenDia.toFixed(2);
            celdaVolumen.style.color = '#155724';
        } else {
            celdaVolumen.innerText = '0.00';
            celdaVolumen.style.color = '#999';
        }
    });
    
    // Actualizar resumen
    document.getElementById('diasProgramados').innerText = diasActivos;
    document.getElementById('volumenProgramado').innerText = volumenTotal.toFixed(2);
    
    // Calcular diferencia
    const diferencia = volumenTotal - datos.volumenCorregidoTotal;
    const porcentaje = (diferencia / datos.volumenCorregidoTotal) * 100;
    const elemDiferencia = document.getElementById('diferenciaVolumen');
    const elemAlerta = document.getElementById('alertaVolumen');
    const elemMensaje = document.getElementById('mensajeAlerta');
    
    if (Math.abs(diferencia) < 0.01) {
        elemDiferencia.style.color = '#28a745';
        elemDiferencia.innerHTML = `Diferencia: 0.00 m¬≥ (0.00%) ‚úì`;
        elemAlerta.style.display = 'none';
    } else if (diferencia > 0) {
        elemDiferencia.style.color = '#dc3545';
        elemDiferencia.innerHTML = `‚ö†Ô∏è EXCEDE en: ${diferencia.toFixed(2)} m¬≥ (+${porcentaje.toFixed(2)}%)`;
        elemAlerta.style.display = 'block';
        elemMensaje.innerHTML = `El volumen programado <strong>EXCEDE</strong> al original en ${diferencia.toFixed(2)} m¬≥.<br>Se guardar√° el volumen programado, pero se mostrar√° la diferencia en el Anexo G2.`;
    } else {
        elemDiferencia.style.color = '#0070c0';
        elemDiferencia.innerHTML = `Menor en: ${Math.abs(diferencia).toFixed(2)} m¬≥ (${porcentaje.toFixed(2)}%)`;
        elemAlerta.style.display = 'block';
        elemMensaje.innerHTML = `El volumen programado es <strong>MENOR</strong> al original en ${Math.abs(diferencia).toFixed(2)} m¬≥.<br>Se guardar√° el volumen programado en el Anexo G2.`;
    }
    
    // Guardar datos para confirmaci√≥n
    window.datosProgramacionCalculada = {
        diasProgramados: diasActivos,
        volumenProgramado: volumenTotal,
        volumenOriginal: datos.volumenCorregidoTotal,
        diferencia: diferencia,
        porcentaje: porcentaje,
        caudalesPorDia: {}
    };
    
    // Guardar caudales por d√≠a (PRECISI√ìN COMPLETA) - MAPEO EXPL√çCITO
    const checkLunes = document.getElementById('checkLunes');
    const checkMartes = document.getElementById('checkMartes');
    const checkMiercoles = document.getElementById('checkMi√©rcoles');
    const checkJueves = document.getElementById('checkJueves');
    const checkViernes = document.getElementById('checkViernes');
    const checkSabado = document.getElementById('checkS√°bado');
    const checkDomingo = document.getElementById('checkDomingo');
    
    const inputLunes = document.getElementById('caudalLunes');
    const inputMartes = document.getElementById('caudalMartes');
    const inputMiercoles = document.getElementById('caudalMi√©rcoles');
    const inputJueves = document.getElementById('caudalJueves');
    const inputViernes = document.getElementById('caudalViernes');
    const inputSabado = document.getElementById('caudalS√°bado');
    const inputDomingo = document.getElementById('caudalDomingo');
    
    window.datosProgramacionCalculada.caudalesPorDia = {
        lunes: checkLunes?.checked ? (parseFloat(inputLunes?.value) || 0) : 0,
        martes: checkMartes?.checked ? (parseFloat(inputMartes?.value) || 0) : 0,
        miercoles: checkMiercoles?.checked ? (parseFloat(inputMiercoles?.value) || 0) : 0,
        jueves: checkJueves?.checked ? (parseFloat(inputJueves?.value) || 0) : 0,
        viernes: checkViernes?.checked ? (parseFloat(inputViernes?.value) || 0) : 0,
        sabado: checkSabado?.checked ? (parseFloat(inputSabado?.value) || 0) : 0,
        domingo: checkDomingo?.checked ? (parseFloat(inputDomingo?.value) || 0) : 0
    };
    
    console.log('Caudales guardados:', window.datosProgramacionCalculada.caudalesPorDia);
}
function confirmarProgramacionDias() {
    const datos = window.datosProgramacionCalculada;
    
    if (!datos || datos.diasProgramados === 0) {
        alert('Debes seleccionar al menos un d√≠a para programar.');
        return;
    }
    
    // Cerrar modal
    cerrarModalProgramacionDias();
    
    // Guardar en estructura global para esta toma
    if (!window.programacionPorToma) {
        window.programacionPorToma = {};
    }
    
    window.programacionPorToma[window.tomaActualSeleccionada] = {
        diasProgramados: datos.diasProgramados,
        volumenProgramado: datos.volumenProgramado,
        volumenOriginal: datos.volumenOriginal,
        diferencia: datos.diferencia,
        porcentajeDiferencia: datos.porcentaje,
        caudalesPorDia: datos.caudalesPorDia,
        fechaProgramacion: new Date().toLocaleString('es-PE')
    };
    
    console.log('Programaci√≥n guardada para toma:', window.tomaActualSeleccionada, window.programacionPorToma[window.tomaActualSeleccionada]);
    
    // Continuar con el guardado en consolidado
    guardarEnConsolidadoDemandasIndividualConProgramacion(datos);
}

function cerrarModalProgramacionDias() {
    const modal = document.getElementById('modalProgramacionDias');
    if (modal) {
        modal.remove();
    }
}
function guardarEnConsolidadoDemandasIndividualConProgramacion(datosProgramacion) {
    const tomaActual = window.tomaActualSeleccionada;
    if (!tomaActual) {
        alert('No se pudo identificar la toma actual');
        return;
    }
    
    // Verificar si ya existe esta toma en el consolidado
    const indiceExistente = consolidadoDemandas.findIndex(item => item.toma === tomaActual);
    
    // Extraer datos de la tabla individual
    const filas = document.querySelectorAll('#tablaAvanceSiembra tbody tr');
    const cultivosGuardados = [];
    
    filas.forEach(fila => {
        // Ignorar fila de totales
        if (fila.classList.contains('fila-totales-finales')) return;
        
        const cultivo = fila.querySelector('.cultivo-nombre')?.innerText?.trim();
        const areaSemana = parseFloat(fila.querySelector('.area-semana')?.value) || 0;
        const volBruto = parseFloat(fila.querySelector('.volBruto')?.innerText) || 0;
        const volCorregido = parseFloat(fila.querySelector('.volCorregido')?.innerText) || 0;
        const qTeorico = parseFloat(fila.querySelector('.qTeorico')?.innerText) || 0;
        
        // SOLO guardar si tiene caudal te√≥rico > 0
        if (qTeorico > 0) {
            cultivosGuardados.push({
                cultivo: cultivo || '-',
                areaSemana: areaSemana,
                volBruto: volBruto,
                volCorregido: volCorregido, // Este es el de 7 d√≠as (original)
                qTeorico: qTeorico,
                volCorregidoProgramado: (volCorregido / datosProgramacion.volumenOriginal) * datosProgramacion.volumenProgramado // Proporcional
            });
        }
    });
    
    if (cultivosGuardados.length === 0) {
        alert('No hay cultivos con √°rea o caudal para guardar');
        return;
    }
    
    // Calcular totales con el volumen programado (no el original)
    const totalVolProgramado = datosProgramacion.volumenProgramado;
    const factorProporcional = totalVolProgramado / datosProgramacion.volumenOriginal;
    
    const datosToma = {
        toma: tomaActual,
        semanaInicio: semanaPDA.fechaInicio,
        semanaFin: semanaPDA.fechaFin,
        fechaGuardado: new Date().toLocaleString('es-PE'),
        cultivos: cultivosGuardados,
        // DATOS ORIGINALES (7 d√≠as)
        totalArea: cultivosGuardados.reduce((sum, c) => sum + c.areaSemana, 0),
        totalVolBruto: cultivosGuardados.reduce((sum, c) => sum + c.volBruto, 0),
        totalVolCorregido: datosProgramacion.volumenOriginal, // ORIGINAL de 7 d√≠as
        totalQTeorico: cultivosGuardados.reduce((sum, c) => sum + c.qTeorico, 0),
        // DATOS PROGRAMADOS (d√≠as seleccionados)
        programacion: {
            diasProgramados: datosProgramacion.diasProgramados,
            volumenProgramado: datosProgramacion.volumenProgramado,
            volumenOriginal: datosProgramacion.volumenOriginal,
            diferencia: datosProgramacion.diferencia,
            porcentajeDiferencia: datosProgramacion.porcentaje,
            caudalesPorDia: datosProgramacion.caudalesPorDia
        },
        // Totales ajustados para el G2
        totalVolCorregidoProgramado: totalVolProgramado,
        totalQTeoricoProgramado: datosProgramacion.volumenProgramado / (datosProgramacion.diasProgramados * 86400)
    };
    
    // Si existe, reemplazar; si no, agregar
    if (indiceExistente >= 0) {
        consolidadoDemandas[indiceExistente] = datosToma;
        console.log(`üîÑ Toma ${tomaActual} actualizada con programaci√≥n de ${datosProgramacion.diasProgramados} d√≠as`);
    } else {
        consolidadoDemandas.push(datosToma);
        console.log(`‚ûï Toma ${tomaActual} agregada con programaci√≥n de ${datosProgramacion.diasProgramados} d√≠as`);
    }
    
    // Limpiar Anexo G2 para forzar regeneraci√≥n
    datosAnexoG2 = [];
    
    // Mostrar mensaje de √©xito con informaci√≥n de la diferencia
    mostrarMensajeGuardadoConProgramacion(tomaActual, cultivosGuardados.length, datosProgramacion);
}
function mostrarMensajeGuardadoConProgramacion(nombreToma, cantidadCultivos, datosProg) {
    const totalTomas = consolidadoDemandas.length;
    const listaTomas = consolidadoDemandas.map(t => t.toma).join(', ');
    
    let colorDiferencia = '#28a745';
    let iconoDiferencia = '‚úì';
    let mensajeDiferencia = 'Sin diferencia';
    
    if (datosProg.diferencia > 0) {
        colorDiferencia = '#dc3545';
        iconoDiferencia = '‚ö†Ô∏è';
        mensajeDiferencia = `EXCEDE en ${datosProg.diferencia.toFixed(2)} m¬≥`;
    } else if (datosProg.diferencia < 0) {
        colorDiferencia = '#0070c0';
        iconoDiferencia = '‚ÑπÔ∏è';
        mensajeDiferencia = `Menor en ${Math.abs(datosProg.diferencia).toFixed(2)} m¬≥`;
    }
    
    const modalHTML = `
        <div id="modalGuardadoExitoso" class="modal-overlay active">
            <div class="modal-container" style="max-width: 500px; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 15px;">‚úÖ</div>
                <h3 style="color: #28a745; margin-bottom: 15px;">¬°GUARDADO CON √âXITO!</h3>
                
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                    <p><strong>‚úì Toma guardada:</strong> ${nombreToma}</p>
                    <p><strong>‚úì Cultivos con caudal:</strong> ${cantidadCultivos}</p>
                    <p><strong>‚úì D√≠as programados:</strong> ${datosProg.diasProgramados} de 7</p>
                    <hr style="border-color: #28a745; margin: 10px 0;">
                    <p><strong>Volumen Original (7 d√≠as):</strong> ${datosProg.volumenOriginal.toFixed(2)} m¬≥</p>
                    <p><strong>Volumen Programado:</strong> ${datosProg.volumenProgramado.toFixed(2)} m¬≥</p>
                    <p style="color: ${colorDiferencia}; font-weight: bold;">
                        ${iconoDiferencia} ${mensajeDiferencia} (${datosProg.porcentaje.toFixed(2)}%)
                    </p>
                    <hr style="border-color: #28a745; margin: 10px 0;">
                    <p style="color: #155724; font-weight: bold;">
                        üìä Total acumulado en consolidado: ${totalTomas} toma(s)
                    </p>
                    <p style="font-size: 10px; color: #666; margin-top: 5px; word-break: break-all;">
                        ${listaTomas}
                    </p>
                </div>
                
                <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px; text-align: left;">
                    <strong>üí° Nota:</strong> El Anexo G2 mostrar√° el <strong>Volumen Programado</strong> (${datosProg.volumenProgramado.toFixed(2)} m¬≥) con los caudales ajustados por d√≠a.
                </div>
                
                <button onclick="cerrarModalGuardadoExitoso()" class="btn btn-primary" style="width: 100%;">
                    Aceptar
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}
function guardarEnConsolidadoDemandasIndividual() {
    const tomaActual = window.tomaActualSeleccionada;
    if (!tomaActual) {
        alert('No se pudo identificar la toma actual');
        return;
    }
    
    // ‚úÖ VERIFICAR SI YA EXISTE Y REEMPLAZAR (NO LIMPIAR TODO)
    const indiceExistente = consolidadoDemandas.findIndex(item => item.toma === tomaActual);
    
    // Extraer datos de la tabla individual
    const filas = document.querySelectorAll('#tablaAvanceSiembra tbody tr');
    const cultivosGuardados = [];
    
    filas.forEach(fila => {
        // Ignorar fila de totales
        if (fila.classList.contains('fila-totales-finales')) return;
        
        const cultivo = fila.querySelector('.cultivo-nombre')?.innerText?.trim();
        const areaSemana = parseFloat(fila.querySelector('.area-semana')?.value) || 0;
        const volBruto = parseFloat(fila.querySelector('.volBruto')?.innerText) || 0;
        const volCorregido = parseFloat(fila.querySelector('.volCorregido')?.innerText) || 0;
        const qTeorico = parseFloat(fila.querySelector('.qTeorico')?.innerText) || 0;
        
        // SOLO guardar si tiene caudal te√≥rico > 0
        if (qTeorico > 0) {
            cultivosGuardados.push({
                cultivo: cultivo || '-',
                areaSemana: areaSemana,
                volBruto: volBruto,
                volCorregido: volCorregido,
                qTeorico: qTeorico
            });
        }
    });
    
    if (cultivosGuardados.length === 0) {
        alert('No hay cultivos con √°rea o caudal para guardar');
        return;
    }
    
    const datosToma = {
        toma: tomaActual,
        semanaInicio: semanaPDA.fechaInicio,
        semanaFin: semanaPDA.fechaFin,
        fechaGuardado: new Date().toLocaleString('es-PE'),
        cultivos: cultivosGuardados,
        totalArea: cultivosGuardados.reduce((sum, c) => sum + c.areaSemana, 0),
        totalVolBruto: cultivosGuardados.reduce((sum, c) => sum + c.volBruto, 0),
        totalVolCorregido: cultivosGuardados.reduce((sum, c) => sum + c.volCorregido, 0),
        totalQTeorico: cultivosGuardados.reduce((sum, c) => sum + c.qTeorico, 0)
    };
    
    // ‚úÖ SI EXISTE, REEMPLAZAR; SI NO, AGREGAR (PRESERVAR TODAS LAS DEM√ÅS)
    if (indiceExistente >= 0) {
        consolidadoDemandas[indiceExistente] = datosToma;
        console.log(`üîÑ Toma ${tomaActual} actualizada en el consolidado (posici√≥n ${indiceExistente})`);
    } else {
        consolidadoDemandas.push(datosToma);
        console.log(`‚ûï Toma ${tomaActual} agregada al consolidado`);
    }
    
    // ‚úÖ DEBUG: Mostrar estado completo del consolidado
    console.log(`üìä Total de tomas en consolidado: ${consolidadoDemandas.length}`);
    console.log('‚úÖ Tomas guardadas:', consolidadoDemandas.map(t => `${t.toma}(${t.cultivos.length}cult)`).join(', '));
    
    // ‚úÖ Solo limpiar Anexo G2 para forzar regeneraci√≥n, NUNCA el consolidado
    if (datosAnexoG2.length > 0) {
        console.log("üîÑ Anexo G2 se regenerar√° con datos actualizados");
        datosAnexoG2 = [];
    }
    
    // ‚úÖ Mostrar alerta visual con el estado del consolidado
    mostrarMensajeGuardadoExitoso(tomaActual, cultivosGuardados.length, consolidadoDemandas.length);
    
    mostrarMensajeGuardadoExitoso(tomaActual, cultivosGuardados.length);
}
function verificarEstadoConsolidado() {
    console.log("=== ESTADO DEL CONSOLIDADO ===");
    console.log(`Total de tomas: ${consolidadoDemandas.length}`);
    console.log("Tomas guardadas:");
    consolidadoDemandas.forEach((toma, index) => {
        console.log(`  ${index + 1}. ${toma.toma} - ${toma.cultivos.length} cultivos - ${toma.totalQTeorico.toFixed(3)} m¬≥/s`);
    });
    console.log("==============================");
}
function guardarEnConsolidadoDemandas() {
    const tomaActual = window.tomaActualSeleccionada || window.datosGrupoActual?.tomas[0];
    if (!tomaActual) {
        alert('No se pudo identificar la toma actual');
        return;
    }
    
    // Verificar si ya existe esta toma en el consolidado
    const indiceExistente = consolidadoDemandas.findIndex(item => item.toma === tomaActual);
    
    // Extraer datos de la tabla
    const filas = document.querySelectorAll('#tablaAvanceSiembraGrupo tbody tr');
    const cultivosGuardados = [];
    
filas.forEach(fila => {
    // Ignorar filas de totales
    if (fila.classList.contains('fila-sumatoria-toma')) return;
    
    const cultivo = fila.querySelector('.cultivo-nombre')?.innerText?.trim();
    const areaSemana = parseFloat(fila.querySelector('.area-semana')?.value) || 0;
    const volBruto = parseFloat(fila.querySelector('.volBruto')?.innerText) || 0;
    const volCorregido = parseFloat(fila.querySelector('.volCorregido')?.innerText) || 0;
    const qTeorico = parseFloat(fila.querySelector('.qTeorico')?.innerText) || 0;
    
    // SOLO guardar si tiene caudal te√≥rico > 0
    if (qTeorico > 0) {
        cultivosGuardados.push({
            cultivo: cultivo || '-',
            areaSemana: areaSemana,
            volBruto: volBruto,
            volCorregido: volCorregido,
            qTeorico: qTeorico
        });
    }
});
    
    // Si no hay cultivos con datos, no guardar
    if (cultivosGuardados.length === 0) {
        alert('No hay cultivos con √°rea o caudal para guardar');
        return;
    }
    
    const datosToma = {
    toma: tomaActual,
    semanaInicio: semanaPDA.fechaInicio,
    semanaFin: semanaPDA.fechaFin,
    fechaGuardado: new Date().toLocaleString('es-PE'),
    cultivos: cultivosGuardados,
    totalArea: cultivosGuardados.reduce((sum, c) => sum + c.areaSemana, 0),
    totalVolBruto: cultivosGuardados.reduce((sum, c) => sum + c.volBruto, 0),
    totalVolCorregido: cultivosGuardados.reduce((sum, c) => sum + c.volCorregido, 0),
    totalQTeorico: cultivosGuardados.reduce((sum, c) => sum + c.qTeorico, 0)
};
    
    // Si ya existe, reemplazar; si no, agregar
    if (indiceExistente >= 0) {
        consolidadoDemandas[indiceExistente] = datosToma;
    } else {
        consolidadoDemandas.push(datosToma);
    }
    // ‚úÖ REGENERAR ANEXO G2 CON DATOS ACTUALIZADOS (si ya existe)
    if (datosAnexoG2.length > 0) {
        console.log("üîÑ Regenerando Anexo G2 con datos actualizados...");
        datosAnexoG2 = []; // Forzar regeneraci√≥n
    }
    // Mostrar mensaje de √©xito
    mostrarMensajeGuardadoExitoso(tomaActual, cultivosGuardados.length);
}
function mostrarMensajeGuardadoExitoso(nombreToma, cantidadCultivos, totalTomas = null) {
    const total = totalTomas || consolidadoDemandas.length;
    const listaTomas = consolidadoDemandas.map(t => t.toma).join(', ');
    
    const modalHTML = `
        <div id="modalGuardadoExitoso" class="modal-overlay active">
            <div class="modal-container" style="max-width: 450px; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 15px;">‚úÖ</div>
                <h3 style="color: #28a745; margin-bottom: 15px;">¬°GUARDADO CON √âXITO!</h3>
                
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                    <p><strong>‚úì Toma guardada:</strong> ${nombreToma}</p>
                    <p><strong>‚úì Cultivos con caudal:</strong> ${cantidadCultivos}</p>
                    <hr style="border-color: #28a745; margin: 10px 0;">
                    <p style="color: #155724; font-weight: bold;">
                        üìä Total acumulado en consolidado: ${total} toma(s)
                    </p>
                    <p style="font-size: 10px; color: #666; margin-top: 5px; word-break: break-all;">
                        ${listaTomas}
                    </p>
                    <p style="font-size: 11px; color: #666; margin-top: 8px; font-style: italic;">
                        ‚ÑπÔ∏è Puedes continuar agregando m√°s tomas. El consolidado se mantendr√°.
                    </p>
                </div>
                
                <button onclick="cerrarModalGuardadoExitoso()" class="btn btn-primary" style="width: 100%;">
                    Aceptar
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}
function mostrarConsolidadoDemandas() {
    if (consolidadoDemandas.length === 0) {
        alert('No hay datos guardados en el consolidado');
        return;
    }
    
    // Obtener semana del primer registro (todos deber√≠an ser de la misma semana)
    const semanaTexto = consolidadoDemandas[0].semanaInicio && consolidadoDemandas[0].semanaFin 
        ? `DEL ${formatearFecha(consolidadoDemandas[0].semanaInicio)} AL ${formatearFecha(consolidadoDemandas[0].semanaFin)}`
        : 'SEMANA NO ESPECIFICADA';
    
    let html = `
        <div style="text-align:center; margin-bottom:20px;">
            <div style="
                border:2px solid #0070c0;
                display:inline-block;
                padding:10px 30px;
                font-weight:bold;
                font-size:18px;
                margin-bottom:10px;
                background: #e3f2fd;
            ">
                CONSOLIDADO DE DEMANDAS DE AGUA SEMANAL
            </div>
            
            <div style="
                margin-top:5px; 
                font-size:14px; 
                font-weight:bold; 
                color: #0070c0;
                background: #fff3cd;
                display: inline-block;
                padding: 5px 15px;
                border-radius: 4px;
            ">
                SEMANA ${semanaTexto}
            </div>
            
            <div style="margin-top:10px; font-size:13px; color: #666;">
                <strong>Total de tomas guardadas:</strong> ${consolidadoDemandas.length}
            </div>
        </div>

        <div style="text-align:right; margin-bottom:15px;">
    <button onclick="exportarConsolidadoAExcel()" 
        style="background:#217346; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold; margin-right:8px; font-size:12px;">
        üìä Excel
    </button>
    <button onclick="imprimirConsolidado()" 
        style="background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold; margin-right:8px; font-size:12px;">
        üñ®Ô∏è Imprimir
    </button>
    <button onclick="mostrarAnexoG2()" 
        style="background:#0070c0; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold; margin-right:8px; font-size:12px;">
        üìã Anexo G2
    </button>
    <button onclick="volverAReporteActual()" 
        style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:12px;">
        ‚¨ÖÔ∏è Volver
    </button>
</div>
    `;
    
    // Tabla consolidada simplificada
    html += `
        <table class="report-table avance-siembra" id="tablaConsolidadoDemandas">
            <thead>
                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <th>TOMA</th>
                    <th>CULTIVO</th>
                    <th>√ÅREA SEMANA<br><small>(ha)</small></th>
                    <th>VOL BRUTO<br><small>(m¬≥)</small></th>
                    <th>VOL CORREGIDO<br><small>(m¬≥)</small></th>
                    <th>Q TE√ìRICO<br><small>(m¬≥/s)</small></th>
                </tr>
            </thead>
            <tbody>
    `;
    
    consolidadoDemandas.forEach((toma, indexToma) => {
        const numCultivos = toma.cultivos.length;
        
        toma.cultivos.forEach((cultivo, indexCultivo) => {
            const esPrimeraFila = indexCultivo === 0;
            
            html += `
                <tr style="${indexToma % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                    ${esPrimeraFila ? `<td rowspan="${numCultivos}" style="font-weight:bold; background: #e3f2fd; vertical-align: middle;">${toma.toma}</td>` : ''}
                    <td style="font-weight:600;">${cultivo.cultivo}</td>
                    <td style="text-align:center; font-weight:bold; color: ${cultivo.areaSemana > 0 ? '#0070c0' : '#666'};">${cultivo.areaSemana.toFixed(2)}</td>
                    <td style="text-align:center;">${cultivo.volBruto.toFixed(2)}</td>
                    <td style="text-align:center; font-weight:bold;">${cultivo.volCorregido.toFixed(2)}</td>
                    <td style="text-align:center; font-weight:bold; color: ${cultivo.qTeorico > 0 ? '#28a745' : '#666'};">${cultivo.qTeorico.toFixed(3)}</td>
                </tr>
            `;
        });
        
        // Fila de totales por toma
        html += `
            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold;">
                <td colspan="2" style="text-align:right; padding-right:15px;">TOTAL ${toma.toma}:</td>
                <td style="text-align:center;">${toma.totalArea.toFixed(2)}</td>
                <td style="text-align:center;">${toma.totalVolBruto.toFixed(2)}</td>
                <td style="text-align:center;">${toma.totalVolCorregido.toFixed(2)}</td>
                <td style="text-align:center;">${toma.totalQTeorico.toFixed(3)}</td>
            </tr>
        `;
    });
    
    // Fila de totales general
    const totalGeneralArea = consolidadoDemandas.reduce((sum, t) => sum + t.totalArea, 0);
    const totalGeneralVolBruto = consolidadoDemandas.reduce((sum, t) => sum + t.totalVolBruto, 0);
    const totalGeneralVol = consolidadoDemandas.reduce((sum, t) => sum + t.totalVolCorregido, 0);
    const totalGeneralQ = consolidadoDemandas.reduce((sum, t) => sum + t.totalQTeorico, 0);
    
    html += `
            <tr style="background: #155724; color: white; font-weight: bold; font-size: 14px;">
                <td colspan="2" style="text-align:right; padding-right:15px;">TOTAL GENERAL:</td>
                <td style="text-align:center;">${totalGeneralArea.toFixed(2)}</td>
                <td style="text-align:center;">${totalGeneralVolBruto.toFixed(2)}</td>
                <td style="text-align:center;">${totalGeneralVol.toFixed(2)}</td>
                <td style="text-align:center;">${totalGeneralQ.toFixed(3)}</td>
            </tr>
        </tbody>
        </table>
        
        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <strong>üìä Resumen Consolidado:</strong><br>
            Tomas guardadas: ${consolidadoDemandas.length} | 
            √Årea total: ${totalGeneralArea.toFixed(2)} ha | 
            Volumen bruto total: ${totalGeneralVolBruto.toFixed(2)} m¬≥ | 
            Volumen corregido total: ${totalGeneralVol.toFixed(2)} m¬≥
        </div>
    `;
    
    // Guardar contenido actual para poder volver
    window.contenidoAnterior = contentArea.innerHTML;
    
    contentArea.innerHTML = html;
    
    // Ocultar botones de exportar individuales
    exportButtons.classList.remove('show');
}
function volverAReporteActual() {
    if (window.contenidoAnterior) {
        contentArea.innerHTML = window.contenidoAnterior;
        exportButtons.classList.add('show');
    } else {
        // Si no hay contenido anterior, regenerar el reporte de la toma actual
        if (window.tomaActualSeleccionada) {
            generarAvanceSiembraPorTomaEspecifica(window.tomaActualSeleccionada);
        } else {
            mostrarSelectorDeGrupos();
        }
    }
}
function exportarConsolidadoAExcel() {
    if (consolidadoDemandas.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    const datosExcel = [];
    
    // T√≠tulo y semana
    const semanaTexto = consolidadoDemandas[0].semanaInicio && consolidadoDemandas[0].semanaFin 
        ? `DEL ${formatearFecha(consolidadoDemandas[0].semanaInicio)} AL ${formatearFecha(consolidadoDemandas[0].semanaFin)}`
        : 'SEMANA NO ESPECIFICADA';
    
    datosExcel.push(['CONSOLIDADO DE DEMANDAS DE AGUA SEMANAL - CUSSHMI']);
    datosExcel.push([`SEMANA: ${semanaTexto}`]);
    datosExcel.push(['Fecha de exportaci√≥n:', new Date().toLocaleString('es-PE')]);
    datosExcel.push(['Total de tomas:', consolidadoDemandas.length]);
    datosExcel.push([]);
    
    // Encabezados simplificados
    datosExcel.push([
        'TOMA', 'CULTIVO', '√ÅREA SEMANA (ha)', 
        'VOL BRUTO (m¬≥)', 'VOL CORREGIDO (m¬≥)', 'Q TE√ìRICO (m¬≥/s)'
    ]);
    
    // Datos
    consolidadoDemandas.forEach(toma => {
        toma.cultivos.forEach(cultivo => {
            datosExcel.push([
                toma.toma,
                cultivo.cultivo,
                cultivo.areaSemana,
                cultivo.volBruto,
                cultivo.volCorregido,
                cultivo.qTeorico
            ]);
        });
        
        // Fila de totales por toma
        datosExcel.push([
            `TOTAL ${toma.toma}`,
            '',
            toma.totalArea,
            toma.totalVolBruto,
            toma.totalVolCorregido,
            toma.totalQTeorico
        ]);
        
        // Fila vac√≠a entre tomas
        datosExcel.push([]);
    });
    
    // Totales generales
    const totalGeneralArea = consolidadoDemandas.reduce((sum, t) => sum + t.totalArea, 0);
    const totalGeneralVolBruto = consolidadoDemandas.reduce((sum, t) => sum + t.totalVolBruto, 0);
    const totalGeneralVol = consolidadoDemandas.reduce((sum, t) => sum + t.totalVolCorregido, 0);
    const totalGeneralQ = consolidadoDemandas.reduce((sum, t) => sum + t.totalQTeorico, 0);
    
    datosExcel.push([
        'TOTAL GENERAL',
        '',
        totalGeneralArea,
        totalGeneralVolBruto,
        totalGeneralVol,
        totalGeneralQ
    ]);
    
    // Crear libro
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(datosExcel);
    
    // Ajustar anchos
    ws['!cols'] = [
        {wch: 12}, {wch: 25}, {wch: 18}, 
        {wch: 18}, {wch: 20}, {wch: 18}
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, "Consolidado Demandas");
    
    const fecha = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Consolidado_Demandas_${fecha}.xlsx`);
}
function imprimirConsolidado() {
    if (consolidadoDemandas.length === 0) {
        alert('No hay datos para imprimir');
        return;
    }
    
    // Crear ventana de impresi√≥n
    const ventanaImpresion = window.open('', '_blank', 'width=1200,height=800');
    
    // Obtener semana
    const semanaTexto = consolidadoDemandas[0].semanaInicio && consolidadoDemandas[0].semanaFin 
        ? `DEL ${formatearFecha(consolidadoDemandas[0].semanaInicio)} AL ${formatearFecha(consolidadoDemandas[0].semanaFin)}`
        : 'SEMANA NO ESPECIFICADA';
    
    // Calcular totales generales
    const totalGeneralArea = consolidadoDemandas.reduce((sum, t) => sum + t.totalArea, 0);
    const totalGeneralVolBruto = consolidadoDemandas.reduce((sum, t) => sum + t.totalVolBruto, 0);
    const totalGeneralVol = consolidadoDemandas.reduce((sum, t) => sum + t.totalVolCorregido, 0);
    const totalGeneralQ = consolidadoDemandas.reduce((sum, t) => sum + t.totalQTeorico, 0);
    
    // Construir HTML de la tabla
    let tablaHTML = '';
    
    consolidadoDemandas.forEach((toma, indexToma) => {
        const numCultivos = toma.cultivos.length;
        const bgColor = indexToma % 2 === 0 ? '#f8f9fa' : '#ffffff';
        
        toma.cultivos.forEach((cultivo, indexCultivo) => {
            const esPrimeraFila = indexCultivo === 0;
            
            tablaHTML += `
                <tr style="background-color: ${bgColor};">
                    ${esPrimeraFila ? `<td rowspan="${numCultivos}" style="border: 1px solid #333; padding: 6px; text-align: center; font-weight: bold; background-color: #e3f2fd; vertical-align: middle;">${toma.toma}</td>` : ''}
                    <td style="border: 1px solid #333; padding: 6px;">${cultivo.cultivo}</td>
                    <td style="border: 1px solid #333; padding: 6px; text-align: right;">${cultivo.areaSemana.toFixed(2)}</td>
                    <td style="border: 1px solid #333; padding: 6px; text-align: right;">${cultivo.volBruto.toFixed(2)}</td>
                    <td style="border: 1px solid #333; padding: 6px; text-align: right; font-weight: bold;">${cultivo.volCorregido.toFixed(2)}</td>
                    <td style="border: 1px solid #333; padding: 6px; text-align: right; font-weight: bold;">${cultivo.qTeorico.toFixed(3)}</td>
                </tr>
            `;
        });
        
        // Fila de totales por toma
        tablaHTML += `
            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold;">
                <td colspan="2" style="border: 1px solid #333; padding: 6px; text-align: right;">TOTAL ${toma.toma}:</td>
                <td style="border: 1px solid #333; padding: 6px; text-align: right;">${toma.totalArea.toFixed(2)}</td>
                <td style="border: 1px solid #333; padding: 6px; text-align: right;">${toma.totalVolBruto.toFixed(2)}</td>
                <td style="border: 1px solid #333; padding: 6px; text-align: right;">${toma.totalVolCorregido.toFixed(2)}</td>
                <td style="border: 1px solid #333; padding: 6px; text-align: right;">${toma.totalQTeorico.toFixed(3)}</td>
            </tr>
        `;
    });
    
    // HTML completo de la ventana
    const htmlCompleto = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Consolidado Demandas - CUSSHMI</title>
            <style>
                @page {
                    size: landscape;
                    margin: 10mm;
                }
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                    font-size: 11px;
                }
                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 3px solid #0070c0;
                    padding-bottom: 15px;
                }
                .header h2 {
                    color: #0070c0;
                    margin: 0;
                    font-size: 18px;
                }
                .header p {
                    margin: 5px 0;
                }
                .semana {
                    font-size: 14px;
                    font-weight: bold;
                    color: #333;
                    margin: 8px 0;
                }
                .subtitulo {
                    font-size: 11px;
                    color: #666;
                }
                .fecha {
                    font-size: 10px;
                    color: #999;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 15px;
                }
                th {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: 1px solid #333;
                    padding: 8px;
                    text-align: center;
                    font-size: 10px;
                }
                td {
                    border: 1px solid #333;
                    padding: 6px;
                }
                .total-general {
                    background-color: #155724;
                    color: white;
                    font-weight: bold;
                    font-size: 12px;
                }
                .resumen {
                    margin-top: 15px;
                    padding: 10px;
                    background-color: #fff3cd;
                    border-left: 4px solid #ffc107;
                    font-size: 10px;
                }
                .no-print {
                    margin-top: 20px;
                    text-align: center;
                }
                .btn-print {
                    background: #0070c0;
                    color: white;
                    border: none;
                    padding: 10px 30px;
                    font-size: 14px;
                    cursor: pointer;
                    border-radius: 6px;
                }
                @media print {
                    .no-print {
                        display: none;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>CONSOLIDADO DE DEMANDAS DE AGUA SEMANAL</h2>
                <p class="semana">SEMANA ${semanaTexto}</p>
                <p class="subtitulo">CUSSHMI - Unidad de Operaci√≥n y Tarifas</p>
                <p class="fecha">Generado: ${new Date().toLocaleString('es-PE')}</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>TOMA</th>
                        <th>CULTIVO</th>
                        <th>√ÅREA SEMANA<br>(ha)</th>
                        <th>VOL BRUTO<br>(m¬≥)</th>
                        <th>VOL CORREGIDO<br>(m¬≥)</th>
                        <th>Q TE√ìRICO<br>(m¬≥/s)</th>
                    </tr>
                </thead>
                <tbody>
                    ${tablaHTML}
                    <tr class="total-general">
                        <td colspan="2" style="text-align: right; padding-right: 15px;">TOTAL GENERAL:</td>
                        <td style="text-align: right;">${totalGeneralArea.toFixed(2)}</td>
                        <td style="text-align: right;">${totalGeneralVolBruto.toFixed(2)}</td>
                        <td style="text-align: right;">${totalGeneralVol.toFixed(2)}</td>
                        <td style="text-align: right;">${totalGeneralQ.toFixed(3)}</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="resumen">
                <strong>Resumen:</strong> ${consolidadoDemandas.length} tomas guardadas | 
                √Årea total: ${totalGeneralArea.toFixed(2)} ha | 
                Volumen bruto total: ${totalGeneralVolBruto.toFixed(2)} m¬≥ | 
                Volumen corregido total: ${totalGeneralVol.toFixed(2)} m¬≥
            </div>
            
            <div class="no-print">
                <button class="btn-print" onclick="window.print(); setTimeout(function(){ window.close(); }, 500);">
                    üñ®Ô∏è Imprimir / Guardar como PDF
                </button>
                <p style="font-size: 10px; color: #666; margin-top: 10px;">
                    Para guardar como PDF, selecciona "Guardar como PDF" en las opciones de impresi√≥n
                </p>
            </div>
        </body>
        </html>
    `;
    
    // Escribir en la ventana
    ventanaImpresion.document.write(htmlCompleto);
    ventanaImpresion.document.close();
}
function generarDatosAnexoG2() {
    if (consolidadoDemandas.length === 0) {
        alert('No hay datos en el consolidado para generar el Anexo G2');
        return null;
    }
    
    datosAnexoG2 = [];
    let item = 1;
    
    // Mapeo de tomas a canales de derivaci√≥n
    const mapeoCanales = {
        'SD3': 'SD3', 'SI3': 'SI3', 'SD4': 'SD4', 'SI4': 'SI4',
        'SD5': 'SD5', 'SI5': 'SI5', 'SD6': 'SD6', 'SD7': 'SD7',
        'SD8': 'SD8', 'SD8.1': 'SD8.1', 'SI6': 'SI.6', 'SD9': 'SD9',
        'SD10': 'SD10', 'SD11': 'SD11', 'SI7': 'SI 7', 'SD12': 'SD12',
        'SD12.1': 'SD12.1', 'SD13': 'SD13', 'SD14': 'SD14', 'SD14.1': 'SD14.I',
        'AGROAURORA': 'AGROAURORA', 'AGRICOLA DEL CHIRA': 'AGRICOLA DEL CHIRA',
        'SIFON TAPIA 13+652': 'SIFON TAPIA 13+652',
        'SIFON PALOMINO SD10': 'SIFON PALOMINO SD10',
        'SIFON HERRERA SI7': 'SIFON HERRERA SI7'
    };
    
    // Procesar cada toma del consolidado
    consolidadoDemandas.forEach(toma => {
        const nombreToma = toma.toma;
        const canalDerivacion = mapeoCanales[nombreToma] || nombreToma;
        
        // ‚úÖ CALCULAR N√öMERO DE USUARIOS: Aptos + No Aptos Programados
        let numUsuariosAptos = 0;
        let numUsuariosNoAptos = 0;
        
        // Buscar datos originales de la toma
        let usuariosToma = null;
        let nombreHojaToma = null;
        
        // Buscar en tomasData la hoja correspondiente
        for (let hoja in tomasData) {
            if (hoja.toUpperCase().includes(nombreToma.toUpperCase()) || 
                nombreToma.toUpperCase().includes(hoja.toUpperCase()) ||
                hoja === nombreToma) {
                usuariosToma = tomasData[hoja];
                nombreHojaToma = hoja;
                break;
            }
        }
        
        if (usuariosToma) {
            const deudaMax = parseFloat(document.getElementById('deudaMinima')?.value) || 0;
            
            // Contar usuarios aptos (con derecho de uso de agua)
            usuariosToma.forEach(u => {
                if (debeExcluirse(u)) return; // No contar excluidos
                
                const esApto = esUsuarioApto(u, deudaMax);
                const tieneCaudalEnConsolidado = toma.cultivos.some(c => 
                    c.cultivo === u.cultivo1 && c.qTeorico > 0
                );
                
                // Si es apto y tiene caudal en el consolidado, contar
                if (esApto && tieneCaudalEnConsolidado) {
                    numUsuariosAptos++;
                }
            });
        }
        
        // ‚úÖ CONTAR USUARIOS NO APTOS PROGRAMADOS DE ESTA TOMA (VARIABLES GLOBALES ACTUALES)
        numUsuariosNoAptos = 0;
        
        // Verificar en window.usuariosProgramados (contexto toma individual)
        const programadosWindow = window.usuariosProgramados || [];
        const deEstaTomaWindow = programadosWindow.filter(u => {
            const tomaUsuario = (u._tomaOrigen || '').toString().trim().toUpperCase();
            const tomaActual = nombreToma.toString().trim().toUpperCase();
            return tomaUsuario === tomaActual || 
                   tomaUsuario.includes(tomaActual) || 
                   tomaActual.includes(tomaUsuario);
        }).length;
        numUsuariosNoAptos += deEstaTomaWindow;
        
        // Verificar en usuariosProgramados (variable global)
        const programadosGlobal = usuariosProgramados || [];
        const deEstaTomaGlobal = programadosGlobal.filter(u => {
            const tomaUsuario = (u._tomaOrigen || u.toma || '').toString().trim().toUpperCase();
            const tomaActual = nombreToma.toString().trim().toUpperCase();
            return tomaUsuario === tomaActual || 
                   tomaUsuario.includes(tomaActual) || 
                   tomaActual.includes(tomaUsuario);
        }).length;
        
        // Usar el m√°ximo de ambos conteos (evitar duplicados)
        numUsuariosNoAptos = Math.max(numUsuariosNoAptos, deEstaTomaGlobal);
        
        console.log(`   Usuarios no aptos programados encontrados: ${numUsuariosNoAptos}`);
        
        // Total de usuarios beneficiados
        const totalUsuarios = numUsuariosAptos + numUsuariosNoAptos;
        
        // Debug en consola
        console.log(`Toma ${nombreToma}: Aptos=${numUsuariosAptos}, No Aptos Programados=${numUsuariosNoAptos}, Total=${totalUsuarios}`);
        
        // Determinar qu√© volumen usar: programado (si existe) o original
        const tieneProgramacion = toma.programacion && toma.programacion.diasProgramados > 0;
        
        // Calcular totales de la toma
        const volumenOriginal = toma.totalVolCorregido; // Siempre el de 7 d√≠as
        const volumenProgramado = tieneProgramacion ? toma.programacion.volumenProgramado : volumenOriginal;
        const areaTotal = toma.totalArea;
        
        // Calcular caudal ajustado seg√∫n la programaci√≥n
        let caudalAjustado;
        let diasOperacion = 7;
        let caudalesPorDia = {};
        
        if (tieneProgramacion) {
            // Usar los caudales programados por d√≠a
            diasOperacion = toma.programacion.diasProgramados;
            caudalesPorDia = toma.programacion.caudalesPorDia;
            
            // Calcular caudal promedio para el G2
            const caudalTotal = Object.values(caudalesPorDia).reduce((sum, c) => sum + c, 0);
            caudalAjustado = parseFloat((caudalTotal / diasOperacion).toFixed(3)); // Promedio ponderado
        } else {
            // Sin programaci√≥n: distribuir equitativamente en 7 d√≠as
            caudalAjustado = toma.totalQTeorico;
            const caudalPorDia = parseFloat((volumenOriginal / (7 * 86400)).toFixed(3));
            caudalesPorDia = {
                lunes: caudalPorDia, martes: caudalPorDia, miercoles: caudalPorDia,
                jueves: caudalPorDia, viernes: caudalPorDia, sabado: caudalPorDia, domingo: caudalPorDia
            };
        }
        
        // Generar fila para el Anexo G2
        const filaG2 = {
            item: item,
            canalPrincipal: nombreToma.includes('AGRO') || nombreToma.includes('CHIRA') ? 'RIO CHIRA' : 'CANAL SUR',
            nombreCanalDerivacion: canalDerivacion,
            nombreToma: nombreToma,
            numUsuarios: totalUsuarios,
            numUsuariosAptos: numUsuariosAptos,
            numUsuariosNoAptos: numUsuariosNoAptos,
            // VOL√öMENES: Programado (usado) y Original (referencia)
            volumenProgramado: volumenProgramado, // Este es el que se muestra en el G2
            volumenOriginal: volumenOriginal, // Referencia de 7 d√≠as
            tieneProgramacion: tieneProgramacion,
            diferenciaVolumen: tieneProgramacion ? (volumenProgramado - volumenOriginal) : 0,
            areaRiego: areaTotal,
            tiempoOperacion: diasOperacion * 24, // Horas reales programadas
            caudalAjustado: caudalAjustado,
            periodoInicio: toma.semanaInicio,
            periodoFin: toma.semanaFin,
            // CAUDALES POR D√çA INDIVIDUALES desde la programaci√≥n (0 si no est√° programado)
            // CAUDALES POR D√çA INDIVIDUALES - VERIFICAR M√öLTIPLES POSIBLES CLAVES
            lunes: caudalesPorDia.lunes || caudalesPorDia.Lunes || 0,
            martes: caudalesPorDia.martes || caudalesPorDia.Martes || 0,
            miercoles: caudalesPorDia.miercoles || caudalesPorDia.mi√©rcoles || caudalesPorDia.Mi√©rcoles || 0,
            jueves: caudalesPorDia.jueves || caudalesPorDia.Jueves || 0,
            viernes: caudalesPorDia.viernes || caudalesPorDia.Viernes || 0,
            sabado: caudalesPorDia.sabado || caudalesPorDia.s√°bado || caudalesPorDia.S√°bado || 0,
            domingo: caudalesPorDia.domingo || caudalesPorDia.Domingo || 0,
            diasOperacion: diasOperacion
        };
        
        datosAnexoG2.push(filaG2);
        item++;
    });
    
    return datosAnexoG2;
}
// DEBUG: Verificar qu√© caudales llegan
        if (tieneProgramacion) {
            console.log(`=== TOMA ${nombreToma} ===`);
            console.log('Caudales por d√≠a en programacion:', toma.programacion.caudalesPorDia);
            console.log('Mi√©rcoles:', toma.programacion.caudalesPorDia.miercoles, toma.programacion.caudalesPorDia.mi√©rcoles);
            console.log('S√°bado:', toma.programacion.caudalesPorDia.sabado, toma.programacion.caudalesPorDia.s√°bado);
        }
function mostrarAnexoG2() {
    // ‚úÖ SIEMPRE REGENERAR DATOS DEL ANEXO G2 CON INFORMACI√ìN ACTUALIZADA
    // Limpiar datos anteriores para forzar rec√°lculo
    datosAnexoG2 = [];
    
    const datos = generarDatosAnexoG2();
    if (!datos) return;
    
    // Obtener semana del primer registro
    const semanaTexto = consolidadoDemandas[0]?.semanaInicio && consolidadoDemandas[0]?.semanaFin 
        ? `DEL ${formatearFecha(consolidadoDemandas[0].semanaInicio)} AL ${formatearFecha(consolidadoDemandas[0].semanaFin)}`
        : 'SEMANA NO ESPECIFICADA';
    
    const mesNombre = consolidadoDemandas[0]?.semanaInicio 
        ? obtenerNombreMes(consolidadoDemandas[0].semanaInicio)
        : 'NO ESPECIFICADO';
    
    let html = `
        <div style="text-align:center; margin-bottom:15px;">
            <div style="
                border:2px solid #0070c0;
                display:inline-block;
                padding:8px 25px;
                font-weight:bold;
                font-size:16px;
                margin-bottom:8px;
                background: #e3f2fd;
            ">
                ANEXO G2: Programaci√≥n de Distribuci√≥n del Agua a nivel de Canales de Distribuci√≥n
            </div>
            
            <div style="margin-top:5px; font-size:13px; font-weight:bold; color: #0070c0;">
                SEMANA ${semanaTexto} | MES: ${mesNombre}
            </div>
            
            <div style="margin-top:5px; font-size:11px; color: #666;">
                CUSSHMI - Comisi√≥n de Usuarios del Subsector Hidr√°ulico Margen Izquierda
            </div>
        </div>

        <div style="text-align:right; margin-bottom:10px;">
            <button onclick="exportarAnexoG2AExcel()" 
                style="background:#217346; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold; margin-right:8px; font-size:12px;">
                üìä Excel
            </button>
            <button onclick="imprimirAnexoG2()" 
                style="background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold; margin-right:8px; font-size:12px;">
                üñ®Ô∏è Imprimir
            </button>
            <button onclick="volverAConsolidado()" 
                style="background:#6c757d; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:12px;">
                ‚¨ÖÔ∏è Volver a Consolidado
            </button>
        </div>
    `;
    
    // TABLA ANEXO G2 - Estructura exacta del Excel
    html += `
        <div style="overflow-x:auto;">
            <table class="report-table" id="tablaAnexoG2" style="font-size: 10px; min-width: 1400px;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <th rowspan="2" style="padding: 6px; min-width: 80px;">NOMBRE DEL CANAL DE DERIVACI√ìN</th>
                        <th rowspan="2" style="padding: 6px; min-width: 60px;">NOMBRE TOMA</th>
                        <th rowspan="2" style="padding: 6px; min-width: 50px;">N¬∞ USUARIOS</th>
                        <th rowspan="2" style="padding: 6px; min-width: 80px;">VOLUMEN PROGRAMADO<br>(m¬≥)</th>
                        <th rowspan="2" style="padding: 6px; min-width: 60px;">√ÅREA BAJO RIEGO<br>(Ha)</th>
                        <th rowspan="2" style="padding: 6px; min-width: 70px;">TIEMPO OPERACI√ìN<br>(Horas)</th>
                        <th rowspan="2" style="padding: 6px; min-width: 60px;">CAUDAL AJUST.<br>(m¬≥/seg)</th>
                        <th colspan="2" style="padding: 6px;">PER√çODO</th>
                        <th colspan="7" style="padding: 6px;">CAUDAL PROGRAMADO POR D√çAS (m¬≥/seg)</th>
                        <th rowspan="2" style="padding: 6px; min-width: 40px;">D√çAS</th>
                    </tr>
                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <th style="padding: 4px; font-size: 9px;">INICIO</th>
                        <th style="padding: 4px; font-size: 9px;">T√âRMINO</th>
                        <th style="padding: 4px; font-size: 9px;">LUNES</th>
                        <th style="padding: 4px; font-size: 9px;">MARTES</th>
                        <th style="padding: 4px; font-size: 9px;">MI√âRCOLES</th>
                        <th style="padding: 4px; font-size: 9px;">JUEVES</th>
                        <th style="padding: 4px; font-size: 9px;">VIERNES</th>
                        <th style="padding: 4px; font-size: 9px;">S√ÅBADO</th>
                        <th style="padding: 4px; font-size: 9px;">DOMINGO</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Datos
    let totalVolumen = 0;
    let totalArea = 0;
    
    datosAnexoG2.forEach((fila, index) => {
        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
        
        // Sin indicador de programaci√≥n - solo datos limpios
        
        html += `
            <tr style="background-color: ${bgColor};">
                <td style="border: 1px solid #dee2e6; padding: 5px; font-weight: 600;">${fila.canalPrincipal}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px;">${fila.nombreToma}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: center; font-weight: 600; color: ${fila.numUsuarios > 0 ? '#155724' : '#666'};" title="Aptos: ${fila.numUsuariosAptos}, No Aptos Programados: ${fila.numUsuariosNoAptos}">
    ${fila.numUsuarios > 0 ? fila.numUsuarios : '-'}
</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; font-weight: 600; color: #155724;">
                    ${fila.volumenProgramado.toFixed(2)}
                </td>

                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right;">${fila.areaRiego.toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: center;">${fila.tiempoOperacion}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; font-weight: bold; color: #0070c0;" title="Preciso: ${fila.caudalAjustado} m¬≥/s">${parseFloat(fila.caudalAjustado.toFixed(3))}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: center; font-size: 9px;">${formatearFecha(fila.periodoInicio)}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: center; font-size: 9px;">${formatearFecha(fila.periodoFin)}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; ${fila.lunes > 0 ? '' : 'color: #999;'}">${fila.lunes > 0 ? fila.lunes.toFixed(3) : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; ${fila.martes > 0 ? '' : 'color: #999;'}">${fila.martes > 0 ? fila.martes.toFixed(3) : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; ${fila.miercoles > 0 ? '' : 'color: #999;'}">${fila.miercoles > 0 ? fila.miercoles.toFixed(3) : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; ${fila.jueves > 0 ? '' : 'color: #999;'}">${fila.jueves > 0 ? fila.jueves.toFixed(3) : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; ${fila.viernes > 0 ? '' : 'color: #999;'}">${fila.viernes > 0 ? fila.viernes.toFixed(3) : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; ${fila.sabado > 0 ? '' : 'color: #999;'}">${fila.sabado > 0 ? fila.sabado.toFixed(3) : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: right; ${fila.domingo > 0 ? '' : 'color: #999;'}">${fila.domingo > 0 ? fila.domingo.toFixed(3) : '-'}</td>
                <td style="border: 1px solid #dee2e6; padding: 5px; text-align: center; font-weight: bold;">${fila.diasOperacion}</td>
            </tr>
        `;
        
        totalVolumen += fila.volumenProgramado;
        totalArea += fila.areaRiego;
    });
    
    // Calcular totales generales
    const totalGeneralArea = datosAnexoG2.reduce((sum, t) => sum + t.areaRiego, 0);
    const totalGeneralVol = datosAnexoG2.reduce((sum, t) => sum + t.volumenProgramado, 0);
    
    // Calcular totales de caudal por d√≠a
    const totalLunes = datosAnexoG2.reduce((sum, t) => sum + t.lunes, 0);
    const totalMartes = datosAnexoG2.reduce((sum, t) => sum + t.martes, 0);
    const totalMiercoles = datosAnexoG2.reduce((sum, t) => sum + t.miercoles, 0);
    const totalJueves = datosAnexoG2.reduce((sum, t) => sum + t.jueves, 0);
    const totalViernes = datosAnexoG2.reduce((sum, t) => sum + t.viernes, 0);
    const totalSabado = datosAnexoG2.reduce((sum, t) => sum + t.sabado, 0);
    const totalDomingo = datosAnexoG2.reduce((sum, t) => sum + t.domingo, 0);
    
    html += `
            <tr style="background: #155724; color: white; font-weight: bold;">
                <td colspan="3" style="border: 1px solid #dee2e6; padding: 6px; text-align: right;">TOTALES:</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right;">${totalGeneralVol.toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right;">${totalGeneralArea.toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">-</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">-</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">-</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">-</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right; font-weight: bold;">${totalLunes.toFixed(3)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right; font-weight: bold;">${totalMartes.toFixed(3)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right; font-weight: bold;">${totalMiercoles.toFixed(3)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right; font-weight: bold;">${totalJueves.toFixed(3)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right; font-weight: bold;">${totalViernes.toFixed(3)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right; font-weight: bold;">${totalSabado.toFixed(3)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: right; font-weight: bold;">${totalDomingo.toFixed(3)}</td>
                <td style="border: 1px solid #dee2e6; padding: 6px; text-align: center;">-</td>
            </tr>
        </tbody>
        </table>
        </div>
        
       <div style="margin-top: 15px;">
    <label style="font-weight: bold; font-size: 12px; color: #333;">NOTA:</label>
    <textarea id="notaAnexoG2" style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 11px; font-family: inherit; resize: vertical;" placeholder="Escriba aqu√≠ las notas para el Anexo G2..."></textarea>
</div>
        
        <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 6px; font-size: 11px; text-align: center;">
            <strong>Resumen:</strong> ${datosAnexoG2.length} tomas | 
            Volumen Total: ${totalVolumen.toFixed(2)} m¬≥ | 
            √Årea Total: ${totalArea.toFixed(2)} ha
        </div>
    `;
    
    // Guardar referencia al consolidado para poder volver
    window.contenidoConsolidado = contentArea.innerHTML;
    
    contentArea.innerHTML = html;
    exportButtons.classList.remove('show');
}
function volverAConsolidado() {
    if (window.contenidoConsolidado) {
        contentArea.innerHTML = window.contenidoConsolidado;
        exportButtons.classList.remove('show');
    } else {
        mostrarConsolidadoDemandas();
    }
}
function exportarAnexoG2AExcel() {
    if (datosAnexoG2.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    const datosExcel = [];
    
    // T√≠tulo
    datosExcel.push(['ANEXO G2: Programaci√≥n de Distribuci√≥n del Agua a nivel de Canales de Distribuci√≥n']);
    datosExcel.push(['CUSSHMI - Comisi√≥n de Usuarios del Subsector Hidr√°ulico Margen Izquierda']);
    
    // Obtener nota del textarea si existe
    const notaTextarea = document.getElementById('notaAnexoG2');
    const notaContenido = notaTextarea ? notaTextarea.value.trim() : '';
    if (notaContenido) {
        datosExcel.push(['NOTA:', notaContenido]);
    }
    datosExcel.push([]);
    
    // Encabezados
    datosExcel.push([
        'NOMBRE DEL CANAL DE DERIVACI√ìN',
        'NOMBRE TOMA',
        'N¬∞ USUARIOS',
        'VOLUMEN PROGRAMADO (m¬≥)',
        '√ÅREA BAJO RIEGO (Ha)',
        'TIEMPO OPERACI√ìN (Horas)',
        'CAUDAL AJUST. (m¬≥/seg)',
        'PER√çODO INICIO',
        'PER√çODO T√âRMINO',
        'LUNES',
        'MARTES',
        'MI√âRCOLES',
        'JUEVES',
        'VIERNES',
        'S√ÅBADO',
        'DOMINGO',
        'D√çAS'
    ]);
    
    // Datos
    datosAnexoG2.forEach(fila => {
        datosExcel.push([
            fila.canalPrincipal,
            fila.nombreToma,
            fila.numUsuarios,
            fila.volumenProgramado,
            fila.areaRiego,
            fila.tiempoOperacion,
            fila.caudalAjustado,
            fila.periodoInicio,
            fila.periodoFin,
            parseFloat(fila.lunes.toFixed(3)),
parseFloat(fila.martes.toFixed(3)),
parseFloat(fila.miercoles.toFixed(3)),
parseFloat(fila.jueves.toFixed(3)),
parseFloat(fila.viernes.toFixed(3)),
parseFloat(fila.sabado.toFixed(3)),
parseFloat(fila.domingo.toFixed(3)),
            fila.diasOperacion
        ]);
    });
    
    // Crear libro
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(datosExcel);
    
    // Ajustar anchos
    ws['!cols'] = [
        {wch: 20}, {wch: 15}, {wch: 20}, {wch: 12}, {wch: 18},
        {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12},
        {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10},
        {wch: 10}, {wch: 10}, {wch: 8}
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, "Anexo G2");
    
    const fecha = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Anexo_G2_${fecha}.xlsx`);
}
function imprimirAnexoG2() {
    if (datosAnexoG2.length === 0) {
        alert('No hay datos para imprimir');
        return;
    }
    
    const ventanaImpresion = window.open('', '_blank', 'width=1400,height=900');
    
    const semanaTexto = consolidadoDemandas[0]?.semanaInicio && consolidadoDemandas[0]?.semanaFin 
        ? `DEL ${formatearFecha(consolidadoDemandas[0].semanaInicio)} AL ${formatearFecha(consolidadoDemandas[0].semanaFin)}`
        : 'SEMANA NO ESPECIFICADA';
    
    const mesNombre = consolidadoDemandas[0]?.semanaInicio 
        ? obtenerNombreMes(consolidadoDemandas[0].semanaInicio)
        : 'NO ESPECIFICADO';
    
    // Construir tabla
    let tablaHTML = '';
    let totalVolumen = 0;
    let totalArea = 0;
    
    datosAnexoG2.forEach((fila, index) => {
        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
        
        tablaHTML += `
            <tr style="background-color: ${bgColor}; font-size: 9px;">
                <td style="border: 1px solid #333; padding: 4px; font-weight: 600;">${fila.canalPrincipal}</td>
                <td style="border: 1px solid #333; padding: 4px;">${fila.nombreToma}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: center; font-weight: 600;">${fila.numUsuarios > 0 ? fila.numUsuarios : '-'}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.volumenProgramado.toFixed(2)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.areaRiego.toFixed(2)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: center;">${fila.tiempoOperacion}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right; font-weight: bold;">${fila.caudalAjustado.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: center; font-size: 8px;">${formatearFecha(fila.periodoInicio)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: center; font-size: 8px;">${formatearFecha(fila.periodoFin)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.lunes.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.martes.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.miercoles.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.jueves.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.viernes.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.sabado.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: right;">${fila.domingo.toFixed(3)}</td>
                <td style="border: 1px solid #333; padding: 4px; text-align: center; font-weight: bold;">${fila.diasOperacion}</td>
            </tr>
        `;
        
        totalVolumen += fila.volumenProgramado;
        totalArea += fila.areaRiego;
    });
    
    // Calcular totales de caudal por d√≠a
    const totalLunes = datosAnexoG2.reduce((sum, t) => sum + t.lunes, 0);
    const totalMartes = datosAnexoG2.reduce((sum, t) => sum + t.martes, 0);
    const totalMiercoles = datosAnexoG2.reduce((sum, t) => sum + t.miercoles, 0);
    const totalJueves = datosAnexoG2.reduce((sum, t) => sum + t.jueves, 0);
    const totalViernes = datosAnexoG2.reduce((sum, t) => sum + t.viernes, 0);
    const totalSabado = datosAnexoG2.reduce((sum, t) => sum + t.sabado, 0);
    const totalDomingo = datosAnexoG2.reduce((sum, t) => sum + t.domingo, 0);
    
    // Fila totales
    tablaHTML += `
        <tr style="background-color: #155724; color: white; font-weight: bold; font-size: 10px;">
            <td colspan="3" style="border: 1px solid #333; padding: 5px; text-align: right;">TOTALES:</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalVolumen.toFixed(2)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalArea.toFixed(2)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: center;">-</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: center;">-</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: center;">-</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: center;">-</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalLunes.toFixed(3)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalMartes.toFixed(3)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalMiercoles.toFixed(3)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalJueves.toFixed(3)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalViernes.toFixed(3)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalSabado.toFixed(3)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: right;">${totalDomingo.toFixed(3)}</td>
            <td style="border: 1px solid #333; padding: 5px; text-align: center;">-</td>
        </tr>
    `;
    
    const htmlCompleto = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Anexo G2 - CUSSHMI</title>
            <style>
                @page { size: landscape; margin: 8mm; }
                body { font-family: Arial, sans-serif; margin: 0; padding: 15px; font-size: 10px; }
                .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #0070c0; padding-bottom: 10px; }
                .header h2 { color: #0070c0; margin: 0; font-size: 14px; }
                .header p { margin: 4px 0; font-size: 10px; }
                table { width: 100%; border-collapse: collapse; }
                th { background-color: #667eea; color: white; border: 1px solid #333; padding: 5px; font-size: 9px; text-align: center; }
                td { border: 1px solid #333; padding: 4px; }
                .no-print { margin-top: 15px; text-align: center; }
                .btn-print { background: #0070c0; color: white; border: none; padding: 8px 25px; font-size: 12px; cursor: pointer; border-radius: 5px; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>ANEXO G2: Programaci√≥n de Distribuci√≥n del Agua</h2>
                <p style="font-weight: bold;">SEMANA ${semanaTexto} | MES: ${mesNombre}</p>
                <p>CUSSHMI - Comisi√≥n de Usuarios del Subsector Hidr√°ulico Margen Izquierda</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">CANAL DERIVACI√ìN</th>
                        <th rowspan="2">TOMA</th>
                        <th rowspan="2">USUARIOS</th>
                        <th rowspan="2">VOLUMEN (m¬≥)</th>
                        <th rowspan="2">√ÅREA (Ha)</th>
                        <th rowspan="2">HORAS</th>
                        <th rowspan="2">CAUDAL<br>(m¬≥/s)</th>
                        <th colspan="2">PER√çODO</th>
                        <th colspan="7">CAUDAL POR D√çAS (m¬≥/s)</th>
                        <th rowspan="2">D√çAS</th>
                    </tr>
                    <tr>
                        <th>INICIO</th>
                        <th>T√âRMINO</th>
                        <th>LUN</th>
                        <th>MAR</th>
                        <th>MI√â</th>
                        <th>JUE</th>
                        <th>VIE</th>
                        <th>S√ÅB</th>
                        <th>DOM</th>
                    </tr>
                </thead>
                <tbody>
                    ${tablaHTML}
                </tbody>
            </table>
            
            <div style="margin-top: 10px; padding: 8px; background: #fff3cd; font-size: 9px; border-left: 3px solid #ffc107;">
                <strong>NOTA:</strong> Los pedidos de agua se han realizado en plena coordinaci√≥n con cada delegado de toma.
            </div>
            
            <div class="no-print">
                <button class="btn-print" onclick="window.print(); setTimeout(function(){ window.close(); }, 500);">
                    üñ®Ô∏è Imprimir / Guardar PDF
                </button>
            </div>
        </body>
        </html>
    `;
    
    ventanaImpresion.document.write(htmlCompleto);
    ventanaImpresion.document.close();
}
function cerrarModalGuardadoExitoso() {
    const modal = document.getElementById('modalGuardadoExitoso');
    if (modal) {
        modal.remove();
    }
}
function cerrarModalDiasTurnados() {
    const modal = document.getElementById('modalDiasTurnados');
    if (modal) {
        modal.remove();
    }
}

function confirmarDiasTurnados() {
    const inputDias = document.getElementById('inputDiasTurnados');
    const diasTurnados = parseInt(inputDias.value);
    
    if (!diasTurnados || diasTurnados < 1 || diasTurnados > 7) {
        alert('Por favor ingresa un n√∫mero v√°lido entre 1 y 7');
        return;
    }
    
    // Cerrar modal
    cerrarModalDiasTurnados();
    
    // Si son 7 d√≠as, programar todos autom√°ticamente
    if (diasTurnados === 7) {
        const distribucion = {
            lunes: true, martes: true, miercoles: true, jueves: true,
            viernes: true, sabado: true, domingo: true
        };
        guardarTurnoRiegoConDias(diasTurnados, distribucion);
    } else {
        // Si son menos de 7 d√≠as, preguntar qu√© d√≠as espec√≠ficos
        mostrarSelectorDiasEspecificos(diasTurnados);
    }
}

function mostrarSelectorDiasEspecificos(diasTurnados) {
    const modalHTML = `
        <div id="modalSelectorDias" class="modal-overlay active">
            <div class="modal-container" style="max-width: 450px;">
                <h3>üìÖ SELECCIONAR D√çAS ESPEC√çFICOS</h3>
                
                <div class="info-text">
                    Debes seleccionar exactamente <strong>${diasTurnados} d√≠as</strong> para programar el caudal.
                </div>
                
                <div style="text-align: left; margin: 20px 0;">
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="diaLunes" value="lunes" onchange="validarCantidadDias(${diasTurnados})">
                        <label for="diaLunes">Lunes</label>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="diaMartes" value="martes" onchange="validarCantidadDias(${diasTurnados})">
                        <label for="diaMartes">Martes</label>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="diaMiercoles" value="miercoles" onchange="validarCantidadDias(${diasTurnados})">
                        <label for="diaMiercoles">Mi√©rcoles</label>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="diaJueves" value="jueves" onchange="validarCantidadDias(${diasTurnados})">
                        <label for="diaJueves">Jueves</label>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="diaViernes" value="viernes" onchange="validarCantidadDias(${diasTurnados})">
                        <label for="diaViernes">Viernes</label>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="diaSabado" value="sabado" onchange="validarCantidadDias(${diasTurnados})">
                        <label for="diaSabado">S√°bado</label>
                    </div>
                    <div class="checkbox-group" style="margin-bottom: 10px;">
                        <input type="checkbox" id="diaDomingo" value="domingo" onchange="validarCantidadDias(${diasTurnados})">
                        <label for="diaDomingo">Domingo</label>
                    </div>
                </div>
                
                <div id="mensajeValidacion" style="color: #dc3545; font-size: 12px; margin-bottom: 10px; display: none;">
                    ‚ö†Ô∏è Debes seleccionar exactamente ${diasTurnados} d√≠as
                </div>
                
                <button onclick="confirmarDiasEspecificos(${diasTurnados})" class="btn btn-primary" id="btnConfirmarDias" disabled>
                    ‚úÖ Confirmar D√≠as
                </button>
                
                <button onclick="cerrarModalSelectorDias()" class="btn btn-secondary" style="margin-top: 10px;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}

function validarCantidadDias(diasRequeridos) {
    const checkboxes = document.querySelectorAll('#modalSelectorDias input[type="checkbox"]:checked');
    const seleccionados = checkboxes.length;
    const mensaje = document.getElementById('mensajeValidacion');
    const btnConfirmar = document.getElementById('btnConfirmarDias');
    
    if (seleccionados === diasRequeridos) {
        mensaje.style.display = 'none';
        btnConfirmar.disabled = false;
    } else {
        mensaje.style.display = 'block';
        mensaje.innerText = `‚ö†Ô∏è Has seleccionado ${seleccionados} de ${diasRequeridos} d√≠as requeridos`;
        btnConfirmar.disabled = true;
    }
}

function cerrarModalSelectorDias() {
    const modal = document.getElementById('modalSelectorDias');
    if (modal) {
        modal.remove();
    }
}

function confirmarDiasEspecificos(diasTurnados) {
    const distribucion = {
        lunes: document.getElementById('diaLunes').checked,
        martes: document.getElementById('diaMartes').checked,
        miercoles: document.getElementById('diaMiercoles').checked,
        jueves: document.getElementById('diaJueves').checked,
        viernes: document.getElementById('diaViernes').checked,
        sabado: document.getElementById('diaSabado').checked,
        domingo: document.getElementById('diaDomingo').checked
    };
    
    cerrarModalSelectorDias();
    guardarTurnoRiegoConDias(diasTurnados, distribucion);
}

function guardarTurnoRiegoConDias(diasTurnados, distribucionDias) {
    const tomaSeleccionada = window.tomaActualSeleccionada;
    if (!tomaSeleccionada) {
        alert('No hay toma seleccionada');
        return;
    }
    
  // Calcular totales del cuadro de avance de siembra
    const totales = calcularTotalesTurnosRiego();
    
    // ‚úÖ VERIFICACI√ìN: Si no hay cultivos con √°rea, mostrar error
    if (totales.cultivosActivos === 0) {
        alert('Error: No hay cultivos con √°rea en la columna "√Årea Semana".\n\nPor favor:\n1. Verifica que hayas ingresado valores en "√Årea Semana"\n2. O programa usuarios no aptos para agregar √°rea');
        return;
    }
    
    // ‚úÖ CORRECCI√ìN: Calcular caudal por d√≠a correctamente
    // F√≥rmula: (Volumen Programado √∑ 86400) √∑ D√≠as Turnados
    const caudalPorSegundo = (totales.volumenProgramado / 86400) / diasTurnados;
    
    console.log("=== C√ÅLCULO CAUDAL ===");
    console.log("Volumen Programado:", totales.volumenProgramado);
    console.log("D√≠as Turnados:", diasTurnados);
    console.log("Caudal por segundo:", caudalPorSegundo);
    
    // Crear objeto con datos del turno de riego
    const datosTurnoRiego = {
        toma: tomaSeleccionada,
        semanaInicio: semanaPDA.fechaInicio,
        semanaFin: semanaPDA.fechaFin,
        diasTurnados: diasTurnados,
        volumenProgramado: totales.volumenProgramado,
        caudalAjustado: totales.caudalAjustado,
        caudalPorSegundo: caudalPorSegundo,
        totalArea: totales.totalArea,                    // ‚úÖ NUEVO
        cultivosActivos: totales.cultivosActivos,        // ‚úÖ NUEVO
        distribucionDias: distribucionDias,
        // Calcular caudal para cada d√≠a
        dias: {
            lunes: distribucionDias.lunes ? caudalPorSegundo : 0,
            martes: distribucionDias.martes ? caudalPorSegundo : 0,
            miercoles: distribucionDias.miercoles ? caudalPorSegundo : 0,
            jueves: distribucionDias.jueves ? caudalPorSegundo : 0,
            viernes: distribucionDias.viernes ? caudalPorSegundo : 0,
            sabado: distribucionDias.sabado ? caudalPorSegundo : 0,
            domingo: distribucionDias.domingo ? caudalPorSegundo : 0
        }
    };
    
    // Calcular caudal promedio (solo d√≠as programados)
    const diasProgramados = Object.values(distribucionDias).filter(v => v).length;
    const caudalPromedio = diasProgramados > 0 ? 
        (caudalPorSegundo * diasProgramados) / diasProgramados : 0;
    datosTurnoRiego.caudalPromedio = caudalPromedio;
    
    // Guardar en estructura global
    if (!window.turnosDeRiego) {
        window.turnosDeRiego = {};
    }
    window.turnosDeRiego[tomaSeleccionada] = datosTurnoRiego;
    
    // Mostrar confirmaci√≥n con datos calculados
    mostrarConfirmacionTurnoRiego(datosTurnoRiego);
}

function mostrarConfirmacionTurnoRiego(datos) {
    const modalHTML = `
        <div id="modalConfirmacionTurno" class="modal-overlay active">
            <div class="modal-container" style="max-width: 500px;">
                <h3>‚úÖ TURNO DE RIEGO GUARDADO</h3>
                
                <div style="text-align: left; background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><strong>TOMA:</strong> ${datos.toma}</p>
                    <p><strong>CULTIVOS PROGRAMADOS:</strong> ${datos.cultivosActivos}</p>
                    <p><strong>√ÅREA TOTAL SEMANA:</strong> ${datos.totalArea?.toFixed(2) || '0.00'} ha</p>
                    <p><strong>VOLUMEN PROGRAMADO:</strong> ${datos.volumenProgramado.toFixed(2)} m¬≥</p>
                    <p><strong>D√çAS TURNADOS:</strong> ${datos.diasTurnados}</p>
                    <p><strong>CAUDAL POR D√çA:</strong> ${datos.caudalPorSegundo.toFixed(6)} m¬≥/s</p>
                    <p style="font-size: 11px; color: #666; margin-top: 10px;">
                        F√≥rmula: (${datos.volumenProgramado.toFixed(2)} √∑ 86400) √∑ ${datos.diasTurnados} = ${datos.caudalPorSegundo.toFixed(6)} m¬≥/s
                    </p>
                </div>
                
               <table style="width: 100%; margin: 15px 0; font-size: 12px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #0070c0; color: white;">
                            <th>LUNES</th>
                            <th>MARTES</th>
                            <th>MI√âRCOLES</th>
                            <th>JUEVES</th>
                            <th>VIERNES</th>
                            <th>S√ÅBADO</th>
                            <th>DOMINGO</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="text-align: center; font-weight: bold; font-size: 14px;">
                            <td style="background: ${datos.distribucionDias.lunes ? '#d4edda' : '#f8f9fa'}; color: ${datos.distribucionDias.lunes ? '#155724' : '#6c757d'}; padding: 10px;">
                                ${datos.distribucionDias.lunes ? datos.caudalPorSegundo.toFixed(3) : '-'}
                            </td>
                            <td style="background: ${datos.distribucionDias.martes ? '#d4edda' : '#f8f9fa'}; color: ${datos.distribucionDias.martes ? '#155724' : '#6c757d'}; padding: 10px;">
                                ${datos.distribucionDias.martes ? datos.caudalPorSegundo.toFixed(3) : '-'}
                            </td>
                            <td style="background: ${datos.distribucionDias.miercoles ? '#d4edda' : '#f8f9fa'}; color: ${datos.distribucionDias.miercoles ? '#155724' : '#6c757d'}; padding: 10px;">
                                ${datos.distribucionDias.miercoles ? datos.caudalPorSegundo.toFixed(3) : '-'}
                            </td>
                            <td style="background: ${datos.distribucionDias.jueves ? '#d4edda' : '#f8f9fa'}; color: ${datos.distribucionDias.jueves ? '#155724' : '#6c757d'}; padding: 10px;">
                                ${datos.distribucionDias.jueves ? datos.caudalPorSegundo.toFixed(3) : '-'}
                            </td>
                            <td style="background: ${datos.distribucionDias.viernes ? '#d4edda' : '#f8f9fa'}; color: ${datos.distribucionDias.viernes ? '#155724' : '#6c757d'}; padding: 10px;">
                                ${datos.distribucionDias.viernes ? datos.caudalPorSegundo.toFixed(3) : '-'}
                            </td>
                            <td style="background: ${datos.distribucionDias.sabado ? '#d4edda' : '#f8f9fa'}; color: ${datos.distribucionDias.sabado ? '#155724' : '#6c757d'}; padding: 10px;">
                                ${datos.distribucionDias.sabado ? datos.caudalPorSegundo.toFixed(3) : '-'}
                            </td>
                            <td style="background: ${datos.distribucionDias.domingo ? '#d4edda' : '#f8f9fa'}; color: ${datos.distribucionDias.domingo ? '#155724' : '#6c757d'}; padding: 10px;">
                                ${datos.distribucionDias.domingo ? datos.caudalPorSegundo.toFixed(3) : '-'}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p style="text-align: center; font-size: 11px; color: #666; margin-top: 5px;">
                    ‚úÖ D√≠as verdes = Turnados con caudal de ${datos.caudalPorSegundo.toFixed(6)} m¬≥/s<br>
                    ‚ûñ D√≠as grises = No turnados
                </p>
                
                <button onclick="cerrarModalConfirmacionTurno()" class="btn btn-primary">
                    Aceptar
                </button>
                
                <button onclick="exportarTurnoRiegoAExcel('${datos.toma}')" class="btn btn-success" style="margin-top: 10px;">
                    üìä Exportar a Excel
                </button>
            </div>
        </div>
    `;
    
    const divModal = document.createElement('div');
    divModal.innerHTML = modalHTML;
    document.body.appendChild(divModal);
}

function cerrarModalConfirmacionTurno() {
    const modal = document.getElementById('modalConfirmacionTurno');
    if (modal) {
        modal.remove();
    }
}

function exportarTurnoRiegoAExcel(toma) {
    if (!window.turnosDeRiego || !window.turnosDeRiego[toma]) {
        alert('No hay datos para exportar');
        return;
    }
    
    const datos = window.turnosDeRiego[toma];
    
    // Crear datos en formato de la pesta√±a TURNOS DE RIEGO
    const datosExcel = [];
    
    // Encabezados seg√∫n formato exacto de la imagen
    datosExcel.push([
        'CANAL PRINCIPAL (L1)', 
        'TOMA', 
        'VOL.PROGRAM.', 
        'DIAS TURNADOS', 
        'CAUDAL AJUST.',
        'LUNES', 
        'MARTES', 
        'MIERCOLES', 
        'JUEVES', 
        'VIERNES', 
        'SABADO', 
        'DOMINGO',
        'CAUDAL PROM.'
    ]);
    
    // Fila de datos
    datosExcel.push([
        'CANAL SUR',
        datos.toma,
        datos.volumenProgramado.toFixed(2),
        datos.diasTurnados,
        datos.caudalAjustado.toFixed(3),
        datos.distribucionDias.lunes ? datos.caudalPorSegundo.toFixed(3) : '0',
            datos.distribucionDias.martes ? datos.caudalPorSegundo.toFixed(3) : '0',
            datos.distribucionDias.miercoles ? datos.caudalPorSegundo.toFixed(3) : '0',
            datos.distribucionDias.jueves ? datos.caudalPorSegundo.toFixed(3) : '0',
            datos.distribucionDias.viernes ? datos.caudalPorSegundo.toFixed(3) : '0',
            datos.distribucionDias.sabado ? datos.caudalPorSegundo.toFixed(3) : '0',
            datos.distribucionDias.domingo ? datos.caudalPorSegundo.toFixed(3) : '0',
    ]);
    
    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(datosExcel);
    
    // Ajustar anchos de columna (opcional)
    ws['!cols'] = [
        {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15},
        {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10},
        {wch: 10}, {wch: 10}, {wch: 15}
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, "TURNOS DE RIEGO");
    
    // Guardar archivo
    const fecha = semanaPDA.fechaInicio || new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Turno_Riego_${datos.toma}_${fecha}.xlsx`);
}
function abrirProgramacionNoAptos() {
    // Redirige a la funci√≥n correcta seg√∫n el contexto
    if (window.datosGrupoActual) {
        abrirProgramacionNoAptosGrupo();
    } else {
        abrirProgramacionNoAptosToma();
    }
}
    </script>
</body>
</html>